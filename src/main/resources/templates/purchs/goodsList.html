<html layout:decorate="~{layouts/layout}"
      lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
      

<body layout:fragment="content">
 <!-- CSS ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <link rel="stylesheet" href="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.css" />
    <link rel="stylesheet" href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css" />
    <link rel="stylesheet" href="https://uicdn.toast.com/tui.pagination/latest/tui-pagination.css" />
    <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
	<!-- JavaScript ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.js"></script>
	<script src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.js"></script>
	<script src="https://uicdn.toast.com/tui.pagination/latest/tui-pagination.js"></script>
	<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
	
    <style>
        .container { max-width: 1200px; margin: 20px auto; }
        .header-box { background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 10px; }
        .search-container { margin-bottom: 15px; }
        .pagination-container { text-align: center; margin-top: 10px; }
        .btn-search { background-color: #28a745; color: white; }
        .btn-reset { background-color: #007bff; color: white; }
        .btn-register { background-color: #28a745; color: white; margin-top: 10px; }
        
       /* âœ… ì „ì²´ ê·¸ë¦¬ë“œì˜ ìŠ¤í¬ë¡¤ ì œê±° */
		#productGrid {
		    overflow: hidden !important; /* âœ… ìŠ¤í¬ë¡¤ ì œê±° */
		    height: auto !important; /* âœ… ë†’ì´ ìë™ ì¡°ì • */
		}
		
		/* âœ… ë‚´ë¶€ ìš”ì†Œì—ì„œ ê°•ì œ ìŠ¤í¬ë¡¤ ì œê±° */
		.tui-grid-body-area {
		    overflow: hidden !important;
		}
		
		/* âœ… ì„¸ë¡œ ìŠ¤í¬ë¡¤ ì—†ì• ê¸° */
		.tui-grid-container {
		    max-height: none !important;
		}

        
    </style>
<div class="container">
    <!-- ê²€ìƒ‰ ì˜ì—­ -->
    <div class="header-box">
        <div class="row d-flex align-items-end gap-3">
            <div class="col-auto">
                <label class="form-label">ìƒí’ˆëª…</label>
                <input type="text" class="form-control" id="searchGoodsName">
            </div>
            <div class="col-auto">
                <label class="form-label">ë¸Œëœë“œ</label>
                <input type="text" class="form-control" id="searchBrandName">
            </div>
            <div class="col-auto">
                <span class="label-search col-4">í‘œì‹œìˆ˜ëŸ‰</span>
                <select id="product_display_amount" class="form-control" onchange="changeProductDisplay()">
                    <option value="10" selected>10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                  
                </select> 
            </div>
            <div class="col-auto d-flex">
                <button class="btn btn-search w-50" onclick="productSearch()">ê²€ìƒ‰</button>
                <button class="btn btn-reset w-50 ms-2" onclick="resetFilters()">ì´ˆê¸°í™”</button>
            </div>
        </div>
    </div>

    <!-- Toast Grid -->
    <div id="table-container">
        <div id="productGrid"></div>
        <div id="pagination" class="tui-pagination"></div>
    </div>

    <!-- ì œí’ˆ ë“±ë¡ ë²„íŠ¼ -->
    <div class="text-end">
        <button class="btn btn-register">ì œí’ˆ ë“±ë¡</button>
    </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", function () {
	console.log("DOMContentLoaded ì´ë²¤íŠ¸ ì‹¤í–‰ = ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰")
    initProductGrid();
});

let productGrid;

function initProductGrid() {
	
	console.log("initProductGrid()ì‹¤í–‰")

    const companyNum = [[${session.companyNum}]];
  

	if (!companyNum) {
        console.error("âŒ ì„¸ì…˜ì—ì„œ companyNum ê°’ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ.");
        return; // companyNumì´ ì—†ìœ¼ë©´ ìš”ì²­ì„ í•˜ì§€ ì•ŠìŒ
    } 
    
    //const companyNum = 1;

    console.log("âœ… ì„¤ì •ëœ companyNum:", companyNum);

    const productDataSource = {
            api: {  
                readData: { 
                    url: 'http://localhost:81/purchs/rest/product/list', 
                    method: 'GET',
                    requestOptions: { // âœ… ëª…í™•í•œ ì˜µì…˜ ì¶”ê°€
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'same-origin' // âœ… CORS ë¬¸ì œ ë°©ì§€
                    },
                    initParams:{ 
                        page: 1,
                        perPage: 10,
                        companyNum: companyNum
                    },
                    beforeRequest: function(request) {
                        console.log("ğŸ“¢ ì„œë²„ë¡œ ìš”ì²­ ë³´ë‚´ê¸° ì „ requestParams:", request.params);
                    },
                    afterResponse: function(response) {
                        console.log("ğŸ“¢ ì„œë²„ ì‘ë‹µ:", response);

                        if (response.data && response.data.contents) {
                            console.log("âœ… ë³€í™˜ëœ ë°ì´í„°:", response.data.contents);
                            return { data: response.data.contents, totalCount: response.data.pagination.totalCount };
                        }

                        console.warn("âš ï¸ ì„œë²„ ì‘ë‹µì— contentsê°€ ì—†ìŠµë‹ˆë‹¤.");
                        return { data: [], totalCount: 0 };
                    }

                }
            },
            contentType: 'application/json',
            serverSidePagination: true
        };
        
        console.log("âœ… productDataSource ì„¤ì • ì™„ë£Œ:", productDataSource);

        productGrid = new tui.Grid({
            el: document.getElementById('productGrid'),
            data: productDataSource,  
            pageOptions: {
                useClient: false,
                perPage: 5,
            },
            bodyHeight: 'auto', 
            columns: [
                { header: "ìƒí’ˆëª…", name: "goodsName", rowSpan: true },
                { header: "ìƒí’ˆì½”ë“œ", name: "goodsCode", rowSpan: true }, 
                { header: "ì˜µì…˜ëª…", name: "optionName" },
                { header: "ì˜µì…˜ë²ˆí˜¸", name: "optionCode" },
                { header: "ë¸Œëœë“œ", name: "brandName" },
                { header: "ê·œê²©", name: "goodsStandard"},
                { header: "ëŒ€í‘œì´ë¯¸ì§€", name: "goodsImage", align: "center", rowSpan: true }
            ]
        });
        
        console.log("âœ… Toast Grid ì´ˆê¸°í™” ì™„ë£Œ");

}

// í‘œì‹œ ìˆ˜ëŸ‰ ë³€ê²½
function changeProductDisplay() {
    let gap = parseInt(document.querySelector('#product_display_amount').value);
    productGrid.setPerPage(gap);
    productGrid.reloadData();
}

// ê²€ìƒ‰ ì‹¤í–‰
function productSearch() {
    let goodsName = document.querySelector('#searchGoodsName').value;
    let brandName = document.querySelector('#searchBrandName').value;

    productGrid.setRequestParams({
        "companyNum": [[${session.companyNum}]],
        "goodsName": goodsName,
        "brandName": brandName
    });

    productGrid.reloadData();
}

// í•„í„° ì´ˆê¸°í™”
function resetFilters() {
    document.querySelector('#searchGoodsName').value = '';
    document.querySelector('#searchBrandName').value = '';
    document.querySelector('#product_display_amount').value = '10';

    productGrid.setRequestParams({
        "companyNum": companyNum,
        "goodsName": '',
        "brandName": ''
    });

    productGrid.reloadData();
}
</script>

</body>



