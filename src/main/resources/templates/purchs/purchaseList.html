<html layout:decorate="~{layouts/layout}"
      lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
 
 <head>
 	<style>
    /* âœ… ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    #custom-container {
        background-color: #f8f9fa; /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* ë°•ìŠ¤ ê·¸ë¦¼ì */
        margin-bottom: 20px;
    }
    
    /* âœ… ê²€ìƒ‰ ë°” ìŠ¤íƒ€ì¼ */
    .search-container { margin-bottom: 15px; }
    .btn-search { background-color: #28a745; color: white; }
    .btn-reset { background-color: #007bff; color: white; }
    
    /* âœ… í…Œì´ë¸” & ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ */
    .tui-grid-container {
        border: 1px solid #ddd !important;
        border-radius: 5px;
        overflow: hidden;
    }

    .tui-grid-header-cell {
        background-color: #f1f1f1 !important;
        font-weight: bold;
        text-align: center;
        border-right: 1px solid #ddd !important;
    }

    .tui-grid-cell {
        border-right: 1px solid #ddd !important;
        border-bottom: 1px solid #ddd !important;
    }

    .tui-grid-cell:hover {
        background-color: #f9f9f9 !important;
    }

    /* âœ… í˜ì´ì§€ë„¤ì´ì…˜ ìŠ¤íƒ€ì¼ */
    .pagination-container {
        text-align: center;
        margin-top: 15px;
    }
</style>
 	
 </head>     
<body layout:fragment="content">


<div class="container mt-4">
    <h2 class="mb-4">ë°œì£¼ì„œ ì¡°íšŒ</h2>
    
    <!-- âœ… ê²€ìƒ‰ í•„í„° -->
    <div class="search-grid" id="custom-container">
        <div class="d-flex flex-wrap align-items-center gap-3">
            <div class="d-flex align-items-center">
                <span class="label-search me-2">ìƒí’ˆëª…</span>
                <input type="text" id="searchGoodsName" class="form-control w-auto">
            </div>
            <div class="d-flex align-items-center">
                <span class="label-search me-2">ë°œì£¼ë²ˆí˜¸</span>
                <input type="text" id="searchPurchaseNum" class="form-control w-auto">
            </div>
            <div class="d-flex align-items-center">
                <span class="label-search me-2">ë°œì£¼ì¼ì</span>
                <input type="date" id="searchStartDate" class="form-control w-auto">
                <span class="mx-2">~</span>
                <input type="date" id="searchEndDate" class="form-control w-auto">
            </div>
            <div class="d-flex align-items-center">
	            <span class="label-search me-2">í‘œì‹œìˆ˜ëŸ‰</span>
	            <select name="display_amount" id="purchase_display_amount" class="form-control w-auto" onchange="changeProductDisplay()">
	                <option value="10" selected>10</option>
	                <option value="20">20</option>
	                <option value="50">50</option>
	                <option value="100">100</option>
	            </select>
	        </div>
            <button type="button" class="btn btn-primary ms-auto" onclick="purchaseSearch()">ê²€ìƒ‰</button>
            <button type="button" class="btn btn-secondary" onclick="resetFilters()">ì´ˆê¸°í™”</button>
        </div>
    </div>
    
    <!-- âœ… ë°œì£¼ì„œ ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” -->
    <div id="table-container" class="mt-3">
        <div id="purchaselistGrid"></div>
        <div id="pagination" class="tui-pagination"></div>
    </div>
    
    <!-- ë°œì£¼ì„œ ë“±ë¡ ë²„íŠ¼ -->
    <div class="text-end">
        <button class="btn btn-register">ë°œì£¼ì„œ ë“±ë¡</button>
    </div>
</div>




<script>
document.addEventListener("DOMContentLoaded", function () {
    console.log("âœ… ë°œì£¼ì„œ ê·¸ë¦¬ë“œ ì´ˆê¸°í™”");
    initPurchaseGrid();
});

let purchaselistGrid;

function initPurchaseGrid() {
    
	const companyNum = [[${session.companyNum}]];
	
    if (!companyNum) {
        console.error("âŒ ì„¸ì…˜ì—ì„œ companyNum ê°’ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ.");
        return; // companyNumì´ ì—†ìœ¼ë©´ ìš”ì²­ì„ í•˜ì§€ ì•ŠìŒ
    } 
    const purchaselistDataSource = {
        api: {
            readData: {
                url: 'http://localhost:81/purchs/rest/purchase/list',
                method: 'GET',
                requestOptions: {
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin' // âœ… CORS ë¬¸ì œ ë°©ì§€
                },
                initParams: {
                    page: 1,
                    perPage: 10,
                    companyNum: companyNum
                },
                beforeRequest: function(request) {
                    console.log("ğŸ“¢ ì„œë²„ë¡œ ìš”ì²­ ë³´ë‚´ê¸° ì „ requestParams:", request.params);
                },
                afterResponse: function(response) {
                    console.log("ğŸ“¢ ì„œë²„ ì‘ë‹µ:", response);

                    if (response.data && response.data.contents) {
                        console.log("âœ… ë³€í™˜ëœ ë°ì´í„°:", response.data.contents);
                        return { data: response.data.contents, totalCount: response.data.pagination.totalCount };
                    }

                    console.warn("âš ï¸ ì„œë²„ ì‘ë‹µì— contentsê°€ ì—†ìŠµë‹ˆë‹¤.");
                    return { data: [], totalCount: 0 };
                }
            }
        },
        contentType: 'application/json',
        serverSidePagination: true
    };

    purchaselistGrid = new tui.Grid({
        el: document.getElementById('purchaselistGrid'),
        data: purchaselistDataSource,
        pageOptions: {
            useClient: false,
            perPage: 10
        },
        bodyHeight: 'auto',
        columns: [
            { header: "ë°œì£¼ë²ˆí˜¸", name: "purchaseNum", rowSpan: true, renderer: { type: CustomTextRenderer } },
            { header: "ê±°ë˜ì²˜ëª…", name: "vendorName" },
            { header: "ë‹´ë‹¹ì", name: "employeeName" },
            { header: "ìƒí’ˆëª…", name: "goodsName" },
            { header: "ì˜µì…˜ëª…", name: "optionName" },
            { header: "ê¸ˆì•¡", name: "purchaseTotalAmount" },
            { header: "ë°œì£¼ìƒíƒœ", name: "purchaseStatus" },
            { header: "ì¸ì‡„", name: "print", renderer: { type: PrintRenderer } }
        ]
    });

    console.log("âœ… Toast Grid ì´ˆê¸°í™” ì™„ë£Œ");
}

// âœ… ê²€ìƒ‰ ì‹¤í–‰
function purchaseSearch() {
    let goodsName = document.querySelector('#searchGoodsName').value.trim();
    let purchaseNum = document.querySelector('#searchPurchaseNum').value.trim();
    let startDate = document.querySelector('#searchStartDate').value;
    let endDate = document.querySelector('#searchEndDate').value;

    purchaselistGrid.setRequestParams({
        "companyNum": [[${session.companyNum}]],
        "goodsName": goodsName,
        "purchaseNum": purchaseNum,
        "startDate": startDate,
        "endDate": endDate
    });

    purchaselistGrid.reloadData();
}

//í‘œì‹œ ìˆ˜ëŸ‰ ë³€ê²½
function changeProductDisplay() {
    let gap = parseInt(document.querySelector('#purchase_display_amount').value);
    purchaselistGrid.setPerPage(gap);
    purchaselistGrid.reloadData();
}

// âœ… í•„í„° ì´ˆê¸°í™”
function resetFilters() {
    document.querySelector('#searchGoodsName').value = '';
    document.querySelector('#searchPurchaseNum').value = '';
    document.querySelector('#searchStartDate').value = '';
    document.querySelector('#searchEndDate').value = '';
    document.querySelector('#purchase_display_amount').value='';

    purchaselistGrid.setRequestParams({
        "companyNum": companyNum,
        "goodsName": '',
        "purchaseNum": '',
        "startDate": '',
        "endDate": ''
    });

    purchaselistGrid.reloadData();
}

// âœ… í…ìŠ¤íŠ¸ ì •ë ¬ & ê°•ì¡° ë Œë”ëŸ¬
class CustomTextRenderer {
    constructor(props) {
        const el = document.createElement('div');
        el.innerText = props.value;
        el.style.padding = '10px';
        el.style.fontWeight = 'bold';
        el.style.textAlign = 'left';
        this.el = el;
    }
    getElement() {
        return this.el;
    }
}

// âœ… ì¸ì‡„ ë²„íŠ¼ ë Œë”ëŸ¬
class PrintRenderer {
    constructor(props) {
        const el = document.createElement('a');
        el.innerText = "ì¸ì‡„";
        el.href = `/purchase/print/${props.value}`;
        el.style.color = "#007bff";
        el.style.cursor = "pointer";
        el.style.textDecoration = "underline";
        this.el = el;
    }
    getElement() {
        return this.el;
    }
}
</script>

</body>

