<html layout:decorate="~{layouts/layout}"
      lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
 
 <head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
<script>
  // PDF.js ì›Œì»¤ ê²½ë¡œ ì„¤ì •
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js';
</script>



 	<style>
    /* âœ… ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    #custom-container {
        background-color: #f8f9fa; /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* ë°•ìŠ¤ ê·¸ë¦¼ì */
        margin-bottom: 20px;
    }
    
    /* âœ… ê²€ìƒ‰ ë°” ìŠ¤íƒ€ì¼ */
    .search-container { margin-bottom: 15px; }
    .btn-search { background-color: #28a745; color: white; }
    .btn-reset { background-color: #007bff; color: white; }
    
    /* âœ… í…Œì´ë¸” & ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ */
    .tui-grid-container {
        border: 1px solid #ddd !important;
        border-radius: 5px;
        overflow: hidden;
    }

    .tui-grid-header-cell {
        background-color: #f1f1f1 !important;
        font-weight: bold;
        text-align: center;
        border-right: 1px solid #ddd !important;
    }

    .tui-grid-cell {
        border-right: 1px solid #ddd !important;
        border-bottom: 1px solid #ddd !important;
    }

    .tui-grid-cell:hover {
        background-color: #f9f9f9 !important;
    }

    /* âœ… í˜ì´ì§€ë„¤ì´ì…˜ ìŠ¤íƒ€ì¼ */
    .pagination-container {
        text-align: center;
        margin-top: 15px;
    }
    
	    .pdf-container {
	  max-width: 800px;       /* ìµœëŒ€ ë„ˆë¹„ 800px */
	  margin: 0 auto;         /* ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬ */
	  display: flex;
	  justify-content: center;/* ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ (ë‚´ë¶€ ì½˜í…ì¸  ì¤‘ì•™ ë°°ì¹˜) */
	  align-items: center;    /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
	  height: 1000px;          /* ì›í•˜ëŠ” ë†’ì´ (ì˜ˆ: 600px) */
	  border: 1px solid #ccc; /* í•„ìš” ì‹œ í…Œë‘ë¦¬ ì¶”ê°€ */
	  background-color: #f9f9f9;
	}
	
	#pdfCanvas {
	  width: 100%;            /* ì»¨í…Œì´ë„ˆ ë„ˆë¹„ì— ë§ì¶¤ */
	  height: auto;           /* ë¹„ìœ¨ ìœ ì§€ */
	  max-height: 100%;       /* ì»¨í…Œì´ë„ˆ ë†’ì´ ë‚´ì—ì„œ ì œí•œ */
	}
    
    
   
</style>
 	
 </head>     
<body layout:fragment="content">


<div class="container mt-4">
    <h2 class="mb-4">ë°œì£¼ì„œ ì¡°íšŒ</h2>
    
    <!-- âœ… ê²€ìƒ‰ í•„í„° -->
    <div class="search-grid" id="custom-container">
        <div class="d-flex flex-wrap align-items-center gap-3">
            <div class="d-flex align-items-center">
                <span class="label-search me-2">ìƒí’ˆëª…</span>
                <input type="text" id="searchGoodsName" class="form-control w-auto">
            </div>
            <div class="d-flex align-items-center">
                <span class="label-search me-2">ë°œì£¼ë²ˆí˜¸</span>
                <input type="text" id="searchPurchaseNum" class="form-control w-auto">
            </div>
            <div class="d-flex align-items-center">
                <span class="label-search me-2">ë°œì£¼ì¼ì</span>
                <input type="date" id="searchStartDate" class="form-control w-auto">
                <span class="mx-2">~</span>
                <input type="date" id="searchEndDate" class="form-control w-auto">
            </div>
            <div class="d-flex align-items-center">
	            <span class="label-search me-2">í‘œì‹œìˆ˜ëŸ‰</span>
	            <select name="display_amount" id="purchase_display_amount" class="form-control w-auto" onchange="changeProductDisplay()">
	                <option value="10" selected>10</option>
	                <option value="20">20</option>
	                <option value="50">50</option>
	                <option value="100">100</option>
	            </select>
	        </div>
            <button type="button" class="btn btn-primary ms-auto" onclick="purchaseSearch()">ê²€ìƒ‰</button>
            <button type="button" class="btn btn-secondary" onclick="resetFilters()">ì´ˆê¸°í™”</button>
        </div>
    </div>
    
    <!-- âœ… ë°œì£¼ì„œ ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” -->
    <div id="table-container" class="mt-3">
        <div id="purchaselistGrid"></div>
        <div id="pagination" class="tui-pagination"></div>
    </div>
    
    <!--  ì°½ê³  ëª¨ë‹¬ -->
		    <div th:include="purchs/ModalTemplate :: ModalTemplate (
		    'printModal', 
		    'modal-xl', 
		    'ë°œì£¼ì„œ ì¡°íšŒ', 
		    'purchs/purchaseForm', 
		    'purchs/purchaseFooter'
		    )"></div>
    
    <!-- ë°œì£¼ì„œ ë“±ë¡ ë²„íŠ¼ -->
    <div class="text-end">
        <button class="btn btn-register">ë°œì£¼ì„œ ë“±ë¡</button>
    </div>
</div>




<script>
// (1) PDF.jsë¡œ PDF íŒŒì¼ì„ ìº”ë²„ìŠ¤ì— ë Œë”ë§
	function renderPDF(reportUrl) {
	  const canvas = document.getElementById('pdfCanvas');
	  const context = canvas.getContext('2d');
	
	  // PDF ë¡œë“œ
	  pdfjsLib.getDocument(reportUrl).promise.then(pdf => {
	    console.log('PDF loaded, total pages:', pdf.numPages);
	    // ì²« í˜ì´ì§€ë§Œ ë Œë”ë§ (í•„ìš”ì‹œ ì—¬ëŸ¬ í˜ì´ì§€ ì§€ì› ê°€ëŠ¥)
	    pdf.getPage(1).then(page => {
	      const scale = 1.5; // í™•ëŒ€/ì¶•ì†Œ ë¹„ìœ¨
	      const viewport = page.getViewport({ scale });
	      // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
	      canvas.width = viewport.width;
	      canvas.height = viewport.height;
	
	      // í˜ì´ì§€ ë Œë”ë§
	      const renderContext = {
	        canvasContext: context,
	        viewport: viewport
	      };
	      page.render(renderContext).promise.then(() => {
	        console.log('Page rendered');
	      });
	    });
	  }).catch(error => {
	    console.error('PDF ë¡œë“œ ì˜¤ë¥˜:', error);
	  });
	}
  // 2. ì»¤ìŠ¤í…€ ë Œë”ëŸ¬ í´ë˜ìŠ¤ ì •ì˜ (ìµœìƒë‹¨)
  class CustomTextRenderer {
      constructor(props) {
          const el = document.createElement('div');
          el.innerText = props.value;
          el.style.padding = '10px';
          el.style.fontWeight = 'bold';
          el.style.textAlign = 'left';
          this.el = el;
      }
      getElement() {
          return this.el;
      }
  }

  // (3) PrintRenderer ìˆ˜ì • â†’ PDF.js ë Œë”ë§
  class PrintRenderer {
      constructor(props = {}) {
          this.props = props; // ì „ë‹¬ë°›ì€ props ì €ì¥
          const el = document.createElement('a');
          el.innerText = "ì¸ì‡„";
          el.style.color = "#007bff";
          el.style.cursor = "pointer";
          el.style.textDecoration = "underline";
          el.addEventListener("click", (e) => {
              e.preventDefault();
              // í˜„ì¬ í–‰ì˜ ë°ì´í„°
              const rowData = this.props.grid.getRow(this.props.rowKey);
              const purchaseNum = rowData ? rowData.purchaseNum : null;

              if (purchaseNum) {
                  sessionStorage.setItem("purchaseNum", purchaseNum);
                  console.log("sessionStorage ì €ì¥ ì™„ë£Œ:", purchaseNum);
              } else {
                  console.warn("ë°œì£¼ë²ˆí˜¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
              }

              // Thymeleafì—ì„œ ë Œë”ë§ëœ íšŒì‚¬ë²ˆí˜¸
              const companyNum = [[${session.companyNum}]];

              // (1) PDF ìƒì„± ì—”ë“œí¬ì¸íŠ¸ (Jasper â†’ PDF)
              //     ì˜ˆ: '/purchs/report/report?companynum=...&purchasenum=...'
              //     (HTMLì´ ì•„ë‹ˆë¼ PDF ë°”ì´ë„ˆë¦¬ë¥¼ ë°˜í™˜í•´ì•¼ í•¨)
              const reportUrl = `/purchs/report/report?companynum=${companyNum}&purchasenum=${purchaseNum}`;
              console.log("PDF URL:", reportUrl);

              // (2) PDF.jsë¡œ ìº”ë²„ìŠ¤ ë Œë”ë§
              renderPDF(reportUrl);

              // (3) ëª¨ë‹¬ í‘œì‹œ
              const printModalEl = document.getElementById('printModal');
              if (printModalEl) {
                  const printModal = new bootstrap.Modal(printModalEl);
                  printModal.show();
              } else {
                  console.error("ëª¨ë‹¬ ìš”ì†Œ(printModal)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
              }
          });
          this.el = el;
      }
      getElement() {
          return this.el;
      }
  }
  //pdfë‹¤ìš´
  document.getElementById('pdfDown').addEventListener('click', function() {
	  // Thymeleafë¡œ ë Œë”ë§ëœ íšŒì‚¬ë²ˆí˜¸ (ì˜ˆ: 1)
	  const companyNum = [[${session.companyNum}]];
	  // ê·¸ë¦¬ë“œë‚˜ PrintRendererë¥¼ í†µí•´ sessionStorageì— ì €ì¥ëœ ë°œì£¼ë²ˆí˜¸ ì‚¬ìš©
	  const purchaseNum = sessionStorage.getItem("purchaseNum");
	  if (!purchaseNum) {
	    alert("ë°œì£¼ë²ˆí˜¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
	    return;
	  }
	  // ë‹¤ìš´ë¡œë“œ ì—”ë“œí¬ì¸íŠ¸ URL êµ¬ì„± (/purchs/report/reportDownload ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©)
	  const downloadUrl = `/purchs/report/reportDownload?companynum=${companyNum}&purchasenum=${purchaseNum}`;
	  console.log("Download URL:", downloadUrl);
	  // ë¸Œë¼ìš°ì €ë¥¼ í•´ë‹¹ URLë¡œ ì´ë™ì‹œì¼œ íŒŒì¼ ë‹¤ìš´ë¡œë“œë¥¼ ìœ ë„
	  window.location.href = downloadUrl;
	});

  
  
  // 2. í˜ì´ì§€ ë¡œë“œ í›„ ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
  document.addEventListener("DOMContentLoaded", function () {
      console.log("âœ… ë°œì£¼ì„œ ê·¸ë¦¬ë“œ ì´ˆê¸°í™”");
      initPurchaseGrid();
  });

  let purchaselistGrid;

  function initPurchaseGrid() {
      const companyNum = [[${session.companyNum}]];
      if (!companyNum) {
          console.error("âŒ ì„¸ì…˜ì—ì„œ companyNum ê°’ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ.");
          return;
      }
      const purchaselistDataSource = {
          api: {
              readData: {
                  url: 'http://localhost:81/purchs/rest/purchase/list',
                  method: 'GET',
                  requestOptions: {
                      headers: { 'Content-Type': 'application/json' },
                      credentials: 'same-origin'
                  },
                  initParams: {
                      page: 1,
                      perPage: 10,
                      companyNum: companyNum
                  },
                  beforeRequest: function(request) {
                      console.log("ğŸ“¢ ì„œë²„ë¡œ ìš”ì²­ ë³´ë‚´ê¸° ì „ requestParams:", request.params);
                  },
                  afterResponse: function(response) {
                      console.log("ğŸ“¢ ì„œë²„ ì‘ë‹µ:", response);
                      if (response.data && response.data.contents) {
                          console.log("âœ… ë³€í™˜ëœ ë°ì´í„°:", response.data.contents);
                          return { data: response.data.contents, totalCount: response.data.pagination.totalCount };
                      }
                      console.warn("âš ï¸ ì„œë²„ ì‘ë‹µì— contentsê°€ ì—†ìŠµë‹ˆë‹¤.");
                      return { data: [], totalCount: 0 };
                  }
              }
          },
          contentType: 'application/json',
          serverSidePagination: true
      };

      purchaselistGrid = new tui.Grid({
          el: document.getElementById('purchaselistGrid'),
          data: purchaselistDataSource,
          pageOptions: {
              useClient: false,
              perPage: 10
          },
          bodyHeight: 'auto',
          columns: [
              { header: "ë°œì£¼ë²ˆí˜¸", name: "purchaseNum", rowSpan: true, renderer: { type: CustomTextRenderer } },
              { header: "ê±°ë˜ì²˜ëª…", name: "vendorName" },
              { header: "ë‹´ë‹¹ì", name: "employeeName" },
              { header: "ìƒí’ˆëª…", name: "goodsName" },
              { header: "ì˜µì…˜ëª…", name: "optionName" },
              { header: "ê¸ˆì•¡", name: "purchaseTotalAmount" },
              { header: "ë°œì£¼ìƒíƒœ", name: "purchaseStatus" },
              { header: "ì¸ì‡„", name: "print", renderer: { type: PrintRenderer } }
          ]
      });

      console.log("âœ… Toast Grid ì´ˆê¸°í™” ì™„ë£Œ");
  }

  // 3. ê¸°íƒ€ í•¨ìˆ˜ë“¤ (ê²€ìƒ‰, í•„í„° ì´ˆê¸°í™”, í‘œì‹œ ìˆ˜ëŸ‰ ë³€ê²½ ë“±)
  function purchaseSearch() {
      let goodsName = document.querySelector('#searchGoodsName').value.trim();
      let purchaseNum = document.querySelector('#searchPurchaseNum').value.trim();
      let startDate = document.querySelector('#searchStartDate').value;
      let endDate = document.querySelector('#searchEndDate').value;
      purchaselistGrid.setRequestParams({
          "companyNum": [[${session.companyNum}]],
          "goodsName": goodsName,
          "purchaseNum": purchaseNum,
          "startDate": startDate,
          "endDate": endDate
      });
      purchaselistGrid.reloadData();
  }

  function changeProductDisplay() {
      let gap = parseInt(document.querySelector('#purchase_display_amount').value);
      purchaselistGrid.setPerPage(gap);
      purchaselistGrid.reloadData();
  }

  function resetFilters() {
      document.querySelector('#searchGoodsName').value = '';
      document.querySelector('#searchPurchaseNum').value = '';
      document.querySelector('#searchStartDate').value = '';
      document.querySelector('#searchEndDate').value = '';
      document.querySelector('#purchase_display_amount').value = '';
      purchaselistGrid.setRequestParams({
          "companyNum": companyNum,
          "goodsName": '',
          "purchaseNum": '',
          "startDate": '',
          "endDate": ''
      });
      purchaselistGrid.reloadData();
  }
  const modalElement = document.getElementById("printModal");
  const closeButton = modalElement.querySelector('[data-bs-dismiss="modal"]');
  if (closeButton) {
      closeButton.addEventListener("click", function () {
          console.log("âœ… ì°½ê³  ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ í´ë¦­ë¨!");

          try {
          	let modalInstance = bootstrap.Modal.getInstance("#printModal") || new bootstrap.Modal("#warehouseModal");
              modalInstance.hide(); // âœ… Bootstrap ë°©ì‹ìœ¼ë¡œ ëª¨ë‹¬ ë‹«ê¸°
              
          } catch (error) {
              console.warn("âŒ Bootstrap 5ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŒ. ëŒ€ì²´ ë°©ì‹ ì‚¬ìš©");
              modalElement.classList.remove("show");
              modalElement.style.display = "none";
              document.body.classList.remove("modal-open");

              setTimeout(() => {
                  document.querySelectorAll(".modal-backdrop").forEach((element) => element.remove()); // ë°±ê·¸ë¼ìš´ë“œ ì œê±°
              }, 300);
           
          }
      });
  } else {
      console.warn("âŒ ì°½ê³  ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  } 
</script>

</body>

