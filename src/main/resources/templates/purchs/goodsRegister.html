<!DOCTYPE html>
<html layout:decorate="~{layouts/layout}"
      lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <title>ìƒí’ˆ ë“±ë¡</title>
  
 
    
    <!-- toast grid -->
    <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
    <script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

<style>
	#custom-container{
		background-color: #f8f9fa; /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
		padding: 20px;
		border-radius: 10px;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* ë°•ìŠ¤ ê·¸ë¦¼ì */
		margin-bottom: 20px;
	
	}
	/* ì˜µì…˜ ì¶”ê°€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn-custom {
	    width: auto; /* ë²„íŠ¼ í¬ê¸°ë¥¼ ìë™ ì¡°ì • */
	    min-width: 120px; /* ìµœì†Œ ë„ˆë¹„ ì„¤ì • */
	    padding: 10px 20px; /* íŒ¨ë”© ì¡°ì • */
	}



    
</style>
</head>
<body layout:fragment="content">
<div class="container mt-4" >
	<h2 class="mb-4">ìƒí’ˆ ë“±ë¡</h2>
	
   
    	<!-- <input type="hidden" id="csrfToken" name="_csrf" th:value="${_csrf.token}"> -->
    	<div id="custom-container">
	    	<div class="row mb-3">
	            <div class="col-md-6">
	                <label class="form-label">ìƒí’ˆëª…</label>
	                <input type="text" class="form-control" name="goodsName" id="goodsName" th:value="${ProductDTO.goodsName}">
	            </div>
	            <div class="col-md-6">
	                <label class="form-label">ìƒí’ˆë²ˆí˜¸</label>
	                <input type="text" class="form-control" name="goodsCode"  id="goodsCode" th:value="${ProductDTO.goodsCode}" readonly>
	            </div>
	        </div>
	
	        <div class="row mb-3">
	            <div class="col-md-6">
	                <label class="form-label">ìƒí’ˆë¶„ë¥˜</label>
	                <select class="form-select" name="classificationId" id="classificationId">
	                    <option value="" selected>ì„ íƒ</option>
	                </select>
                </div>
	            <div class="col-md-6">
	                <label class="form-label">ë¸Œëœë“œ</label>
	                <div class="input-group">
	                    <input type="text" class="form-control" name="brandName" id="brandName" th:value="${ProductDTO.brandName}" data-bs-toggle="modal" data-bs-target="#brandModal" readonly></input>
	        			<input type="hidden" id="brandId" name="brandId"  value="${ProductDTO.brandId}">
	                	<!-- ê³µí†µ ëª¨ë‹¬ í˜¸ì¶œ -->
						
						<!-- ë¸Œëœë“œ ëª¨ë‹¬ -->
						
						    <div th:include="purchs/modal/ModalTemplate :: ModalTemplate (
						    	'brandModal', 
						    	'modal-xl', 
						    	'ë¸Œëœë“œ ì¡°íšŒ', 
						    	'purchs/modal/brandTable', 
						    	'purchs/modal/brandFooter'
						    )"></div>
						

	                </div>
	            </div>
	        </div>
	
	        <div class="row mb-3">
	            <div class="col-md-6">
	                <label class="form-label">ê³µê¸‰ì²˜</label>
	                <div class="input-group">
	                    <input type="text" class="form-control" name="vendorName" id="vendorName" th:value="${ProductDTO.vendorName}" data-bs-toggle="modal" data-bs-target="#vendorModal"  readonly>
	                	<input type="hidden" id="vendorId" name="vendorId"  value="${ProductDTO.vendorId}">
	                	<input type="hidden" id="marginRate" name="marginRate"  value="${ProductDTO.marginRate}">
	                	<!-- ê±°ë˜ì²˜ ëª¨ë‹¬ -->
						    <div th:include="purchs/modal/ModalTemplate :: ModalTemplate (
						    'vendorModal', 
						    'modal-xl', 
						    'ê±°ë˜ì²˜ ì¡°íšŒ', 
						    'purchs/modal/vendorTable', 
						    'purchs/modal/brandFooter'
						    )"></div>
						
	                </div>
	            </div>
	            <div class="col-md-6">
	                <label class="form-label">ì›ê°€</label>
	                <input type="text" class="form-control" name="goodsCost" id="goodsCost" th:value="${ProductDTO.goodsCost}">
	            </div>
	        </div>
	
	        <div class="row mb-3">
	            <div class="col-md-6">
	                <label class="form-label">íŒë§¤ê°€</label>
	                <input type="text" class="form-control" name="goodsPrice" id="goodsPrice" th:value="${ProductDTO.goodsPrice}">
	            </div>
	            <div class="col-md-6">
	                <label class="form-label">ê³µê¸‰ê°€ì•¡</label>
	                <input type="text" class="form-control" name="goodsSupplyPrice" id="goodsSupplyPrice" th:value="${ProductDTO.goodsSupplyPrice}">
	            </div>
	        </div>
	
	        <div class="row mb-3">
	            <div class="col-md-6">
	                <label class="form-label">ê·œê²©</label>
	                <input type="text" class="form-control" name="goodsStandard" id="goodsStandard" th:value="${ProductDTO.goodsStandard}">
	            </div>
	            <div class="col-md-6">
	                <label class="form-label">ë‹´ë‹¹ì</label>
	                <input type="text" class="form-control" name="emloyeeName"  id="emloyeeName" th:value="${session.employeeName}" readonly>
	                <input type="hidden" class="form-control" name="employeeNum"  id="employeeNum" th:value="${session.employeeNum}" readonly>
	            	<input type="hidden" class="form-control" name="companyNum"  id="companyNum" th:value="${session.companyNum}" readonly>
	            </div>
	        </div>
	        
	      
			<form action="#" method="post" enctype="multipart/form-data"> 
		        <div class="row mb-3">
		            <div class="col-md-6">
		                <label class="form-label">ëŒ€í‘œ ì´ë¯¸ì§€</label>
		                  <div class="input-group">
							    <input type="file" class="form-control" id="goodsImage" name="file" accept=".jpg, .jpeg, .png, .pdf" style="width: 400px;">
							    <button class="btn btn-outline-secondary" type="button" id="uploadImageBtn">ì—…ë¡œë“œ</button>
							</div>
							
							<!-- âœ… ì—…ë¡œë“œëœ ì´ë¯¸ì§€ íŒŒì¼ëª…ì„ ì €ì¥í•  hidden input -->
							<input type="hidden" id="uploadedImageName" name="goodsImage" th:value="${ProductDTO.goodsImage}">
		            </div>
		            <div class="col-md-6">
		                <label class="form-label">ìƒí’ˆì„¤ëª…</label>
		                <div class="input-group">
		                    <textarea class="form-control" name="goodsDescription" id="goodsDescription" rows="2" th:text="${ProductDTO.goodsDescription}"></textarea>
		                </div>
		            </div>
		            
		        </div>
	        </form>
		
		</div>
       
        <div class="d-flex justify-content-between mb-3">
            <div>
                <input type="checkbox" id="singleRegister" name="registerType">
                <label for="singleRegister">ë‹¨ê±´ ë“±ë¡</label>
        
                <input type="checkbox" id="optionRegister" name="registerType">
                <label for="optionRegister">ì˜µì…˜ ë“±ë¡</label>
            </div>
        </div>
        <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-primary btn-custom" id="bttAdd">ì˜µì…˜ ì¶”ê°€</button>
        </div>
        <div id="myGrid" class="tui-grid-container" style="height: 200px;"></div>
        <div id="pagination" class="tui-pagination"></div>
          <!--  ì°½ê³  ëª¨ë‹¬ -->
		    <div th:include="purchs/modal/ModalTemplate :: ModalTemplate (
		    'warehouseModal', 
		    'modal-xl', 
		    'ì°½ê³  ì¡°íšŒ', 
		    'purchs/modal/warehouseTable', 
		    'purchs/modal/warehouseFooter'
		    )"></div>
        <div class=" d-flex justify-content-center mt-4">
            <button class="btn btn-primary mx-2" id="registerBtn">ë“±ë¡</button>
            <button class="btn btn-secondary mx-2">ì´ˆê¸°í™”</button>
        </div>
        
      
</div>

<script>
let grid;
const header = document.querySelector('meta[name="_csrf_header"]').content;
const token = document.querySelector('meta[name="_csrf"]').content;



 document.addEventListener("DOMContentLoaded", function(){
	 
	 const companyNum = document.getElementById("companyNum").value;  // âœ… Thymeleafì—ì„œ session ê°’ ê°€ì ¸ì˜´
     console.log("âœ… companyNum:", companyNum);

     fetch(`/purchs/rest/product/catelist?companyNum=${companyNum}`)
     .then(response => {
         if (!response.ok) {
             return response.text().then(text => {
                 throw new Error(`âŒ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (${response.status}): ${text}`);
             });
         }
         return response.json();
     })
     .then(data => {
         console.log("ğŸ“¢ ì„œë²„ ì‘ë‹µ ë°ì´í„°:", data);

         if (!Array.isArray(data)) {  
             console.error("âŒ ì„œë²„ ì‘ë‹µì´ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤. ë°ì´í„° í™•ì¸ í•„ìš”:", data);
             return;
         }

         const categorySelect = document.getElementById("classificationId");

         if (data.length === 0) {
             console.warn("âš ï¸ ì¹´í…Œê³ ë¦¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
             return;
         }

         data.forEach(category => {
             let option = document.createElement("option");
             option.value = category.classificationId;
             option.textContent = category.classificationName;
             categorySelect.appendChild(option);
         });
     })
     .catch(error => console.error("âŒ ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", error));
    	
     
   
   	    // ì›ê°€ ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ ê³µê¸‰ê°€ì•¡ ê³„ì‚°
   	    document.getElementById("goodsCost").addEventListener("input", function () {
   	        let goodsCost = parseFloat(this.value) || 0;
   	        let marginRate = parseFloat(document.getElementById("marginRate").value) || 0; // ë§ˆì§„ìœ¨ ê°€ì ¸ì˜¤ê¸°

   	        // ê³µê¸‰ê°€ì•¡ ê³„ì‚°: ì›ê°€ * (1 + ë§ˆì§„ë¥  / 100)
   	        let supplyPrice = parseInt(goodsCost * (1 + (marginRate / 100)));

   	        // ê²°ê³¼ ë°˜ì˜
   	        document.getElementById("goodsSupplyPrice").value = supplyPrice.toFixed(2); // ì†Œìˆ˜ì  2ìë¦¬ê¹Œì§€ í‘œì‹œ
   	    });

   	    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê³µê¸‰ê°€ì•¡ ìë™ ê³„ì‚° (ì´ˆê¸° ì›ê°€ê°’ì´ ìˆì„ ê²½ìš°)
   	    let initialGoodsCost = parseFloat(document.getElementById("goodsCost").value) || 0;
   	    if (initialGoodsCost) {
   	        document.getElementById("goodsCost").dispatchEvent(new Event("input"));
   	    }

   	    // ë§ˆì§„ìœ¨ ë³€ê²½ ì‹œ ê³µê¸‰ê°€ì•¡ ì¬ê³„ì‚° (ë§ˆì§„ìœ¨ë„ ë³€ê²½ ê°€ëŠ¥í•  ê²½ìš°)
   	    document.getElementById("marginRate").addEventListener("input", function () {
   	        document.getElementById("goodsCost").dispatchEvent(new Event("input"));
   	    });
   

	    
	    
    	var Grid = tui.Grid;
        //ì…ë ¥ ì°½ì˜ ê²½ìš° 
        const dataSource = [];
        
        // ì‚¬ìš©ì ì •ì˜ ë Œë”ëŸ¬ (ì‚­ì œ ë²„íŠ¼ ì¶”ê°€)
        class DeleteRenderer {
            constructor(props) {
                const el = document.createElement('button');
                el.textContent = 'ì‚­ì œ';
                el.className = 'btnDelete btn btn-danger btn-sm';
                el.addEventListener('click', () => {
                    grid.removeRow(props.rowKey); // í´ë¦­ ì‹œ í•´ë‹¹ í–‰ ì‚­ì œ
                });
                this.el = el;
            }
            getElement() {
                return this.el;
            }
        }
        
        

        	 grid = new Grid({
            el: document.getElementById('myGrid'), // ì»¨í…Œì´ë„ˆ ì—˜ë¦¬ë¨¼íŠ¸
            scrollX :false,
            scrollY : false,
            rowHeaders: ['checkbox'], 
            columns: [ 
                {header : "ì˜µì…˜ì½”ë“œ" , name:"optionCode",className: "tui-grid-cell-readonly"},
                {header : "ì˜µì…˜ëª…" , name:"optionName" , editor: "text"},
                {header : "í˜„ì¬ì¬ê³ " , name:"currentAmount",className: "tui-grid-cell-readonly"},
                {header : "ì•ˆì „ì¬ê³ " , name:"optionSafetyInvoice" , className: "tui-grid-cell-readonly"},
                {header : "ìƒí’ˆìœ„ì¹˜" , name:"warehouseName",editor: "text"},
                {header : "ì°½ê³ id" , name:"warehouseId" , hidden: true},
                {
                    header : "ì‚­ì œ"
                    ,name: "delete"
                    ,renderer: {
                    type: DeleteRenderer // ì‚­ì œë²„íŠ¼ ì •ì˜ ë Œë”ëŸ¬
                    }  
                    ,cellStyle: { textAlign: "center" }
                    ,className: "tui-grid-cell-readonly"
                }
            ],
            data: dataSource
        });
        	 
     	;

        
        
        const singleRegister = document.getElementById("singleRegister");
        const optionRegister = document.getElementById("optionRegister");
        const bttAdd = document.getElementById("bttAdd");
         // ë‹¨ê±´ ì¡°íšŒê°€ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
        function isSingleRowExists() {
            return grid.getData().some(row => row.optionName === "ë‹¨ê±´");
        }

          // ëª¨ë“  í–‰ ì‚­ì œ í•¨ìˆ˜ (removeRow ì‚¬ìš©)
        function deleteAllRows() {
            const rowKeys = grid.getData().map(row => row.rowKey); // ëª¨ë“  í–‰ì˜ rowKeyë¥¼ ì–»ìŒ
            rowKeys.forEach(key => {
                grid.removeRow(key); // ê° í–‰ì„ ì‚­ì œ
            });
        }
        

        
        //ë‹¨ê±´ë“±ë¡ì‹œ ì²´í¬ë°•ìŠ¤ ìƒíƒœ 
        singleRegister.addEventListener("change", function(){
             // ì²´í¬ ìƒíƒœ ë³€ê²½ ì‹œ ê¸°ì¡´ í–‰ ì‚­ì œ
            deleteAllRows();

            if (this.checked) {
                if (!isSingleRowExists()) {
                    grid.appendRow({ optionName: "ë‹¨ê±´" }, { at: 0 }); // ì˜µì…˜ëª… "ë‹¨ê±´" ì¶”ê°€
                }
                // ë‹¨ê±´ì´ ì¶”ê°€ë˜ë©´ bttAdd ë¹„í™œì„±í™”
                bttAdd.disabled = true;
                optionRegister.checked= false;
            }else {
                bttAdd.disabled = false; // ë‹¤ì‹œ bttAdd ë²„íŠ¼ í™œì„±í™”
            }
        });
	// ì˜µì…˜ë“±ë¡ì‹œ ì²´í¬ë°•ìŠ¤
        optionRegister.addEventListener("change", function(){
            if(this.checked){
                grid.appendRow({}, { at: 0 }); // ë¹ˆ í–‰ ì¶”ê°€
                singleRegister.checked= false;
                bttAdd.disabled = false; // bttAdd ë²„íŠ¼ í™œì„±í™”
            }else {
                bttAdd.disabled = false; // ë‹¤ì‹œ bttAdd ë²„íŠ¼ í™œì„±í™”
            }
        });
	
     // Toast Grid ì…€ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì¶”ê°€
        grid.on('click', function(ev) {
            const { rowKey, columnName } = ev;

            // "ìƒí’ˆìœ„ì¹˜" ì»¬ëŸ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
            if (columnName === "warehouseName") {
                openWarehouseModal(rowKey);
            }
        });

        // ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        // í–‰ì¶”ê°€
        bttAdd.addEventListener("click", function () {
            if (!singleRegister.checked && optionRegister.checked) {
                grid.appendRow({}, { at: 0 }); // ë¹ˆ í–‰ ì¶”ê°€
                
            }
        });
        

      //ë¸Œëœë“œ ëª¨ë‹¬ ì‘ì—… 
     // ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ ê·¸ë¦¬ë“œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
     document.getElementById('brandModal').addEventListener('shown.bs.modal', function () {
	    console.log("ğŸ“¢ ëª¨ë‹¬ì´ ì—´ë¦¼. ê·¸ë¦¬ë“œ ë¦¬í”„ë ˆì‹œ ì‹¤í–‰!");
	
	    if (typeof brandGrid !== 'undefined' && brandGrid !== null) {
	    	brandGrid.readData(); // ëª¨ë‹¬ì´ ì—´ë¦¬ë©´ ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
	        brandGrid.refreshLayout();
	        
	    } else {
	        console.warn(" brandGridê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
	    }
	});

    document.getElementById('brandModal').addEventListener('hidden.bs.modal', function () {
   	    console.log("ğŸ“¢ ëª¨ë‹¬ì´ ë‹«í˜. ì„ íƒëœ ë¸Œëœë“œë¥¼ inputì— ë°˜ì˜.");

   	    let selectedBrandName = sessionStorage.getItem("selectedBrandName");
   	    let selectedBrandId = sessionStorage.getItem("selectedBrandId");

   	    if (selectedBrandName && selectedBrandId) {
   	        let brandInput = document.getElementById("brandName");
   	        let brandIdInput = document.getElementById("brandId");

   	        if (brandInput && brandIdInput) {
   	            brandInput.value = selectedBrandName;
   	            brandIdInput.value = selectedBrandId;
   	        }

   	        console.log("ë¸Œëœë“œ ì„ íƒ ì™„ë£Œ:", selectedBrandName, selectedBrandId);
			
	   	 
   	     
   	        // âœ… ê°’ ì‚¬ìš© í›„ sessionStorageì—ì„œ ì‚­ì œ
   	        sessionStorage.removeItem("selectedBrandName");
   	        sessionStorage.removeItem("selectedBrandId");
   	    } else {
   	        console.warn("ì €ì¥ëœ ë¸Œëœë“œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
   	    }
   	});
    
    //ê±°ë˜ì²˜ ëª¨ë‹¬ ì‘ì—… 
    // ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ ê·¸ë¦¬ë“œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    document.getElementById('vendorModal').addEventListener('shown.bs.modal', function () {
	    console.log("ğŸ“¢ ëª¨ë‹¬ì´ ì—´ë¦¼. ê·¸ë¦¬ë“œ ë¦¬í”„ë ˆì‹œ ì‹¤í–‰!");
	
	    if (typeof vendorGrid !== 'undefined' && vendorGrid !== null) {
	    	vendorGrid.readData(); // ëª¨ë‹¬ì´ ì—´ë¦¬ë©´ ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
	    	vendorGrid.refreshLayout();
	    	
	    } else {
	        console.warn(" brandGridê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
	    }
	});

   document.getElementById('vendorModal').addEventListener('hidden.bs.modal', function () {
  	    console.log("ğŸ“¢ ëª¨ë‹¬ì´ ë‹«í˜. ì„ íƒëœ ë¸Œëœë“œë¥¼ inputì— ë°˜ì˜.");
  	  

  	    let selectedVendorName = sessionStorage.getItem("selectedVendorName");
  	    let selectedVendorId = sessionStorage.getItem("selectedVendorId");
  	    let selectedMarginRate = sessionStorage.getItem("selectedMarginRate");

  	    if (selectedVendorName && selectedVendorId && selectedMarginRate) {
  	        let vendorNameInput = document.getElementById("vendorName");
  	        let vendorIdInput = document.getElementById("vendorId");
  	        let MarginRateInput = document.getElementById("marginRate");

  	        if (vendorNameInput && vendorIdInput && MarginRateInput) {
  	        	vendorNameInput.value = selectedVendorName;
  	        	vendorIdInput.value = selectedVendorId;
  	        	MarginRateInput.value = selectedMarginRate;
  	        }

  	        console.log("ë¸Œëœë“œ ì„ íƒ ì™„ë£Œ:", selectedVendorName, selectedVendorId);
			
	   	 
  	     
  	        // âœ… ê°’ ì‚¬ìš© í›„ sessionStorageì—ì„œ ì‚­ì œ
  	        sessionStorage.removeItem("selectedVendorName");
  	        sessionStorage.removeItem("selectedVendorId");
  	    } else {
  	        console.warn("ì €ì¥ëœ ë¸Œëœë“œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
  	    }
  	});
 
// âœ… ì´ë¯¸ì§€ ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì‹œ imgSave() ì‹¤í–‰

  /*  async function imgSave(){
       const fileInput = document.getElementById("goodsImage");
       const file = fileInput.files[0];
       const formData = new FormData();
       formData.append("file", file);
       return fetch("/purchs/rest/product/uploadGoodsImages", {
           method: "POST",
           body: formData
       })
       .then(response => response.text())
       .then(data => {
           return data;
           console.log("ì—…ë¡œë“œ ë°ì´í„°",data)
       })
       .catch(error => {
           console.error("íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
       });
   }
    */
    //ì´ë¯¸ì§€ì „ì†¡ í•¨ìˆ˜
    async function imgSave() {
        const fileInput = document.getElementById("goodsImage");
        const file = fileInput.files[0];

        if (!file) {
            console.warn("âš ï¸ ì—…ë¡œë“œí•  íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return null;
        }

        const formData = new FormData();
        formData.append("file", file);
        
        try {
            const response = await fetch("/purchs/rest/product/uploadGoodsImages", {
                method: "POST",
                headers: {
                    'header': header,
                    'X-CSRF-Token': token
                },
                body: formData
            });

            if (!response.ok) {
                throw new Error("âŒ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: " + response.statusText);
            }

            // âœ… JSON ì‘ë‹µ ì²˜ë¦¬
            const data = await response.json();

            if (data.success) {
                console.log("âœ… ì—…ë¡œë“œëœ íŒŒì¼ëª…:", data.fileName);
                document.getElementById("uploadedImageName").value = data.fileName;
                return data.fileName; // âœ… íŒŒì¼ëª… ë°˜í™˜
            } else {
                console.warn("âŒ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:", data.message);
                return null;
            }
        } catch (error) {
            console.error("âŒ íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            return null;
        }
    }
    
 // âœ… ì´ë¯¸ì§€ ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì‹œ imgSave() ì‹¤í–‰
    document.getElementById("uploadImageBtn").addEventListener("click", async function () {
        try {
            const uploadedFileName = await imgSave(); // âœ… ì´ë¯¸ì§€ ì—…ë¡œë“œ í›„ íŒŒì¼ëª… ë°˜í™˜
            if (uploadedFileName) {
                console.log("âœ… ì´ë¯¸ì§€ íŒŒì¼ëª… ì €ì¥ë¨:", uploadedFileName);

                // âœ… ì—…ë¡œë“œëœ íŒŒì¼ëª…ì„ <input>ì— ë°˜ì˜
                //document.getElementById("uploadedImageName").value = uploadedFileName;
                //console.log("âœ… Hidden Input ê°’ ì—…ë°ì´íŠ¸ë¨: ", document.getElementById("uploadedImageName").value);
            } else {
                console.warn("âš ï¸ ì„œë²„ì—ì„œ íŒŒì¼ëª…ì„ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            }
        } catch (error) {
            console.error("âŒ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
    });


   
   


   
   // âœ… ì´ë¯¸ì§€ ì €ì¥ í•¨ìˆ˜ (íŒŒì¼ëª… ë°˜í™˜)
/* async function imgSave() {
    console.log("ğŸ“¢ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤í–‰!");
    const fileInput = document.getElementById("goodsImage");
    const file = fileInput.files[0];

    if (!file) {
        console.warn("âš ï¸ ì—…ë¡œë“œí•  íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return null;
    }

    const formData = new FormData();
    formData.append("file", file);

    try {
        const response = await fetch("/purchs/rest/product/uploadGoodsImages", {
            method: "POST",
            body: formData
        });

        if (!response.ok) {
            throw new Error("âŒ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: " + response.statusText);
        }

        // âœ… JSON ì‘ë‹µì„ ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬
        const data = await response.json();

        if (data.success) {
            console.log("âœ… ì—…ë¡œë“œëœ íŒŒì¼ëª…:", data.fileName);
            return data.fileName; // âœ… íŒŒì¼ëª… ë°˜í™˜
        } else {
            console.warn("âŒ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:", data.message);
            return null;
        }
    } catch (error) {
        console.error("âŒ íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        return null;
    }
} */

   
  

 
   
 //ì°½ê³  ëª¨ë‹¬ ì‘ì—…

function openWarehouseModal(rowKey) {
   	    sessionStorage.setItem("selectedRowKey", rowKey); // í´ë¦­í•œ í–‰(rowKey) ì €ì¥
   	    
   	 	let selectedRowKey = parseInt(sessionStorage.getItem("selectedRowKey"), 10);

   	
   	    // ëª¨ë‹¬ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
   	    const modalElement = document.getElementById('warehouseModal');
   	    if (!modalElement) {
   	        console.error("warehouseModal ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
   	        return;
   	    }
   	    

   	    // ì°½ê³  ê·¸ë¦¬ë“œê°€ ì •ì˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ í›„ ë°ì´í„° ê°±ì‹ 
   	    if (typeof warehouseGrid !== 'undefined' && warehouseGrid !== null) {
   	        console.log("ğŸ“¢ ì°½ê³  ëª¨ë‹¬: ë°ì´í„° ì´ˆê¸°í™” ë° ìƒˆë¡œê³ ì¹¨ ì‹œì‘");
   	
   	        // ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™”
   	    
   	        let Data = warehouseGrid.getData();
   	        console.log("ê·¸ë¦¬ë“œë°ì´í„°",Data)
   	        console.log(bootstrap.Version);

   	        
   			 warehouseGrid.readData();
   	        
   	        setTimeout(() => {
   		        warehouseGrid.refreshLayout();  // ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™”
   	        	
   			}, 500);
  

   	        // ë°ì´í„°ë¥¼ ë‹¤ ë¶ˆëŸ¬ì˜¨ í›„ ëª¨ë‹¬ ì—´ê¸° (onGridUpdated ì´ë²¤íŠ¸ í™œìš©)
   	         warehouseGrid.on("onGridUpdated", function () {
   	            console.log("ì°½ê³  ëª¨ë‹¬: ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ");
   	            

   	            // ë°ì´í„° ë¡œë“œ ì™„ë£Œ í›„ ëª¨ë‹¬ ì—´ê¸°
   	            const modalInstance = new bootstrap.Modal(modalElement);
   	            modalInstance.show(); // ëª¨ë‹¬ ì—´ê¸°
   	            
   	            
   	            console.log("ì°½ê³  ëª¨ë‹¬ ì—´ë¦¼:", rowKey);
   	        }); 
   	    } else {
   	        console.warn("warehouseGridê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
   	    } 
   	}
 
document.getElementById('warehouseModal').addEventListener('shown.bs.modal', function () {
	    console.log(" ì°½ê³  ëª¨ë‹¬ì´ ì—´ë ¸ìŠµë‹ˆë‹¤. ê·¸ë¦¬ë“œ ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰");

	    if (typeof warehouseGrid !== 'undefined' && warehouseGrid !== null) {
	        warehouseGrid.readData();       // ğŸš€ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
	  
	        console.log("ì°½ê³  ê·¸ë¦¬ë“œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ");
	    } else {
	        console.warn("warehouseGridê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
	    }
	}); 
	
	
  
	
		//ëª¨ë‹¬ ê²€ì€ í™”ë©´ ëª¨ë‘ ì œê±° 
	   document.querySelectorAll('[data-bs-toggle="modal"]').forEach(function (modalTrigger) {
		    modalTrigger.addEventListener("click", function () {
		        document.querySelectorAll('.modal-backdrop').forEach(function (element) {
		            element.remove(); // ì¤‘ë³µ ìƒì„± ë°©ì§€
		        });
		    });
		});
   
	    const modalElement = document.getElementById("warehouseModal");
	    const closeButton = modalElement.querySelector('[data-bs-dismiss="modal"]');
	    
	    
	    console.log()
	    if (closeButton) {
	        closeButton.addEventListener("click", function () {
	            console.log("âœ… ì°½ê³  ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ í´ë¦­ë¨!");

	            try {
	            	let modalInstance = bootstrap.Modal.getInstance("#warehouseModal") || new bootstrap.Modal("#warehouseModal");
	                modalInstance.hide(); // âœ… Bootstrap ë°©ì‹ìœ¼ë¡œ ëª¨ë‹¬ ë‹«ê¸°
	                
	            } catch (error) {
	                console.warn("âŒ Bootstrap 5ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŒ. ëŒ€ì²´ ë°©ì‹ ì‚¬ìš©");
	                modalElement.classList.remove("show");
	                modalElement.style.display = "none";
	                document.body.classList.remove("modal-open");

	                setTimeout(() => {
	                    document.querySelectorAll(".modal-backdrop").forEach((element) => element.remove()); // ë°±ê·¸ë¼ìš´ë“œ ì œê±°
	                }, 300);
	                
	                hiddenwmodal();
	            }
	        });
	    } else {
	        console.warn("âŒ ì°½ê³  ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
	    } 
	  
	

	    function hiddenwmodal() {
	        let selectedWarehouseId = sessionStorage.getItem("selectedWarehouseId");
	        let selectedWarehouseName = sessionStorage.getItem("selectedWarehouseName");
	        let selectedRowKey = parseInt(sessionStorage.getItem("selectedRowKey"), 10); // âœ… ìˆ«ìë¡œ ë³€í™˜

	        console.log("ğŸ“¢ ì €ì¥ëœ ë°ì´í„° í™•ì¸:", selectedWarehouseId, selectedWarehouseName, selectedRowKey);

	        if (selectedWarehouseId && selectedWarehouseName && !isNaN(selectedRowKey)) {
	            setTimeout(() => {
	                grid.setValue(selectedRowKey, "warehouseId", selectedWarehouseId, false);
	                grid.setValue(selectedRowKey, "warehouseName", selectedWarehouseName, false);

	                console.log(`âœ… ê·¸ë¦¬ë“œì— ê°’ ì„¤ì • ì™„ë£Œ: ${selectedRowKey} => ${selectedWarehouseName} + ${selectedWarehouseId}`);

	                let currentData = grid.getData();
	                console.log("ğŸ“¢ í˜„ì¬ ê·¸ë¦¬ë“œ ë°ì´í„°:", currentData);

	                // âœ… UI ì—…ë°ì´íŠ¸ ë³´ì¥
	                setTimeout(() => {
	                    grid.refreshLayout();
	                }, 50);

	                // âœ… sessionStorage ë°ì´í„° ì‚­ì œ
	                sessionStorage.removeItem("selectedWarehouseId");
	                sessionStorage.removeItem("selectedWarehouseName");
	                sessionStorage.removeItem("selectedRowKey");
	            }, 100);
	        } else {
	            console.warn("ğŸ“¢ ì €ì¥ëœ ìƒí’ˆ ìœ„ì¹˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
	        }
	    }


	    // âœ… ëª¨ë‹¬ í´ë¦­ ì‹œ ì¤‘ë³µ ë°±ê·¸ë¼ìš´ë“œ ì œê±°
	    document.querySelectorAll('[data-bs-toggle="modal"]').forEach(function (modalTrigger) {
	        modalTrigger.addEventListener("click", function () {
	            document.querySelectorAll('.modal-backdrop').forEach(function (element) {
	                element.remove(); // ì¤‘ë³µ ìƒì„± ë°©ì§€
	            });
	        });
	    });
	    
   //ì œí’ˆ ì •ë³´ ë“±ë¡ ê¸°ëŠ¥
   
   document.getElementById("registerBtn").addEventListener("click", productInsert);


   function productInsert(event){
   	event.preventDefault();
   	
   	//í† ìŠ¤íŠ¸ ê·¸ë¦¬ë“œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° 
   	const gridData = grid.getData();
   	console.log("ê·¸ë¦¬ë“œë°ì´í„°=",gridData);
   	
   	let gridInfo = [];
   	for (let i of gridData) {
   	    console.log("ì˜µì…˜ì´ë¦„=", i.optionName, "ì°½ê³ ì´ë¦„=", i.warehouseId);

   	    gridInfo.push({
   	        optionName: i.optionName,
   	        warehouseId: parseInt(i.warehouseId, 10)
   	    });
   	}
   	
   	console.log(gridInfo);

   	
   	//ìƒí’ˆ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° 
   	
   	  let prodInfo = {
   		    goodsName: document.querySelector('#goodsName').value, //ìœ íš¨ì„± ì²´í¬ 
   		    goodsCost: parseInt(document.querySelector('#goodsCost')?.value, 10) || 0,
   		    goodsPrice: parseInt(document.querySelector('#goodsPrice')?.value, 10) || 0,
   		    goodsSupplyPrice: parseInt(document.querySelector('#goodsSupplyPrice')?.value, 10) || 0,
   		    goodsStandard: document.querySelector('#goodsStandard').value, //ìœ íš¨ì„± ì²´í¬ 
   		    goodsDescription : document.querySelector('#goodsDescription')?.value || "",
   		    goodsImage : document.querySelector('#uploadedImageName')?.value || "",
   		    classificationId: parseInt(document.querySelector('#classificationId').value, 10),//ìœ íš¨ì„±ì²´í¬
   		    brandId: parseInt(document.querySelector('#brandId').value, 10), //ìœ íš¨ì„±ì²´í¬
   		    employeeNum: parseInt(document.querySelector('#employeeNum').value, 10), //ìœ íš¨ì„±ì²´í¬
   		    vendorId: parseInt(document.querySelector('#vendorId')?.value, 10) || 0,
   		    companyNum: parseInt(document.querySelector('#companyNum')?.value, 10) || 0,
   		    files : gridInfo
   		};  
   	
   	
   	console.log("ë°ì´í„°",prodInfo)
   	
   	fetch("http://localhost:81/purchs/rest/product/insert",{
   		method: "POST",
   		headers: {
                  "Content-Type": "application/json",
                  'X-CSRF-Token': token
              },
              body : JSON.stringify(prodInfo) // orderInfo ê°ì²´ë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ë³€í™˜(JSON.parseëŠ” JSONì„ ê°ì²´ë¡œ ë³€í™˜)
   	})
   	.then(response => response.json())
   	.then(data => {
   	    if (data.status === "success") {
   	        showAlert('ìƒí’ˆë“±ë¡ ì™„ë£Œ ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
   	        
   	        // âœ… 1ì´ˆ í›„ í˜ì´ì§€ ë¦¬ë¡œë”©
   	        setTimeout(() => {
   	            location.reload();
   	        }, 1000);
   	        
   	    } else {
   	        showAlert('ìƒí’ˆë“±ë¡ ì‹¤íŒ¨ í•˜ì˜€ìŠµë‹ˆë‹¤.', 'danger');
   	    }
   	})

   	
   	
   	
   }

      
  });

 

    
 
    
</script>
<!-- âœ… Bootstrap 5 CDN ì¶”ê°€ -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>


</html>
