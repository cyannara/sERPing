<html layout:decorate="~{layouts/layout}"
      lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<body layout:fragment="content">
    <style>
        .form-control { width: 100%; }
        
        .button-container { margin-top: 15px; }
        #custom-container{
		background-color: #f8f9fa; /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
		padding: 20px;
		border-radius: 10px;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* ë°•ìŠ¤ ê·¸ë¦¼ì */
		margin-bottom: 20px;
	
		}
       /* âœ… Toast Gridì˜ ê¸°ë³¸ ë†’ì´ë¥¼ í¬ê²Œ ì„¤ì • */
		#grid {
		    height: 700px !important; /* ì›í•˜ëŠ” í¬ê¸°ë¡œ ëŠ˜ë¦¬ê¸° */
		    min-height: 600px; /* ìµœì†Œ í¬ê¸° */
		    max-height: 900px; /* ë„ˆë¬´ ì»¤ì§€ì§€ ì•Šë„ë¡ ì„¤ì • */
		    overflow: auto; /* ìŠ¤í¬ë¡¤ ì¶”ê°€ */
		}
		
		/* âœ… Toast Gridì˜ ê°€ë¡œ ìŠ¤í¬ë¡¤ ì œê±° */
		.tui-grid-container {
		    width: 100% !important; /* ì „ì²´ ë„ˆë¹„ë¥¼ ë¶€ëª¨ ìš”ì†Œì— ë§ì¶¤ */
		    max-width: none !important;
		    overflow-x: hidden !important; /* âœ… ê°€ë¡œ ìŠ¤í¬ë¡¤ ê°•ì œ ì œê±° */
		}
		
		/* âœ… ë‚´ë¶€ ìš”ì†Œì—ì„œ ìŠ¤í¬ë¡¤ ì œê±° */
		.tui-grid-body-area {
		    overflow-x: hidden !important;
		}
		
		/* âœ… ì»¬ëŸ¼ ìë™ í¬ê¸° ì¡°ì • */
		.tui-grid-cell {
		    white-space: nowrap !important; /* âœ… ì¤„ë°”ê¿ˆ ë°©ì§€ */
		    overflow: hidden !important;
		    text-overflow: ellipsis !important; /* ê¸´ ë‚´ìš©ì€ "..." ì²˜ë¦¬ */
		}
		
		/* âœ… ë™ì¼í•œ í–‰ ê°•ì¡° íš¨ê³¼ */
		.highlight-row {
		    animation: flash 1.5s ease-in-out;
		}
		
	
		
	
    </style>
    

    
<div class="container mt-4" >
<h2 class="mb-4">ë°œì£¼ì„œ ê´€ë¦¬</h2>
<!-- <p id="companyNum" data-company-num="${session.companyNum}"></p> -->
	<div class="container">
	    <!-- ğŸ”¹ ë°œì£¼ì„œ ì •ë³´ -->
	    <div id="custom-container">
	        <div class="row g-3">
	        <!-- âœ… ê³µí†µ ë°œì£¼ ì •ë³´ -->
				<input type="hidden" id="purchaseNum" th:value="${purchase?.purchaseNum}">
				<input type="hidden" id="companyNum" th:value="${session.companyNum}">
				
	            <div class="col-md-3">
	                <label class="form-label">ì¼ì</label>
	               <input type="date" class="form-control" id="purchaseDate" th:value="${formattedPurchaseDate}" 
>
	            </div>
	            <div class="col-md-3">
	                <label class="form-label">ë‹´ë‹¹ì</label>
	                <input type="hidden" class="form-control" id="companyNum" th:value="${session.companyNum}" readonly>
	                <input type="text" class="form-control" th:value="${purchase?.employeeName}" readonly>
	                <input type="hidden" class="form-control" id="employeeNum" th:value="${session.employeeNum}" readonly>
	            </div>
	            <div class="col-md-3">
	                <label class="form-label">ë‚©ê¸°ì¼ì</label>
	                <input type="date" class="form-control" id="purchaseDueDate" th:value="${formattedPurchaseDueDate}">
	            </div>
	        </div>
	
	        <!-- ë¶€ê°€ì„¸ìœ¨(VAT) ì„ íƒ -->
			<div class="d-flex align-items-center mt-3">
			    <div class="form-check me-3">
			        <input class="form-check-input" type="checkbox" id="vatUnchecked"
			               th:checked="${purchase?.purchaseVatFlag == 0}">
			        <label class="form-check-label" for="vatUnchecked">ë¶€ê°€ì„¸ìœ¨(VAT) ë¯¸ì ìš©</label>
			    </div>
			    <div class="form-check">
			        <input class="form-check-input" type="checkbox" id="vatChecked"
			               th:checked="${purchase?.purchaseVatFlag == 1}">
			        <label class="form-check-label" for="vatChecked">ë¶€ê°€ì„¸ìœ¨(VAT) ì ìš©</label>
			    </div>
			</div>

	    </div>
	
	
	    <!-- ğŸ”¹ Toast Grid -->
	    <div id="grid" class="tui-grid-container" style="height: 200px;"></div>
	    <div id="pagination" class="tui-pagination"></div>
        <script th:inline="javascript">
		    let optionsData = /*[[${options}]]*/ [];
		    console.log("âœ… Thymeleafì—ì„œ ë°›ì€ optionsData:", optionsData);
		</script>
        
	 
	    <div class="button-container text-center mt-3">
		    <div class="d-flex justify-content-center gap-3">
		        <!-- ë°œì£¼ ìˆ˜ì • ë²„íŠ¼ -->
		        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#purchModifyConfirm"
		         th:disabled="${purchase?.purchaseStatus ne 'ì§„í–‰ì¤‘'}">ë°œì£¼ ìˆ˜ì •</button>
		
		        <!-- ë°œì£¼ ì·¨ì†Œ ë²„íŠ¼ (ë¶‰ì€ìƒ‰) -->
		        <button class="btn btn-danger" id="purchaseCancel" 
		        th:disabled="${purchase?.purchaseStatus ne 'ì§„í–‰ì¤‘'}">ë°œì£¼ ì·¨ì†Œ</button>
		
		        <!-- ì´ˆê¸°í™” ë²„íŠ¼ -->
		        <button class="btn btn-secondary">ì´ˆê¸°í™”</button>
		    </div>
		</div>
		
		<!-- âœ… ë°œì£¼ ìˆ˜ì • í™•ì¸ ëª¨ë‹¬ -->
		<div th:include="purchs/modal/ModalTemplate :: ModalTemplate (
		    'purchModifyConfirm', 
		    'modal-md', 
		    'ë°œì£¼ ìˆ˜ì • í™•ì¸', 
		    'purchs/modal/purchModifyConfirm', 
		    'purchs/modal/purchModifyFooter'
		)"></div>

	</div>
	
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
	const header = document.querySelector('meta[name="_csrf_header"]').content;
	const token = document.querySelector('meta[name="_csrf"]').content;
    const purchaseNum = document.getElementById("purchaseNum").value;
    const companyNum = document.getElementById("companyNum").value;
    
    console.log("âœ… ë°œì£¼ ìˆ˜ì • í˜ì´ì§€ ë¡œë“œë¨");
    console.log("âœ… purchaseNum:", purchaseNum, "companyNum:", companyNum);

    
    console.log("âœ… Thymeleafì—ì„œ ë°›ì€ optionsData:", optionsData);

    initPurchaseGrid(optionsData);
    
 // âœ… VAT ì²´í¬ë°•ìŠ¤ í•˜ë‚˜ë§Œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
    document.getElementById("vatChecked").addEventListener("change", function () {
        if (this.checked) {
            document.getElementById("vatUnchecked").checked = false;
        }
        updateAllVat();
    });

    document.getElementById("vatUnchecked").addEventListener("change", function () {
        if (this.checked) {
            document.getElementById("vatChecked").checked = false;
        }
        updateAllVat();
    });
});

function initPurchaseGrid(optionsData) {
    window.purchaseGrid = new tui.Grid({
        el: document.getElementById('grid'),
        scrollX: false,
        scrollY: true,
        bodyHeight: 500,
        columns: [
            { header: 'ìƒí’ˆì½”ë“œ', name: 'goodsCode', className: "tui-grid-cell-readonly" },
            { header: 'ìƒí’ˆëª…', name: 'goodsName', className: "tui-grid-cell-readonly" },
            { header: 'ì˜µì…˜ì½”ë“œ', name: 'optionCode', className: "tui-grid-cell-readonly" },
            { header: 'ì˜µì…˜ëª…', name: 'optionName', className: "tui-grid-cell-readonly" },
            { header: 'ê±°ë˜ì²˜ëª…', name: 'vendorName', className: "tui-grid-cell-readonly" },
            { header: 'ìˆ˜ëŸ‰', name: 'purchaseQuantity', editor: "text" },
            { header: 'ë‹¨ê°€', name: 'purchaseUnitPrice', editor: "text" },
            { header: 'ê³µê¸‰ê°€ê²©', name: 'purchaseSupplyPrice', className: "tui-grid-cell-readonly" },
            { header: 'ë¶€ê°€ì„¸', name: 'purchaseVat', className: "tui-grid-cell-readonly" }
        ],
        rowHeaders: ['checkbox'],
        data: optionsData  // âœ… ì„œë²„ì—ì„œ ë°›ì€ ì˜µì…˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ê·¸ë¦¬ë“œì— ì ìš©
    });
    
    // âœ… ë°œì£¼ ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    document.getElementById("purchaseCancel").addEventListener("click", async function () {
        const purchaseNum = document.getElementById("purchaseNum").value;
        const companyNum = document.getElementById("companyNum").value;

        if (!purchaseNum || !companyNum) {
            alert("âš ï¸ ë°œì£¼ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        if (!confirm("ì •ë§ë¡œ ë°œì£¼ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        try {
            const response = await fetch("/purchs/rest/purchase/cancel", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRF-TOKEN": document.querySelector('meta[name="_csrf"]').content
                },
                body: JSON.stringify({ 
                	purchaseNum: Number(purchaseNum),
                    companyNum: Number(companyNum)
                })
            });

            const result = await response.json();
            if (result.status === "success") {
                alert("âœ… ë°œì£¼ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload();
            } else {
                alert("âŒ ë°œì£¼ ì·¨ì†Œ ì‹¤íŒ¨!");
            }
        } catch (error) {
            console.error("âŒ ë°œì£¼ ì·¨ì†Œ ì˜¤ë¥˜:", error);
            alert("âš ï¸ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    });
    
    // âœ… ìˆ˜ëŸ‰, ë‹¨ê°€ ë³€ê²½ ì‹œ ê³µê¸‰ê°€ê²© ë° ë¶€ê°€ì„¸ ìë™ ê³„ì‚°
    window.purchaseGrid.on('afterChange', function (ev) {
        ev.changes.forEach(change => {
            const { rowKey, columnName, value } = change;

            if (columnName === "purchaseQuantity" || columnName === "purchaseUnitPrice") {
                updateSupplyPriceAndVat(rowKey);
            }
        });
    });

    // âœ… VAT ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ ìë™ ê³„ì‚°
    document.getElementById("vatChecked").addEventListener("change", updateAllVat);
    document.getElementById("vatUnchecked").addEventListener("change", updateAllVat);
    
    document.getElementById("purchaseModify").addEventListener("click", function() {
        // ğŸ”¹ ê³µí†µ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const purchaseNum = parseInt(document.getElementById("purchaseNum").value)||0;
        const employeeNum = parseInt(document.getElementById("employeeNum").value)||0;
        const companyNum = parseInt(document.getElementById("companyNum").value)||0;
        const purchaseDueDate = document.getElementById("purchaseDueDate").value;
        const purchaseVatFlag = document.getElementById("vatChecked").checked ? 1 : 0;
        const purchaseRecordeReason = document.getElementById("purchaseRecordeReason").value; // ìˆ˜ì • ì‚¬ìœ 

        // ğŸ”¹ Toast Gridì—ì„œ ì²´í¬ëœ í–‰(row)ë§Œ ê°€ì ¸ì˜¤ê¸°
        const checkedRows = window.purchaseGrid.getCheckedRows(); // âœ… ì²´í¬ëœ ë°ì´í„°ë§Œ ê°€ì ¸ì˜¤ê¸°
        console.log("âœ… ì²´í¬ëœ ë°ì´í„°:", checkedRows);

        if (checkedRows.length === 0) {
            alert("ìˆ˜ì •í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); 
            return;
        }

        // ğŸ”¹ ì„œë²„ë¡œ ë³´ë‚¼ ë°ì´í„° ê°ì²´ ìƒì„±
        const requestData = {
            purchaseNum: purchaseNum,
            employeeNum: employeeNum,
            companyNum: companyNum,
            purchaseDueDate: purchaseDueDate,
            purchaseVatFlag: purchaseVatFlag,
            purchaseRecordeReason: purchaseRecordeReason,
            files: checkedRows.map(row => ({
                purchaseBodyNum: parseInt(row.purchaseBodyNum)||0, 
                purchaseQuantity: parseInt(row.purchaseQuantity)||0,
                purchaseUnitPrice: parseInt(row.purchaseUnitPrice)||0,
                purchaseSupplyPrice: parseInt(row.purchaseSupplyPrice)||0,
                purchaseVat: parseInt(row.purchaseVat)||0,
                optionNum: parseInt(row.optionNum)||0,
                goodsStandard: row.goodsStandard,
                companyNum: companyNum
            }))
        };

        console.log("âœ… ì„œë²„ë¡œ ë³´ë‚¼ ë°ì´í„°:", requestData);

        // ğŸ”¹ AJAX ìš”ì²­ ë³´ë‚´ê¸°
        fetch("/purchs/rest/purchase/update", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRF-TOKEN": document.querySelector('meta[name="_csrf"]').content
            },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");
            }
            return response.json();
        })
        .then(data => {
            console.log("âœ… ë°œì£¼ ìˆ˜ì • ì™„ë£Œ:", data);
            alert("ë°œì£¼ ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.reload(); // ìˆ˜ì • í›„ ìƒˆë¡œê³ ì¹¨
        })
        .catch(error => {
            console.error("âŒ ë°œì£¼ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            alert("ë°œì£¼ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
    });


}

/**
 * âœ… ìˆ˜ëŸ‰ê³¼ ë‹¨ê°€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê³µê¸‰ê°€ì•¡(purchaseSupplyPrice) ë° ë¶€ê°€ì„¸(purchaseVat) ìë™ ê³„ì‚°
 */
function updateSupplyPriceAndVat(rowKey) {
    const grid = window.purchaseGrid;
    const rowData = grid.getRow(rowKey);

    const quantity = parseFloat(rowData.purchaseQuantity) || 0;
    const unitPrice = parseFloat(rowData.purchaseUnitPrice) || 0;

    const supplyPrice = quantity * unitPrice; // ê³µê¸‰ê°€ê²© ê³„ì‚°
    const vatRate = document.getElementById("vatChecked").checked ? 0.1 : 0; // VAT ì ìš© ì—¬ë¶€ í™•ì¸
    const vat = supplyPrice * vatRate; // ë¶€ê°€ì„¸ ê³„ì‚°

    grid.setValue(rowKey, "purchaseSupplyPrice", supplyPrice);
    grid.setValue(rowKey, "purchaseVat", vat);
}

/**
 * âœ… VAT ì²´í¬ë°•ìŠ¤ ìƒíƒœì— ë”°ë¼ ë¶€ê°€ì„¸ ìë™ ì—…ë°ì´íŠ¸
 */
function updateAllVat() {
    const grid = window.purchaseGrid;
    grid.getData().forEach((row, index) => {
        updateSupplyPriceAndVat(index);
    });
    
    
}







	







</script>


</body>

</html>