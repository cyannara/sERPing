<html layout:decorate="~{layouts/layout}"
      lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
      

<body layout:fragment="content">
 
    <style>
	    #custom-container{
			background-color: #f8f9fa; /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
			padding: 20px;
			border-radius: 10px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* ë°•ìŠ¤ ê·¸ë¦¼ì */
			margin-bottom: 20px;
		
		}
        .container { max-width: 100%; margin: 20px auto; }
        .header-box { background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 10px; }
        .search-container { margin-bottom: 15px; }
        .pagination-container { text-align: center; margin-top: 10px; }
        .btn-search { background-color: #28a745; color: white; }
        .btn-reset { background-color: #007bff; color: white; }
        .btn-register { background-color: #28a745; color: white; margin-top: 10px; }
        
       /* âœ… ì „ì²´ ê·¸ë¦¬ë“œì˜ ìŠ¤í¬ë¡¤ ì œê±° */
		#productGrid {
		    width: 100% !important;
		    min-width: 1200px;  /* ìµœì†Œ ë„ˆë¹„ ì„¤ì • */
		    height: auto !important;
		}

		
		/* âœ… ë‚´ë¶€ ìš”ì†Œì—ì„œ ê°•ì œ ìŠ¤í¬ë¡¤ ì œê±° */
		.tui-grid-body-area {
		    overflow: hidden !important;
		}
		
		/* âœ… ì„¸ë¡œ ìŠ¤í¬ë¡¤ ì—†ì• ê¸° */
		.tui-grid-container {
		    max-width: 100% !important;
		    overflow-x: auto !important;  /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ë„ë¡ ë³€ê²½ */
		}

		
		/* ìƒí’ˆëª… & ìƒí’ˆì½”ë“œ ë³‘í•©ëœ ì…€ ìŠ¤íƒ€ì¼ */
		.merged-cell {
		    background-color: #f8f9fa !important; /* ì—°í•œ íšŒìƒ‰ */
		    font-weight: bold;
		    text-align: left !important;
		    vertical-align: middle !important;  /* ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ */
		    line-height: normal !important;
		    padding: 15px !important;
		   
		}
	
		
		/* âœ… ê·¸ë¦¬ë“œ ì „ì²´ í…Œë‘ë¦¬ ì¶”ê°€ */
		.tui-grid-container {
		    border: 1px solid #ddd !important; /* ì „ì²´ ê·¸ë¦¬ë“œ ë°•ìŠ¤ í…Œë‘ë¦¬ */
		    border-radius: 5px; /* ë‘¥ê·¼ í…Œë‘ë¦¬ */
		    overflow: hidden; /* ëª¨ì„œë¦¬ ê¹”ë”í•˜ê²Œ ì •ë¦¬ */
		}
		
		/* âœ… í—¤ë”(ì»¬ëŸ¼ëª…) ë¶€ë¶„ í…Œë‘ë¦¬ */
		.tui-grid-header-area {
		    border-bottom: 2px solid #ccc !important; /* í—¤ë”ì™€ ë°”ë”” êµ¬ë¶„ */
		}
		
		/* âœ… ì…€(Cell) í…Œë‘ë¦¬ ì„¤ì • */
		.tui-grid-cell {
		    border-right: 1px solid #ddd !important;
		    border-bottom: 1px solid #ddd !important;
		}
		
		/* âœ… ë§ˆì§€ë§‰ ì»¬ëŸ¼ì˜ í…Œë‘ë¦¬ ì—†ì• ê¸° (ë””ìì¸ ê°œì„ ) */
		.tui-grid-cell:last-child {
		    border-right: none !important;
		}
		
		/* âœ… ë§ˆì§€ë§‰ í–‰ì˜ í…Œë‘ë¦¬ ì—†ì• ê¸° (ë””ìì¸ ê°œì„ ) */
		.tui-grid-body-area .tui-grid-cell:last-child {
		    border-bottom: none !important;
		}
		
		/* âœ… í—¤ë”(ì»¬ëŸ¼ëª…) ë°°ê²½ìƒ‰ & ê¸€ì”¨ ìŠ¤íƒ€ì¼ */
		.tui-grid-header-cell {
		    background-color: #f1f1f1 !important; /* í—¤ë” ë°°ê²½ìƒ‰ */
		    font-weight: bold;
		    text-align: center;
		    border-right: 1px solid #ddd !important;
		}
		
		/* âœ… ì¤„ ê°„ê²© ìŠ¤íƒ€ì¼ ì¡°ì • */
		.tui-grid-row {
		    border-bottom: 1px solid #ddd !important;
		}
		
		/* âœ… hover(ë§ˆìš°ìŠ¤ ì˜¤ë²„) ì‹œ ê°•ì¡° íš¨ê³¼ */
		.tui-grid-cell:hover {
		    background-color: #f9f9f9 !important;
	}

</style>


<div class="container mt-4">
	<h2 class="mb-4">ìƒí’ˆ ì¡°íšŒ</h2>
	   <!-- ê²€ìƒ‰ì°½ -->
	<div class="search-grid" id="custom-container">
	    <div class="d-flex flex-wrap align-items-center gap-3">
	        <div class="d-flex align-items-center">
	            <span class="label-search me-2">ìƒí’ˆëª…</span>
	            <input type="text" name="goodsName" id="searchGoodsName" class="form-control w-auto">
	        </div>
	        <div class="d-flex align-items-center">
	            <span class="label-search me-2">ë¸Œëœë“œëª…</span>
	            <input type="text" name="brandName" id="searchBrandName" class="form-control w-auto">
	        </div>
	        <div class="d-flex align-items-center">
	            <span class="label-search me-2">í‘œì‹œìˆ˜ëŸ‰</span>
	            <select name="display_amount" id="product_display_amount" class="form-control w-auto" onchange="changeProductDisplay()">
	                <option value="10" selected>10</option>
	                <option value="20">20</option>
	                <option value="50">50</option>
	                <option value="100">100</option>
	            </select>
	        </div>
	        <button type="button" class="btn btn-primary ms-auto" onclick="productSearch()">ê²€ìƒ‰</button>
	        <button type="button" class="btn btn-secondary" onclick="resetFilters()">ì´ˆê¸°í™”</button>
	    </div>
	</div>
	
	<!-- ìƒí’ˆë³„ ê·¸ë¦¬ë“œ -->
	<div id="table-container" class="mt-3">
	    <div id="productGrid"></div>
	    <div id="pagination" class="tui-pagination"></div>
	</div>
	<!-- LOT ì •ë³´ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
    <div id="lot-container" class="mt-5" style="display: none;">
        <h3 class="mb-3">ì˜µì…˜ë³„ LOT ì¡°íšŒ</h3>
        <div id="lotGrid"></div>
        <div id="lotPagination" class="tui-pagination"></div>
    </div>


</div>


<script>
document.addEventListener("DOMContentLoaded", function () {
    console.log("âœ… DOMContentLoaded ì´ë²¤íŠ¸ ì‹¤í–‰");
    initProductGrid();  // ìƒí’ˆ ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
});

// âœ… í…ìŠ¤íŠ¸ë¥¼ êµµê²Œí•˜ê³  ì •ë ¬í•˜ëŠ” ë Œë”ëŸ¬
class CustomTextRenderer {
    constructor(props) {
        const el = document.createElement('div');
        el.innerText = props.value;
        el.style.padding = '10px';
        el.style.fontWeight = 'bold';
        el.style.textAlign = 'left';
        this.el = el;
    }
    getElement() {
        return this.el;
    }
}

let productGrid;
let lotGrid;
let selectedOptionNum = null;
let selectedCompanyNum = [[${session.companyNum}]];

function initProductGrid() {
    console.log("âœ… initProductGrid() ì‹¤í–‰");

    
    if (!selectedCompanyNum) {
        console.error("âŒ ì„¸ì…˜ì—ì„œ companyNum ê°’ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ.");
        return;
    }

    console.log("âœ… ì„¤ì •ëœ companyNum:", selectedCompanyNum);

    const productDataSource = {
        api: {  
            readData: { 
                url: '/purchs/rest/goods/nums', 
                method: 'GET',
                requestOptions: {
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                },
                initParams: { 
                    page: 1,
                    perPage: 10,
                    companyNum: selectedCompanyNum
                }
            }
        },
        contentType: 'application/json',
        serverSidePagination: true
    };

    productGrid = new tui.Grid({
        el: document.getElementById('productGrid'),
        data: productDataSource, 
        scrollX :true,
        scrollY : false,
        rowHeight: 40,  // âœ… í–‰ í¬ê¸° ê³ ì • (ê¸°ë³¸ê°’: auto â†’ 40pxë¡œ ì§€ì •)
        pageOptions: {
            useClient: false,
            perPage: 5,
        },
        bodyHeight: 'auto', 
        columns: [
            { header: "ìƒí’ˆëª…", name: "goodsName", rowSpan: true, className: "merged-cell", renderer: { type: CustomTextRenderer } },
            { header: "ìƒí’ˆì½”ë“œ", name: "goodsCode", rowSpan: true, className: "merged-cell", renderer: { type: CustomTextRenderer } },
            { header: "ì˜µì…˜ëª…", name: "optionName" },
            { header: "ì˜µì…˜ë²ˆí˜¸", name: "optionCode" },
            { header: "ë¸Œëœë“œ", name: "brandName" },
            { header: "ê·œê²©", name: "goodsStandard"},
            { header: "ì…ê³ ìˆ˜ëŸ‰", name: "totalInputQuantity"},
            { header: "ì¶œê³ ìˆ˜ëŸ‰", name: "totalOutputQuantity"},
            { header: "ì´ì¬ê³ ", name: "totalQuantity"},
            { header: "ì•ˆì „ì¬ê³ ", name: "optionSafetyInvoice"},
        ]
    });

    console.log("âœ… ìƒí’ˆ ê·¸ë¦¬ë“œ ì´ˆê¸°í™” ì™„ë£Œ");

    // ì˜µì…˜ëª…ì„ í´ë¦­í•˜ë©´ LOT ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì´ë²¤íŠ¸ ì¶”ê°€
    productGrid.on("click", function(event) {
        const rowKey = event.rowKey;
        const columnName = event.columnName;
        const rowData = productGrid.getRow(rowKey);

        if (columnName === "optionName" || columnName === "optionCode") {
            selectedOptionNum = rowData.optionNum;
            

            if (selectedOptionNum && selectedCompanyNum) {
                console.log("ğŸ“¢ ì„ íƒëœ ì˜µì…˜:", selectedOptionNum, "íšŒì‚¬ë²ˆí˜¸:", selectedCompanyNum);
                loadLotData(selectedOptionNum, selectedCompanyNum);
            } else {
                console.error("âŒ ë°ì´í„°ê°€ ë¶€ì¡±í•˜ì—¬ LOT ì¡°íšŒ ì‹¤íŒ¨", rowData);
            }
        }
    });
}


//âœ… LOT ë°ì´í„° ë¹„ë™ê¸° ë¡œë“œ & ê·¸ë¦¬ë“œ ê°±ì‹ 
function fetchLotData(optionNum, companyNum) {
    console.log("ğŸ“¢ fetchLotData ì‹¤í–‰: optionNum =", optionNum, "companyNum =", companyNum);

    // âœ… optionNumì„ intë¡œ ë³€í™˜ (ìˆ«ìë¡œ ë³€í™˜ ê°€ëŠ¥í•  ê²½ìš°ë§Œ ì²˜ë¦¬)
    let parsedOptionNum = parseInt(optionNum);
    if (isNaN(parsedOptionNum)) {
        console.error("âŒ optionNumì´ ìˆ«ìê°€ ì•„ë‹™ë‹ˆë‹¤:", optionNum);
        return;
    }

    fetch(`/purchs/rest/goodslot/nums?companyNum=${companyNum}&optionNum=${parsedOptionNum}`)
        .then(response => response.json())
        .then(data => {
            console.log("âœ… LOT ë°ì´í„° ì‘ë‹µ:", data);

            // âœ… ì‘ë‹µ ë°ì´í„° ê²€ì¦ í›„ ì²˜ë¦¬
            if (data && data.contents && Array.isArray(data.contents)) {
                console.log("âœ… ì •ìƒì ì¸ LOT ë°ì´í„° í™•ì¸ë¨, ê·¸ë¦¬ë“œ ê°±ì‹  ì‹œì‘");

                // âœ… LOT ê·¸ë¦¬ë“œê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ë¨¼ì € ì´ˆê¸°í™”
                if (!lotGrid) {
                    console.log("ğŸ”¹ LOT ê·¸ë¦¬ë“œê°€ ì—†ìœ¼ë¯€ë¡œ ì´ˆê¸°í™” ìˆ˜í–‰");
                    initLotGrid(() => {
                        lotGrid.resetData(data.contents);
                    });
                } else {
                    console.log("ğŸ”¹ LOT ê·¸ë¦¬ë“œ ì¡´ì¬, ë°ì´í„° ì—…ë°ì´íŠ¸");
                    lotGrid.resetData(data.contents);
                }
            } else {
                console.warn("âš ï¸ LOT ë°ì´í„°ê°€ ë¹„ì–´ìˆìŒ. ê·¸ë¦¬ë“œ ì´ˆê¸°í™”ë§Œ ìˆ˜í–‰");
                lotGrid.resetData([]);
            }
        })
        .catch(error => {
            console.error("âŒ LOT ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨:", error);
        });
}

// âœ… LOT í…Œì´ë¸”ì„ í´ë¦­í•  ë•Œë§ˆë‹¤ ë¹„ë™ê¸° ë°ì´í„° ê°±ì‹ 
function loadLotData(optionNum, companyNum) {
    console.log("ğŸ“¢ LOT ë°ì´í„° ë¡œë“œ ì‹œì‘:", optionNum, companyNum);

    // âœ… LOT í…Œì´ë¸”ì„ ë³´ì´ë„ë¡ ì„¤ì •
    document.getElementById("lot-container").style.display = "block";

    // âœ… LOT ë°ì´í„° ìš”ì²­
    fetchLotData(optionNum, companyNum);
}


// âœ… LOT ê·¸ë¦¬ë“œ ì´ˆê¸°í™” (ì´ˆê¸°ì—ëŠ” ë¹ˆ ë°ì´í„°)
function initLotGrid(callback) {
    console.log("âœ… LOT ê·¸ë¦¬ë“œ ì´ˆê¸°í™” ì‹œì‘");

    lotGrid = new tui.Grid({
        el: document.getElementById('lotGrid'),
        scrollX :false,
        scrollY : false,
        data: [],
        pageOptions: { useClient: false, perPage: 5 },
        bodyHeight: 'auto',
        columns: [
            { header: "LOT ë²ˆí˜¸", name: "goodsLotNum" },
            { header: "ìƒí’ˆ ì½”ë“œ", name: "goodsCode" },
            { header: "ìƒí’ˆëª…", name: "goodsName" },
            { header: "ì˜µì…˜ ì½”ë“œ", name: "optionCode" },
            { header: "ì˜µì…˜ëª…", name: "optionName" },
            { header: "ì°½ê³ ëª…", name: "warehouseName" },
            { header: "ì´ ì¬ê³  ìˆ˜ëŸ‰", name: "totalQuantity" },
            { header: "ì…ê³ ì¼", name: "warehousingDate" },
            { header: "ì†Œë¹„ê¸°í•œ", name: "goodsConsumptionDate" }
        ]
    });

    console.log("âœ… LOT ê·¸ë¦¬ë“œ ì´ˆê¸°í™” ì™„ë£Œ");

    // âœ… ì½œë°±ì´ ìˆë‹¤ë©´ ì‹¤í–‰ (ë°ì´í„° ì ìš©)
    if (typeof callback === "function") {
        callback();
    }
}


// âœ… í‘œì‹œ ìˆ˜ëŸ‰ ë³€ê²½
function changeProductDisplay() {
    let gap = parseInt(document.querySelector('#product_display_amount').value);
    productGrid.setPerPage(gap);
    productGrid.reloadData();
}

// âœ… ê²€ìƒ‰ ì‹¤í–‰
function productSearch() {
    let goodsName = document.querySelector('#searchGoodsName').value;
    let brandName = document.querySelector('#searchBrandName').value;

    productGrid.setRequestParams({
        "companyNum": [[${session.companyNum}]],
        "goodsName": goodsName,
        "brandName": brandName
    });

    productGrid.reloadData();
}

// âœ… í•„í„° ì´ˆê¸°í™”
function resetFilters() {
    document.querySelector('#searchGoodsName').value = '';
    document.querySelector('#searchBrandName').value = '';
    document.querySelector('#product_display_amount').value = '10';

    productGrid.setRequestParams({
        "companyNum": [[${session.companyNum}]],
        "goodsName": '',
        "brandName": ''
    });

    productGrid.reloadData();
}

</script>

</body>



