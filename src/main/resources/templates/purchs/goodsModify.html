<!DOCTYPE html>
<html layout:decorate="~{layouts/layout}"
      lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <title>ìƒí’ˆ ê´€ë¦¬</title>
  
 
    
    <!-- toast grid -->
    <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
    <script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

<style>
	#custom-container{
		background-color: #f8f9fa; /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
		padding: 20px;
		border-radius: 10px;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* ë°•ìŠ¤ ê·¸ë¦¼ì */
		margin-bottom: 20px;
	
	}
	/* ì˜µì…˜ ì¶”ê°€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn-custom {
	    width: auto; /* ë²„íŠ¼ í¬ê¸°ë¥¼ ìë™ ì¡°ì • */
	    min-width: 120px; /* ìµœì†Œ ë„ˆë¹„ ì„¤ì • */
	    padding: 10px 20px; /* íŒ¨ë”© ì¡°ì • */
	}



    
</style>
</head>
<body layout:fragment="content">
<div class="container mt-4">
    <h2 class="mb-4">ìƒí’ˆ ê´€ë¦¬</h2>

    <div id="custom-container">
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">ìƒí’ˆëª…</label>
                <input type="text" class="form-control" name="goodsName" id="goodsName"
                       th:value="${product?.goodsName}">
            </div>
            <div class="col-md-6">
                <label class="form-label">ìƒí’ˆë²ˆí˜¸</label>
                <input type="text" class="form-control" name="goodsCode" id="goodsCode"
                       th:value="${product?.goodsCode}" readonly>
                 <input type="hidden" class="form-control" name="goodsNum" id="goodsNum"
                       th:value="${product?.goodsNum}" readonly>
            </div>
        </div>

        <div class="row mb-3">
		    <div class="col-md-6">
		        <label class="form-label">ìƒí’ˆë¶„ë¥˜</label>
		        <input type="text" class="form-control" name="classificationName" id="classificationName"
                           th:value="${product?.classificationName}" readonly>
                <input type="hidden" class="form-control" name="classificationId" id="classificationId"
                           th:value="${product?.classificationId}" readonly>
		        
		    </div>

            <div class="col-md-6">
                <label class="form-label">ë¸Œëœë“œ</label>
                <div class="input-group">
                    <input type="text" class="form-control" name="brandName" id="brandName"
                           th:value="${product?.brandName}" readonly>
                    <input type="hidden" id="brandId" name="brandId" th:value="${product?.brandId}">

                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">ê³µê¸‰ì²˜</label>
                <div class="input-group">
                    <input type="text" class="form-control" name="vendorName" id="vendorName"
                           th:value="${product?.vendorName}" 
                           readonly>
                    <input type="hidden" id="vendorId" name="vendorId" th:value="${product?.vendorId}">
                    
                </div>
            </div>
            <div class="col-md-6">
                <label class="form-label">ì›ê°€</label>
                <input type="text" class="form-control" name="goodsCost" id="goodsCost"
                       th:value="${product?.goodsCost}">
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">íŒë§¤ê°€</label>
                <input type="text" class="form-control" name="goodsPrice" id="goodsPrice"
                       th:value="${product?.goodsPrice}">
            </div>
            <div class="col-md-6">
                <label class="form-label">ê³µê¸‰ê°€ì•¡</label>
                <input type="text" class="form-control" name="goodsSupplyPrice" id="goodsSupplyPrice"
                       th:value="${product?.goodsSupplyPrice}">
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">ê·œê²©</label>
                <input type="text" class="form-control" name="goodsStandard" id="goodsStandard"
                       th:value="${product?.goodsStandard}">
            </div>
            <div class="col-md-6">
                <label class="form-label">ë‹´ë‹¹ì</label>
                <input type="text" class="form-control" name="employeeName" id="employeeName"
                       th:value="${product?.employeeName}" readonly>
                <input type="hidden" id="employeeNum" name="employeeNum" th:value="${session.employeeNum}">
                
            </div>
        </div>

        <div class="row mb-3">
             <div class="col-md-6">
		        <label class="form-label">ëŒ€í‘œ ì´ë¯¸ì§€</label>
		        <div class="input-group">
		            <!-- íŒŒì¼ëª…ì„ í‘œì‹œí•˜ëŠ” input (í´ë¦­í•˜ë©´ íŒŒì¼ ì—…ë¡œë“œ ê°€ëŠ¥) -->
		            <input type="text" class="form-control" id="imageFileName" name="imageFileName" 
		                   th:value="${product?.goodsImage}" readonly onclick="document.getElementById('goodsImage').click();">
		
		            <!-- ì‹¤ì œ íŒŒì¼ ì—…ë¡œë“œìš© input (ìˆ¨ê¹€) -->
		            <input type="file" class="form-control d-none" id="goodsImage" name="file"
		                   accept=".jpg, .jpeg, .png, .pdf">
		            
		            <!-- ì—…ë¡œë“œ ë²„íŠ¼ -->
		            <button class="btn btn-outline-secondary" type="button" id="uploadImageBtn">ì—…ë¡œë“œ</button>
		        </div>
		
		        <!-- ì‹¤ì œ ì—…ë¡œë“œëœ íŒŒì¼ëª…ì„ ì €ì¥í•  hidden input -->
		        <input type="hidden" id="uploadedImageName" name="goodsImage" th:value="${product?.goodsImage}">
		    </div>
            <div class="col-md-6">
                <label class="form-label">ìƒí’ˆì„¤ëª…</label>
                <textarea class="form-control" name="goodsDescription" id="goodsDescription" rows="2"
                          th:text="${product?.goodsDescription}"></textarea>
            </div>
            <div class="col-md-6">
		        <label class="form-label">ìƒí’ˆ ìƒíƒœ</label>
		        <input type="text" class="form-control" id="goodsUseStatus" name="goodsUseStatus"
		               th:value="${product?.goodsUseStatus}" readonly>
		    </div>
		    <input type="hidden" id="companyNum" name="companyNum" th:value="${product?.companyNum}">
		    <input type="hidden" id="marginRate" name="marginRate" th:value="${product?.marginRate}">
		  
        </div>

        
    </div>

   
    <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-primary btn-custom" id="bttAdd">ì˜µì…˜ ì¶”ê°€</button>
    </div>
    
    <div id="myGrid" class="tui-grid-container" style="height: 200px;"></div>
    <script th:inline="javascript">
	    let optionsData = /*[[${options}]]*/ [];
	    console.log("âœ… Thymeleafì—ì„œ ë°›ì€ optionsData:", optionsData);
	</script>

    <div id="pagination" class="tui-pagination"></div>

    <!-- ì°½ê³  ëª¨ë‹¬ -->
    <div th:replace="~{purchs/modal/ModalTemplate :: ModalTemplate (
        'warehouseModal',
        'modal-xl',
        'ì°½ê³  ì¡°íšŒ',
        'purchs/modal/warehouseTable',
        'purchs/modal/warehouseFooter'
    )}"></div>

    <div class="d-flex justify-content-center mt-4">
        <button class="btn btn-primary mx-2" id="updateBtn">ìˆ˜ì •</button>
        <button class="btn btn-secondary mx-2">ì´ˆê¸°í™”</button>
    </div>
    
    
</div>
 



<script>



 document.addEventListener("DOMContentLoaded", function(){
	 
	 const header = document.querySelector('meta[name="_csrf_header"]').content;
	 const token = document.querySelector('meta[name="_csrf"]').content;

	 // âœ… Hidden inputì—ì„œ ê°’ ê°€ì ¸ì˜¬ ë•Œ ì•ˆì „í•œ ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬
	    let companyNum = parseInt(document.getElementById("companyNum")?.value || "0", 10);
	    let marginRate = parseInt(document.getElementById("marginRate")?.value || "0", 10);
	 

	 let grid;
	 
	 
	 // íŒŒì¼ ì„ íƒ ì‹œ íŒŒì¼ëª…ì„ í‘œì‹œ
	    document.getElementById("goodsImage").addEventListener("change", function(event) {
	        let file = event.target.files[0];
	        if (file) {
	            document.getElementById("imageFileName").value = file.name;
	            document.getElementById("uploadedImageName").value = file.name;
	        }
	    });

	    // ì´ë¯¸ì§€ ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
	    document.getElementById("uploadImageBtn").addEventListener("click", function() {
	        document.getElementById("goodsImage").click();
	    });
	    
	    //ì›ê°€ * ë§ˆì§„ë¥  = ê³µê¸‰ê°€ì•¡
   	    document.getElementById("goodsCost").addEventListener("input", function () {
   	        let goodsCost = parseFloat(this.value) || 0;
   	        
   	        
   	
   	        // ê³µê¸‰ê°€ì•¡ ê³„ì‚°: ì›ê°€ * (1 + ë§ˆì§„ë¥  / 100)
   	        let supplyPrice = parseInt(goodsCost * (1 + (marginRate / 100)),10);
   	
   	        // ê²°ê³¼ ë°˜ì˜
   	        document.getElementById("goodsSupplyPrice").value = supplyPrice;
   	    });
   	
   	    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê³µê¸‰ê°€ì•¡ ìë™ ê³„ì‚° (ì´ˆê¸° ì›ê°€ê°’ì´ ìˆì„ ê²½ìš°)
   	    let initialGoodsCost = parseFloat(document.getElementById("goodsCost").value) || 0;
   	    if (initialGoodsCost) {
   	        document.getElementById("goodsCost").dispatchEvent(new Event("input"));
   	    }

          // ëª¨ë“  í–‰ ì‚­ì œ í•¨ìˆ˜ (removeRow ì‚¬ìš©)
        function deleteAllRows() {
            const rowKeys = grid.getData().map(row => row.rowKey); // ëª¨ë“  í–‰ì˜ rowKeyë¥¼ ì–»ìŒ
            rowKeys.forEach(key => {
                grid.removeRow(key); // ê° í–‰ì„ ì‚­ì œ
            });
        }
          
          
        

        

	    // ì˜µì…˜ ì¶”ê°€ ë²„íŠ¼
	    document.getElementById("bttAdd").addEventListener("click", function () {
	    	grid.appendRow({
	            optionCode: "",           // ì˜µì…˜ ì½”ë“œ ì´ˆê¸°ê°’
	            optionName: "",           // ì˜µì…˜ëª… ì´ˆê¸°ê°’
	            totalRemainingQuantity: 0, // í˜„ì¬ ì¬ê³  ì´ˆê¸°ê°’
	            optionSafetyInvoice: 0,   // âœ… ì•ˆì „ì¬ê³  ê¸°ë³¸ê°’ 0
	            warehouseName: "",        // ìƒí’ˆ ìœ„ì¹˜ ì´ˆê¸°ê°’
	            warehouseId: 0,           // ì°½ê³  ID ì´ˆê¸°ê°’
	            optionUseFlag: 0          // ê¸°ë³¸ê°’ "ì‚¬ìš©ì¤‘"
	        }, { at: 0 });

	    });
	    
        // ì‚¬ìš©ì ì •ì˜ ë Œë”ëŸ¬ (ì‚­ì œ ë²„íŠ¼ ì¶”ê°€)
        class DeleteRenderer {
            constructor(props) {
                const el = document.createElement('button');
                el.textContent = 'ì‚­ì œ';
                el.className = 'btnDelete btn btn-danger btn-sm';
                el.addEventListener('click', () => {
                    grid.removeRow(props.rowKey); // í´ë¦­ ì‹œ í•´ë‹¹ í–‰ ì‚­ì œ
                });
                this.el = el;
            }
            getElement() {
                return this.el;
            }
        }
        
     // âœ… ì•ˆì „ì¬ê³  ë Œë”ëŸ¬ í´ë˜ìŠ¤ (ì˜¤ë¥˜ ë°©ì§€ ë²„ì „)
       class SafetyStockRenderer {
		    constructor(props) {
		        const el = document.createElement('div');
		        el.className = "d-flex justify-content-between align-items-center w-100";
		
		        // ê¸°ì¡´ ê°’ í‘œì‹œ
		        const input = document.createElement('input');
		        input.type = "text";
		        input.value = props.value ?? '0'; // ê¸°ë³¸ê°’ 0
		        input.className = "form-control form-control-sm"; // ì‘ì€ ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ ì ìš©
		
		        // Bootstrap ì•„ì´ì½˜ ë²„íŠ¼ ìƒì„±
		        const btn = document.createElement('button');
		        btn.className = "safetyStockBtn btn btn-sm btn-link p-0 text-primary border-0 ms-auto";
		        btn.innerHTML = `ğŸ“„`; // âœ… Bootstrap ì•„ì´ì½˜ ì ìš©
		
		        // ë²„íŠ¼ í´ë¦­ ì‹œ `safetyStock` ê°’ì„ `optionSafetyInvoice` ì¹¼ëŸ¼ì— ë°˜ì˜
		        btn.addEventListener("click", () => {
		            let safetyStockValue = parseInt(grid.getValue(props.rowKey, "safetyStock")) || 0;
		            console.log(`ğŸ“¢ ì•ˆì „ì¬ê³  ë²„íŠ¼ í´ë¦­: rowKey=${props.rowKey}, value=${safetyStockValue}`);
		
		            grid.setValue(props.rowKey, "optionSafetyInvoice", safetyStockValue);
		            input.value = safetyStockValue; // UIì—ë„ ë°˜ì˜
		            setTimeout(() => grid.refreshLayout(), 50);
		        });
		
		        // ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥ ì‹œ ë°ì´í„° ì—…ë°ì´íŠ¸ ë³´ì¥
		        input.addEventListener("change", () => {
		            let newValue = parseInt(input.value) || 0;
		            console.log(`ğŸ“¢ ì§ì ‘ ì…ë ¥í•œ ì•ˆì „ì¬ê³ : rowKey=${props.rowKey}, value=${newValue}`);
		            
		            grid.setValue(props.rowKey, "optionSafetyInvoice", newValue);
		            setTimeout(() => grid.refreshLayout(), 50);
		        });
		
		        el.appendChild(input);
		        el.appendChild(btn);
		        this.el = el;
		    }
		
		    getElement() {
		        return this.el;
		    }
		}



        
    

        	grid = new tui.Grid({
            el: document.getElementById('myGrid'), // ì»¨í…Œì´ë„ˆ ì—˜ë¦¬ë¨¼íŠ¸
            scrollX :false,
            scrollY : false,
            rowHeaders: ['checkbox'], 
            columns: [ 
                {header : "ì˜µì…˜ì½”ë“œ" , name:"optionCode",className: "tui-grid-cell-readonly"},
                {header : "ì˜µì…˜ëª…" , name:"optionName" , editor: "text" ,editor: "text"},
                {header : "í˜„ì¬ì¬ê³ " , name:"totalRemainingQuantity",className: "tui-grid-cell-readonly"},
                {
	                header : "ì•ˆì „ì¬ê³ " , 
	                name:"optionSafetyInvoice",
	                editor: "text",
	                renderer: {
	                    type: SafetyStockRenderer  // ì•ˆì „ì¬ê³  ë²„íŠ¼ì„ ì¶”ê°€í•˜ëŠ” ë Œë”ëŸ¬
	                }
                },
                {header : "ìƒí’ˆìœ„ì¹˜" , name:"warehouseName",editor: "text"},
                {header : "ì°½ê³ id" , name:"warehouseId" , hidden: true},
                {
                    header: "ì˜µì…˜ ì‚¬ìš©ìœ ë¬´",
                    name: "optionUseFlag",
                    formatter: function({ value }) {
                        return value == 0 ? "ì‚¬ìš©ì¤‘" : "ì‚¬ìš©ì¤‘ë‹¨"; // âœ… ìˆ«ì ë¹„êµë¡œ ë³€í™˜
                    },
                    editor: {
                        type: "select",
                        options: {
                            listItems: [
                                { text: "ì‚¬ìš©ì¤‘", value: 0 },
                                { text: "ì‚¬ìš©ì¤‘ë‹¨", value: 1 }
                            ]
                        }
                    },
                    onAfterChange: function (ev) {
                        if (ev.columnName === "optionUseFlag") {
                            let newValue = ev.value === "ì‚¬ìš©ì¤‘" ? 0 : 1;
                            grid.setValue(ev.rowKey, "optionUseFlag", newValue);
                        }
                    }
                }




            ],
            
        });
        	 console.log("ğŸ“¢ Toast Grid ì´ˆê¸°í™” ì™„ë£Œ!");
        	 
        	// âœ… í˜ì´ì§€ê°€ ë¡œë“œë  ë•Œ ì„œë²„ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    	   setTimeout(() => {
		        console.log("ğŸ“¢ optionsData ì ìš© ì „: ", JSON.stringify(optionsData, null, 2));
		
		        if (Array.isArray(optionsData) && optionsData.length > 0) {
		            grid.resetData(optionsData);
		            console.log("âœ… ì ìš© í›„ Toast Grid ë°ì´í„°:", grid.getData());
		        } else {
		            console.warn("âš ï¸ optionsDataê°€ ë¹„ì–´ìˆìŒ.");
		        }
		    }, 500);
        	
    	

       	
        // âœ… ì—”í„° ì…ë ¥ í›„ ê°’ì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šë„ë¡ `afterChange` ì´ë²¤íŠ¸ ì¶”ê°€
      grid.on('afterChange', (ev) => {
		    ev.changes.forEach(change => {
		        if (change.columnName === "optionSafetyInvoice") {
		            let newValue = change.value ?? grid.getValue(change.rowKey, "optionSafetyInvoice");
		            let rowKey = change.rowKey;
		
		            console.log(`âœ… ì•ˆì „ì¬ê³  ë³€ê²½ë¨: rowKey=${rowKey}, newValue=${newValue}`);
		
		            setTimeout(() => {
		                grid.setValue(rowKey, "optionSafetyInvoice", newValue);
		                grid.refreshLayout(); // UI ê°±ì‹  ë³´ì¥
		            }, 50);
		        }
		    });
		});
        
      grid.on('afterChange', (ev) => {
    	    ev.changes.forEach(change => {
    	        if (change.columnName === "warehouseId") {
    	            let newValue = change.value && change.value !== "" ? parseInt(change.value) : 0;
    	            grid.setValue(change.rowKey, "warehouseId", newValue);
    	        }
    	    });
    	});



     // Toast Grid ì…€ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì¶”ê°€
        grid.on('click', function(ev) {
            const { rowKey, columnName } = ev;

            // "ìƒí’ˆìœ„ì¹˜" ì»¬ëŸ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
            if (columnName === "warehouseName") {
                openWarehouseModal(rowKey);
            }
        });

 
    //ì´ë¯¸ì§€ì „ì†¡ í•¨ìˆ˜
    async function imgSave() {
        const fileInput = document.getElementById("goodsImage");
        const file = fileInput.files[0];

        if (!file) {
            console.warn("âš ï¸ ì—…ë¡œë“œí•  íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return null;
        }

        const formData = new FormData();
        formData.append("file", file);
        
        try {
            const response = await fetch("/purchs/rest/product/uploadGoodsImages", {
                method: "POST",
                headers: {
                    'header': header,
                    'X-CSRF-Token': token
                },
                body: formData
            });

            if (!response.ok) {
                throw new Error("âŒ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: " + response.statusText);
            }

            // âœ… JSON ì‘ë‹µ ì²˜ë¦¬
            const data = await response.json();

            if (data.success) {
                console.log("âœ… ì—…ë¡œë“œëœ íŒŒì¼ëª…:", data.fileName);
                document.getElementById("uploadedImageName").value = data.fileName;
                return data.fileName; // âœ… íŒŒì¼ëª… ë°˜í™˜
            } else {
                console.warn("âŒ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:", data.message);
                return null;
            }
        } catch (error) {
            console.error("âŒ íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            return null;
        }
    }
    
 // âœ… ì´ë¯¸ì§€ ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì‹œ imgSave() ì‹¤í–‰
    document.getElementById("uploadImageBtn").addEventListener("click", async function () {
        try {
            const uploadedFileName = await imgSave(); // âœ… ì´ë¯¸ì§€ ì—…ë¡œë“œ í›„ íŒŒì¼ëª… ë°˜í™˜
            if (uploadedFileName) {
                console.log("âœ… ì´ë¯¸ì§€ íŒŒì¼ëª… ì €ì¥ë¨:", uploadedFileName);

                // âœ… ì—…ë¡œë“œëœ íŒŒì¼ëª…ì„ <input>ì— ë°˜ì˜
                //document.getElementById("uploadedImageName").value = uploadedFileName;
                //console.log("âœ… Hidden Input ê°’ ì—…ë°ì´íŠ¸ë¨: ", document.getElementById("uploadedImageName").value);
            } else {
                console.warn("âš ï¸ ì„œë²„ì—ì„œ íŒŒì¼ëª…ì„ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            }
        } catch (error) {
            console.error("âŒ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
    });

 
   
 //ì°½ê³  ëª¨ë‹¬ ì‘ì—…

function openWarehouseModal(rowKey) {
   	    sessionStorage.setItem("selectedRowKey", rowKey); // í´ë¦­í•œ í–‰(rowKey) ì €ì¥
   	    
   	 	let selectedRowKey = parseInt(sessionStorage.getItem("selectedRowKey"), 10);

   	
   	    // ëª¨ë‹¬ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
   	    const modalElement = document.getElementById('warehouseModal');
   	    if (!modalElement) {
   	        console.error("warehouseModal ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
   	        return;
   	    }
   	    

   	    // ì°½ê³  ê·¸ë¦¬ë“œê°€ ì •ì˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ í›„ ë°ì´í„° ê°±ì‹ 
   	    if (typeof warehouseGrid !== 'undefined' && warehouseGrid !== null) {
   	        console.log("ğŸ“¢ ì°½ê³  ëª¨ë‹¬: ë°ì´í„° ì´ˆê¸°í™” ë° ìƒˆë¡œê³ ì¹¨ ì‹œì‘");
   	
   	        // ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™”
   	    
   	        let Data = warehouseGrid.getData();
   	        console.log("ê·¸ë¦¬ë“œë°ì´í„°",Data)
   	        console.log(bootstrap.Version);

   	        
   			 warehouseGrid.readData();
   	        
   	        setTimeout(() => {
   		        warehouseGrid.refreshLayout();  // ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™”
   	        	
   			}, 500);
  

   	        // ë°ì´í„°ë¥¼ ë‹¤ ë¶ˆëŸ¬ì˜¨ í›„ ëª¨ë‹¬ ì—´ê¸° (onGridUpdated ì´ë²¤íŠ¸ í™œìš©)
   	         warehouseGrid.on("onGridUpdated", function () {
   	            console.log("ì°½ê³  ëª¨ë‹¬: ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ");
   	            

   	            // ë°ì´í„° ë¡œë“œ ì™„ë£Œ í›„ ëª¨ë‹¬ ì—´ê¸°
   	            const modalInstance = new bootstrap.Modal(modalElement);
   	            modalInstance.show(); // ëª¨ë‹¬ ì—´ê¸°
   	            
   	            
   	            console.log("ì°½ê³  ëª¨ë‹¬ ì—´ë¦¼:", rowKey);
   	        }); 
   	    } else {
   	        console.warn("warehouseGridê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
   	    } 
   	}
 
document.getElementById('warehouseModal').addEventListener('shown.bs.modal', function () {
	    console.log(" ì°½ê³  ëª¨ë‹¬ì´ ì—´ë ¸ìŠµë‹ˆë‹¤. ê·¸ë¦¬ë“œ ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰");

	    if (typeof warehouseGrid !== 'undefined' && warehouseGrid !== null) {
	        warehouseGrid.readData();       // ğŸš€ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
	  
	        console.log("ì°½ê³  ê·¸ë¦¬ë“œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ");
	    } else {
	        console.warn("warehouseGridê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
	    }
	}); 
	
	
  
	
		//ëª¨ë‹¬ ê²€ì€ í™”ë©´ ëª¨ë‘ ì œê±° 
	   document.querySelectorAll('[data-bs-toggle="modal"]').forEach(function (modalTrigger) {
		    modalTrigger.addEventListener("click", function () {
		        document.querySelectorAll('.modal-backdrop').forEach(function (element) {
		            element.remove(); // ì¤‘ë³µ ìƒì„± ë°©ì§€
		        });
		    });
		});
   
	    const modalElement = document.getElementById("warehouseModal");
	    const closeButton = modalElement.querySelector('[data-bs-dismiss="modal"]');
	    
	    
	    console.log()
	    if (closeButton) {
	        closeButton.addEventListener("click", function () {
	            console.log("âœ… ì°½ê³  ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ í´ë¦­ë¨!");

	            try {
	            	let modalInstance = bootstrap.Modal.getInstance("#warehouseModal") || new bootstrap.Modal("#warehouseModal");
	                modalInstance.hide(); // âœ… Bootstrap ë°©ì‹ìœ¼ë¡œ ëª¨ë‹¬ ë‹«ê¸°
	                
	            } catch (error) {
	                console.warn("âŒ Bootstrap 5ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŒ. ëŒ€ì²´ ë°©ì‹ ì‚¬ìš©");
	                modalElement.classList.remove("show");
	                modalElement.style.display = "none";
	                document.body.classList.remove("modal-open");

	                setTimeout(() => {
	                    document.querySelectorAll(".modal-backdrop").forEach((element) => element.remove()); // ë°±ê·¸ë¼ìš´ë“œ ì œê±°
	                }, 300);
	                
	                hiddenwmodal();
	            }
	        });
	    } else {
	        console.warn("âŒ ì°½ê³  ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
	    } 
	  
	

	    function hiddenwmodal() {
	        let selectedWarehouseId = sessionStorage.getItem("selectedWarehouseId");
	        let selectedWarehouseName = sessionStorage.getItem("selectedWarehouseName");
	        let selectedRowKey = parseInt(sessionStorage.getItem("selectedRowKey"), 10); // âœ… ìˆ«ìë¡œ ë³€í™˜

	        console.log("ğŸ“¢ ì €ì¥ëœ ë°ì´í„° í™•ì¸:", selectedWarehouseId, selectedWarehouseName, selectedRowKey);

	        if (selectedWarehouseId && selectedWarehouseName && !isNaN(selectedRowKey)) {
	            setTimeout(() => {
	                grid.setValue(selectedRowKey, "warehouseId", selectedWarehouseId, false);
	                grid.setValue(selectedRowKey, "warehouseName", selectedWarehouseName, false);

	                console.log(`âœ… ê·¸ë¦¬ë“œì— ê°’ ì„¤ì • ì™„ë£Œ: ${selectedRowKey} => ${selectedWarehouseName} + ${selectedWarehouseId}`);

	                let currentData = grid.getData();
	                console.log("ğŸ“¢ í˜„ì¬ ê·¸ë¦¬ë“œ ë°ì´í„°:", currentData);

	                // âœ… UI ì—…ë°ì´íŠ¸ ë³´ì¥
	                setTimeout(() => {
	                    grid.refreshLayout();
	                }, 50);

	                // âœ… sessionStorage ë°ì´í„° ì‚­ì œ
	                sessionStorage.removeItem("selectedWarehouseId");
	                sessionStorage.removeItem("selectedWarehouseName");
	                sessionStorage.removeItem("selectedRowKey");
	            }, 100);
	        } else {
	            console.warn("ğŸ“¢ ì €ì¥ëœ ìƒí’ˆ ìœ„ì¹˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
	        }
	    }


	    // âœ… ëª¨ë‹¬ í´ë¦­ ì‹œ ì¤‘ë³µ ë°±ê·¸ë¼ìš´ë“œ ì œê±°
	    document.querySelectorAll('[data-bs-toggle="modal"]').forEach(function (modalTrigger) {
	        modalTrigger.addEventListener("click", function () {
	            document.querySelectorAll('.modal-backdrop').forEach(function (element) {
	                element.remove(); // ì¤‘ë³µ ìƒì„± ë°©ì§€
	            });
	        });
	    });
	    
	    // âœ… ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
	 // âœ… ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
	    document.getElementById("updateBtn").addEventListener("click", async function () {
	        try {
	            // ìƒí’ˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
	            let goodsNum = parseInt(document.getElementById("goodsNum").value) || 0;  // ìƒí’ˆë²ˆí˜¸ (PK)
	            let goodsName = document.getElementById("goodsName").value;
	            let goodsCost = parseInt(document.getElementById("goodsCost").value) || 0;
	            let goodsPrice = parseInt(document.getElementById("goodsPrice").value) || 0;
	            let goodsSupplyPrice = parseInt(document.getElementById("goodsSupplyPrice").value) || 0;
	            let goodsStandard = document.getElementById("goodsStandard").value;
	            let goodsDescription = document.getElementById("goodsDescription").value;
	            let goodsImage = document.getElementById("uploadedImageName").value;  // ì—…ë¡œë“œëœ ì´ë¯¸ì§€ íŒŒì¼ëª…
	            let employeeNum = parseInt(document.getElementById("employeeNum").value) || 0;
	            let companyNum = parseInt(document.getElementById("companyNum").value) || 0;

	            // âœ… ì˜µì…˜ ë¦¬ìŠ¤íŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì²´í¬ëœ í–‰ë§Œ)
	            let optionData = grid.getCheckedRows().map(row => ({
	                optionNum: parseInt(row.optionNum) || 0,  // ì˜µì…˜ ì½”ë“œ
	                optionName: row.optionName,
	                optionSafetyInvoice: parseInt(row.optionSafetyInvoice) || 0,
	                warehouseId: row.warehouseId && row.warehouseId !== "" ? parseInt(row.warehouseId) : null, // âœ… ë¹ˆ ê°’ì´ë©´ null ìœ ì§€
	                optionUseFlag: row.optionUseFlag == 0 ? 0 : 1 // âœ… ê°’ì´ ìˆ«ìì¸ì§€ í™•ì¸ í›„ ë³€í™˜
	            }));

	            // âœ… ì²´í¬ëœ ì˜µì…˜ì´ ì—†ëŠ” ê²½ìš° ì•Œë¦¼
	            if (optionData.length === 0) {
	                alert("âš ï¸ ìˆ˜ì •í•  ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
	                return;
	            }

	            console.log("ğŸ“¢ ì „ì†¡í•  ì˜µì…˜ ë¦¬ìŠ¤íŠ¸:", optionData);

	            // âœ… ìµœì¢… ë°ì´í„° JSON êµ¬ì¡° ë§Œë“¤ê¸°
	            let updateData = {
	                goodsNum: goodsNum,
	                goodsName: goodsName,
	                goodsCost: goodsCost,
	                goodsPrice: goodsPrice,
	                goodsSupplyPrice: goodsSupplyPrice,
	                goodsStandard: goodsStandard,
	                goodsDescription: goodsDescription,
	                goodsImage: goodsImage,
	                employeeNum: employeeNum,
	                companyNum: companyNum,
	                files: optionData
	            };

	            console.log("ğŸ“¢ ì„œë²„ë¡œ ë³´ë‚¼ ë°ì´í„°:", updateData);

	            // âœ… ì„œë²„ì— ìƒí’ˆ ìˆ˜ì • ìš”ì²­ (Ajax)
	            const response = await fetch("/purchs/rest/product/update", {
	                method: "POST",
	                headers: {
	                    "Content-Type": "application/json",
	                    "X-CSRF-Token": document.querySelector('meta[name="_csrf"]').content
	                },
	                body: JSON.stringify(updateData)
	            });

	            // âœ… ì‘ë‹µ ì²˜ë¦¬
	            const result = await response.json();
	            if (result.status === "success") {
	                alert("âœ… ìƒí’ˆì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
	                location.reload();  // âœ… í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
	            } else {
	                alert("âŒ ìƒí’ˆ ìˆ˜ì • ì‹¤íŒ¨: " + result.message);
	            }

	        } catch (error) {
	            console.error("âŒ ìƒí’ˆ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
	            alert("âš ï¸ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
	        }
	    });

	    
	    
  
      
  });

 

    
 
    
</script>
<!-- âœ… Bootstrap 5 CDN ì¶”ê°€ -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>


</html>
