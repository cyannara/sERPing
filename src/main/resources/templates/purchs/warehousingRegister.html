<html layout:decorate="~{layouts/layout}"
      lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
 
 <head>

<style>
     /* âœ… ê³µí†µ ìŠ¤íƒ€ì¼ */
     .container { max-width: 1200px; margin: auto; }
     .section-box { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
     .section-title { font-weight: bold; margin-bottom: 10px; }
     
     .tui-grid-container {
	    overflow: visible !important;
	}
     

	.tui-datepicker.tui-datepicker-popup {
	    transform: none !important; /* âœ… Grid ë‚´ë¶€ì˜ transform ì†ì„± ì œê±° */
	    position: absolute !important;
	}
	
  


</style>
 	
 </head>     
<body layout:fragment="content">
<div class="container mt-4">
    <h2>ì œí’ˆêµ¬ë§¤ / êµ¬ë§¤ ë“±ë¡</h2>
    
    <!-- âœ… ìƒë‹¨: ë°œì£¼ ê²€ìƒ‰ (ì‘ê²Œ) & ë°œì£¼ì„œ ëª©ë¡ (ë„“ê²Œ) -->
    <div class="row">
        <!-- âœ… ë°œì£¼ì„œ ì¡°íšŒ ë°•ìŠ¤ í¬ê¸° ì¤„ì´ê¸° -->
        <div class="col-md-4">
            <div class="section-box">
                <h4 class="section-title">ë°œì£¼ì„œ ì¡°íšŒ</h4>
                <div class="row g-2 align-items-center">
                    <div class="col-6">
                        <label for="searchPurchaseNum" class="form-label">ë°œì£¼ë²ˆí˜¸</label>
                        <input type="text" id="searchPurchaseNum" class="form-control" placeholder="ë°œì£¼ë²ˆí˜¸ ì…ë ¥">
                    </div>
                    <div class="col-6">
                        <label for="searchVendorName" class="form-label">ê±°ë˜ì²˜ëª…</label>
                        <input type="text" id="searchVendorName" class="form-control">
                    </div>
                    <div class="col-12">
                        <label class="form-label">ë°œì£¼ì¼ì</label>
                        <div class="input-group">
                            <input type="date" id="searchStartDate" class="form-control">
                            <span class="input-group-text">~</span>
                            <input type="date" id="searchEndDate" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="mt-3 text-end">
                    <button type="button" class="btn btn-primary" onclick="purchaseSearch()">ê²€ìƒ‰</button>
                    <button type="button" class="btn btn-secondary" onclick="resetFilters()">ì´ˆê¸°í™”</button>
                </div>
            </div>
        </div>

        <!-- âœ… ë°œì£¼ì„œ ëª©ë¡ ê·¸ë¦¬ë“œ ë„“ê²Œ ë°°ì¹˜ -->
        <div class="col-md-8">
            <div class="section-box">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="section-title mb-0">ë°œì£¼ì„œ ëª©ë¡</h4>
                    <div class="d-flex align-items-center">
                        <label for="warehouse_display_amount" class="form-label me-2 mb-0" style="font-size: 14px;">í‘œì‹œ ìˆ˜ëŸ‰</label>
                        <select id="warehouse_display_amount" class="form-select form-select-sm" onchange="changewarehousingDisplay()" style="width: 80px;">
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>
                <div id="purchaselistGrid"></div>
                <div id="pagination" class="tui-pagination mt-3"></div>
                <button type="button" class="btn btn-primary" id="addwarehousinglist" onclick="moveToPurchaseDetail()">êµ¬ë§¤ë¦¬ìŠ¤íŠ¸ì¶”ê°€</button>
            </div>
        </div>
    </div>

    <!-- âœ… í•˜ë‹¨: êµ¬ë§¤ ì •ë³´ ì…ë ¥ & êµ¬ë§¤ ìƒì„¸ ë¦¬ìŠ¤íŠ¸ -->
    
    <!-- âœ… êµ¬ë§¤ ì •ë³´ ì…ë ¥ -->
	<div class="section-box mt-3">
	    <h4 class="section-title">êµ¬ë§¤ ì •ë³´ ì…ë ¥</h4>
	    <div class="d-flex flex-wrap gap-3">
	        <div class="flex-grow-1">
	            <label for="purchaseDate" class="form-label">ì¼ì</label>
	            <input type="date" id="purchaseDate" class="form-control" th:value="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}" readonly>
	        </div>
	        <div class="flex-grow-1">
	            <label for="responsiblePerson" class="form-label">êµ¬ë§¤ë‹´ë‹¹ì</label>
	            <input type="text" id="employeeName" name="employeeName" class="form-control" th:value="${session.employeeName}" readonly>
	            <input type="hidden" id="employeeNum" name="employeeNum" class="form-control" th:value="${session.employeeNum}" >
	            <input type="hidden" id="companyNum" name="companyNum" class="form-control" th:value="${session.companyNum}" >
	        </div>
	        <div class="flex-grow-1">
	            <label for="warehouse" class="form-label">ì…ê³ ì°½ê³ </label>
	            <input type="text" id="warehouseName" name="warehouseName" class="form-control" data-bs-toggle="modal" data-bs-target="#warehouseModal">
	            <input type="hidden" id="warehouseId" name="warehouseId">
	        </div>
	          <!--  ì°½ê³  ëª¨ë‹¬ -->
			    <div th:include="purchs/modal/ModalTemplate :: ModalTemplate (
			    'warehouseModal', 
			    'modal-xl', 
			    'ì°½ê³  ì¡°íšŒ', 
			    'purchs/modal/warehouseTable', 
			    'purchs/modal/warehouseFooter'
			    )"></div>
	        <div class="flex-grow-1">
	            <label for="manufactureDateInput" class="form-label">ì œì¡°ì¼ì</label>
	            <input type="date" id="manufactureDateInput" class="form-control">
	        </div>
	    </div>
	    
	    <!-- âœ… ë¶€ê°€ì„¸ ì²´í¬ë°•ìŠ¤: ì•„ë˜ ë³„ë„ ë°°ì¹˜ -->
	    <div class="mt-3">
	        <input type="checkbox" id="vatUnchecked"> ë¶€ê°€ì„¸ìœ¨(VAT) ë¯¸ì ìš©
	        <input type="checkbox" id="vatChecked"> ë¶€ê°€ì„¸ìœ¨(VAT) ì ìš©
	    </div>
	</div>

    <div class="section-box mt-3">
        <h4 class="section-title">êµ¬ë§¤ ìƒì„¸ ë¦¬ìŠ¤íŠ¸</h4>
        <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-primary btn-custom" id="bttAdd">ì˜µì…˜ ì¶”ê°€</button>
        </div>
        <div id="warehousinglistGrid"></div>
    </div>
    
    	 
	<!-- ìƒí’ˆ ëª¨ë‹¬ -->
	 <div th:include="purchs/modal/ModalTemplate :: ModalTemplate (
	  'goodsModal', 
	  'modal-xl', 
	  'ìƒí’ˆ ì¡°íšŒ', 
	  'purchs/modal/goodsTable', 
	  'purchs/modal/brandFooter'
	  )"></div> 

    <div class="text-center mt-4">
        <button type="button" class="btn btn-primary" id="warehousingInsert">ë“±ë¡</button>
        <button type="button" class="btn btn-secondary">ì´ˆê¸°í™”</button>
    </div>
</div>

<script>


 // ì»¤ìŠ¤í…€ ë Œë”ëŸ¬ í´ë˜ìŠ¤ ì •ì˜ (ìµœìƒë‹¨)
  if (!window.CustomTextRenderer) {
    console.log("âœ… CustomTextRenderer ì„ ì–¸ë¨");
    window.CustomTextRenderer = class {
        constructor(props) {
            const el = document.createElement('div');
            el.innerText = props.value;
            el.style.padding = '10px';
            el.style.fontWeight = 'bold';
            el.style.textAlign = 'left';
            this.el = el;
        }
        getElement() {
            return this.el;
        }
    };
} else {
    console.warn("âš ï¸ CustomTextRendererê°€ ì´ë¯¸ ì„ ì–¸ë˜ì–´ ìˆìŒ, ì¤‘ë³µ ì„ ì–¸ ë°©ì§€ë¨.");
}

  
//âœ… ì‚­ì œ ë²„íŠ¼ ë Œë”ëŸ¬ (ì „ì—­ìœ¼ë¡œ ì´ë™)
  class DeleteRenderer {
      constructor(props) {
          const el = document.createElement("button");
          el.textContent = "ì‚­ì œ";
          el.className = "btnDelete btn btn-danger btn-sm";
          el.addEventListener("click", () => {
              // âœ… ì˜¬ë°”ë¥¸ ê·¸ë¦¬ë“œ ê°ì²´ì—ì„œ í•´ë‹¹ í–‰ ì‚­ì œ
              warehousinglistGrid.removeRow(props.rowKey);
          });
          this.el = el;
      }
      getElement() {
          return this.el;
      }
  }
  
//âœ… ë™ì ìœ¼ë¡œ input ê°’ì´ ë³€ê²½ë  ë•Œ ë¹ˆ ì œì¡°ì¼ì ìë™ ì…ë ¥
  document.querySelector("#manufactureDateInput").addEventListener("input", function () {
      fillEmptyManufactureDates();
  });

  // âœ… ë¹ˆ ì œì¡°ì¼ìë¥¼ input ê°’ìœ¼ë¡œ ìë™ ì±„ìš°ëŠ” í•¨ìˆ˜
  function fillEmptyManufactureDates() {
      console.log("ğŸ“¢ ë¹ˆ ì œì¡°ì¼ì ìë™ ì…ë ¥ ì‹œì‘");

      // âœ… í˜„ì¬ input ë°•ìŠ¤ì˜ ì œì¡°ì¼ì ê°’ ê°€ì ¸ì˜¤ê¸°
      const manufactureDateInput = document.querySelector("#manufactureDateInput").value;
      if (!manufactureDateInput) {
          console.warn("âš ï¸ ì œì¡°ì¼ì ì…ë ¥ ë°•ìŠ¤ ê°’ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
          return;
      }

      // âœ… ê·¸ë¦¬ë“œ ë°ì´í„° í™•ì¸
      warehousinglistGrid.getData().forEach(row => {
          if (!row.manufactureDate) {  // âœ… ê°’ì´ ë¹„ì–´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì…ë ¥
              console.log(`âœ… ì œì¡°ì¼ì ìë™ ì…ë ¥: rowKey=${row.rowKey}, ê°’=${manufactureDateInput}`);
              warehousinglistGrid.setValue(row.rowKey, "manufactureDate", manufactureDateInput);
          }
      });

      console.log("âœ… ì œì¡°ì¼ì ìë™ ì…ë ¥ ì™„ë£Œ!");
  }



	
  let purchaselistGrid; 
  let warehousinglistGrid; // âœ… ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸
  let header = document.querySelector('meta[name="_csrf_header"]').content;
  let token = document.querySelector('meta[name="_csrf"]').content;
  // í˜ì´ì§€ ë¡œë“œ í›„ ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
  document.addEventListener("DOMContentLoaded", function () {
      console.log("âœ… ë°œì£¼ì„œ ê·¸ë¦¬ë“œ ì´ˆê¸°í™”");
      
      setTimeout(fillEmptyManufactureDates, 1000); // âœ… 1ì´ˆ í›„ ì‹¤í–‰ (ê·¸ë¦¬ë“œ ë¡œë“œ ì´í›„)
      
      initPurchaseGrid();//ë°œì£¼ì„œê·¸ë¦¬ë“œ
  
      initwarehousingGrid(); // êµ¬ë§¤ ìƒì„¸ ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
      setTimeout(fillEmptyManufactureDates, 1000); // âœ… 1ì´ˆ í›„ ì‹¤í–‰ (ê·¸ë¦¬ë“œ ë¡œë“œ ì´í›„)
      
      initWarehouseModal(); // ì°½ê³  ëª¨ë‹¬ ì´ˆê¸°í™” ì¶”ê°€
      
  	
  	//ëª¨ë‹¬ ë‹«ê¸° ì‘ì—… 
  	const modalElement = document.getElementById("goodsModal");
  	const closeButton = modalElement.querySelector('[data-bs-dismiss="modal"]');

  	if (closeButton) {
  	    closeButton.addEventListener("click", function () {
  	        console.log("âœ… ì°½ê³  ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ í´ë¦­ë¨!");

  	        try {
  	        	let modalInstance = bootstrap.Modal.getInstance("#goodsModal") || new bootstrap.Modal("#goodsModal");
  	            modalInstance.hide(); // âœ… Bootstrap ë°©ì‹ìœ¼ë¡œ ëª¨ë‹¬ ë‹«ê¸°
  	            
  	        } catch (error) {
  	            console.warn("âŒ Bootstrap 5ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŒ. ëŒ€ì²´ ë°©ì‹ ì‚¬ìš©");
  	            modalElement.classList.remove("show");
  	            modalElement.style.display = "none";
  	            document.body.classList.remove("modal-open");

  	            setTimeout(() => {
  	                document.querySelectorAll(".modal-backdrop").forEach((element) => element.remove()); // ë°±ê·¸ë¼ìš´ë“œ ì œê±°
  	            }, 300);
  				
  	// âœ… ëª¨ë‹¬ ë‹«í ë•Œ sessionStorage ê°’ ê°€ì ¸ì™€ì„œ ê·¸ë¦¬ë“œì— ì €ì¥
  		    setupModalCloseEvent();
      
  	          
  	        }
  	    });
  	} else {
  	    console.warn("âŒ ì°½ê³  ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  	} 
  	

  
  });
  

  function initPurchaseGrid() {
      const companyNum = [[${session.companyNum}]];
      if (!companyNum) {
          console.error("âŒ ì„¸ì…˜ì—ì„œ companyNum ê°’ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ.");
          return;
      }
      const purchaselistDataSource = {
          api: {
              readData: {
                  url: '/purchs/rest/nonwarehousing/list',
                  method: 'GET',
                  requestOptions: {
                      headers: { 'Content-Type': 'application/json' },
                      credentials: 'same-origin'
                  },
                  initParams: {
                      page: 1,
                      perPage: 10,
                      companyNum: companyNum
                  },
                  beforeRequest: function(request) {
                      console.log("ğŸ“¢ ì„œë²„ë¡œ ìš”ì²­ ë³´ë‚´ê¸° ì „ requestParams:", request.params);
                  },
                  afterResponse: function(response) {
                      console.log("ğŸ“¢ ì„œë²„ ì‘ë‹µ:", response);
                      if (response.data && response.data.contents) {
                          console.log("âœ… ë³€í™˜ëœ ë°ì´í„°:", response.data.contents);
                          return { data: response.data.contents, totalCount: response.data.pagination.totalCount };
                      }
                      console.warn("âš ï¸ ì„œë²„ ì‘ë‹µì— contentsê°€ ì—†ìŠµë‹ˆë‹¤.");
                      return { data: [], totalCount: 0 };
                  }
              }
          },
          contentType: 'application/json',
          serverSidePagination: true
      };
      

      purchaselistGrid = new tui.Grid({
          el: document.getElementById('purchaselistGrid'),
          data: purchaselistDataSource,
          pageOptions: {
              useClient: false,
              perPage: 10
          },
          bodyHeight: 'auto',
          scrollX :false,
          scrollY : false,
          rowHeaders: ['checkbox'], 
          columns: [
              { header: "ë°œì£¼ë²ˆí˜¸", name: "purchaseNum", rowSpan: true, renderer: { type: CustomTextRenderer } },
              { header: "ê±°ë˜ì²˜ëª…", name: "vendorName" },
              { header: "ìƒí’ˆëª…", name: "goodsName" },
              { header: "ì˜µì…˜ëª…", name: "optionName" },
              { header: "ë°œì£¼ìˆ˜", name: "purchaseQuantity" ,formatter:(row)=>numberFormat(row.value) },
              { header: "ë¯¸ì…ê³ ìˆ˜", name: "nonWarehousingNum" ,formatter:(row)=>numberFormat(row.value) },
          ]
      });
      // âœ… ì „ì—­ ë³€ìˆ˜ë¡œ ì„¤ì • (ì´ë²¤íŠ¸ ë“±ë¡ ì „ì— í•„ìš”)
      window.purchaseGrid = purchaselistGrid;
      console.log("âœ… Toast Grid ì´ˆê¸°í™” ì™„ë£Œ");
  }

  // purchaselistGrid ê²€ìƒ‰
  function purchaseSearch() {
      let purchaseNum = document.querySelector('#searchPurchaseNum').value.trim();
      let vendorName = document.querySelector('#searchVendorName').value.trim();
      let startDate = document.querySelector('#searchStartDate').value;
      let endDate = document.querySelector('#searchEndDate').value;
      purchaselistGrid.setRequestParams({
          "companyNum": [[${session.companyNum}]],
          "vendorName" : vendorName,
          "purchaseNum": purchaseNum,
          "startDate": startDate,
          "endDate": endDate
      });
      purchaselistGrid.reloadData();
  }

  function changewarehousingDisplay() {
      let gap = parseInt(document.querySelector('#warehouse_display_amount').value);
      purchaselistGrid.setPerPage(gap);
      purchaselistGrid.reloadData();
  }

  function resetFilters() {
      document.querySelector('#searchPurchaseNum').value = '';
      document.querySelector('#searchVendorName').value = '';
      document.querySelector('#searchStartDate').value = '';
      document.querySelector('#searchEndDate').value = '';
      document.querySelector('#purchase_display_amount').value = '';
      purchaselistGrid.setRequestParams({
          "companyNum": companyNum,
          "vendorName" : '',
          "purchaseNum": '',
          "startDate": '',
          "endDate": ''
      });
      purchaselistGrid.reloadData();
  }
  
  //êµ¬ë§¤ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ë“œ 
  function initwarehousingGrid(){
	  

		 warehousinglistGrid = new tui.Grid({
          el: document.getElementById('warehousinglistGrid'),
          data: [],
          bodyHeight: 'auto',
          scrollX :false,
          scrollY : false,
          rowHeaders: ['checkbox'], 
          columns: [
              { header: 'ìƒí’ˆì½”ë“œ', name: 'goodsCode'},
              { header: 'ë°œì£¼ì„œë²ˆí˜¸', name: 'purchaseBodyNum' ,hidden: true},
              { header: 'ìƒí’ˆëª…', name: 'goodsName' },
              { header: 'ì˜µì…˜ì½”ë“œ', name: 'optionCode' },
              { header: 'ì˜µì…˜ëª…', name: 'optionName' },
              { header: 'ì˜µì…˜ë²ˆí˜¸', name: 'optionNum' ,hidden: true},
              { header: 'ê±°ë˜ì²˜ëª…', name: 'vendorName' },
              { header: 'ê±°ë˜ì²˜ë²ˆí˜¸', name: 'vendorId' ,hidden: true},
              { header: 'ê·œê²©', name: 'goodsStandard' },
              { header: 'ìˆ˜ëŸ‰', name: 'warehousingStandardQuantity', editor: "text" ,formatter:(row)=>numberFormat(row.value)},
              { header: 'ë‹¨ê°€', name: 'warehousingUnitPrice',formatter:(row)=>numberFormat(row.value) },
              { header: 'ê³µê¸‰ê°€ì•¡', name: 'warehousingSupplyPrice' ,formatter:(row)=>numberFormat(row.value)},
              { header: 'ë¶€ê°€ì„¸', name: 'warehousingVat' ,formatter:(row)=>numberFormat(row.value)},
             { 
            	    header: 'ì œì¡°ì¼ì', 
            	    name: 'manufactureDate', 
            	    editor: { type : "datePicker",
						  options : { format : "yyyy-MM-dd",
					  		  type : "date",
					  		  timepicker : false
					  		 
						  }}},


              {
                  header : "ì‚­ì œ"
                  ,name: "delete"
                  ,renderer: {
                  type: DeleteRenderer // ì‚­ì œë²„íŠ¼ ì •ì˜ ë Œë”ëŸ¬
                  }  
                  ,cellStyle: { textAlign: "center" }
                  ,className: "tui-grid-cell-readonly"
              }
  
              
          ]
      });
		 
	

		  
	

	 // âœ… ê³µê¸‰ê°€ê²© ìë™ ê³„ì‚° í•¨ìˆ˜
	 function calculateSupplyPrice(rowKey) {
	     let quantity = removeCommas(warehousinglistGrid.getValue(rowKey, "warehousingStandardQuantity")) || "0";
	     let unitPrice = removeCommas(warehousinglistGrid.getValue(rowKey, "warehousingUnitPrice")) || "0";

	     let supplyPrice = quantity * unitPrice;
	     
	     console.log(`âœ… ê³µê¸‰ê°€ ìë™ ê³„ì‚° (rowKey: ${rowKey}) â†’ ê³µê¸‰ê°€: ${supplyPrice}`);

	     // âœ… ê³„ì‚°ëœ ê³µê¸‰ê°€ê²©ì„ Gridì— ì—…ë°ì´íŠ¸
	     warehousinglistGrid.setValue(rowKey, "warehousingSupplyPrice", supplyPrice);
	     
	     

	     // âœ… VAT ë‹¤ì‹œ ê³„ì‚° (ë°œì£¼ì„œì—ì„œ ê°€ì ¸ì˜¨ í•­ëª©ë„ í¬í•¨)
	     updateVat(rowKey, true);

	   
	 }
	 
	// âœ… ë¶€ê°€ì„¸ ìë™ ì ìš© í•¨ìˆ˜ (ê¸°ì¡´ ê°’ ìœ ì§€)
	 function updateVat(rowKey, forceUpdate = false) {
	     const applyVat = document.getElementById("vatChecked").checked;

	     let supplyPrice = parseFloat(removeCommas(warehousinglistGrid.getValue(rowKey, "warehousingSupplyPrice"))) || 0;
	     let existingVat = parseFloat(removeCommas(warehousinglistGrid.getValue(rowKey, "warehousingVat"))) || 0;
	     let newVat = applyVat ? supplyPrice * 0.1 : 0;

	     // âœ… ê¸°ì¡´ VAT ê°’ì´ 0ì´ ì•„ë‹ˆë©´ ìœ ì§€, 0ì´ë©´ ìƒˆë¡œ ê³„ì‚°
	     if (existingVat === 0 || forceUpdate) {
	         warehousinglistGrid.setValue(rowKey, "warehousingVat", newVat);
	         console.log(`âœ… ë¶€ê°€ì„¸ ì ìš© (rowKey: ${rowKey}) â†’ ë¶€ê°€ì„¸: ${newVat}`);
	     } else {
	         console.log(`âœ… ê¸°ì¡´ ë¶€ê°€ì„¸ ìœ ì§€ (rowKey: ${rowKey}) â†’ ê¸°ì¡´ ë¶€ê°€ì„¸: ${existingVat}`);
	     }
	 }
	
	// âœ… ê·¸ë¦¬ë“œ ë³€ê²½ ê°ì§€ ì´ë²¤íŠ¸ ì¶”ê°€ (ìˆ˜ëŸ‰, ë‹¨ê°€ ë³€ê²½ ì‹œ ìë™ ê³„ì‚°)
	 warehousinglistGrid.on("afterChange", function (ev) {
	     ev.changes.forEach(change => {
	         if (change.columnName === "warehousingStandardQuantity" || change.columnName === "warehousingUnitPrice") {
	             console.log(`ğŸ“¢ ë³€ê²½ ê°ì§€ (rowKey: ${change.rowKey}, column: ${change.columnName}, value: ${change.value})`);
	             calculateSupplyPrice(change.rowKey);
	         }
	     });
	     
	    
	 });

	// âœ… ë¶€ê°€ì„¸ ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (ìƒˆë¡œìš´ ì¶”ê°€ëœ í–‰ë§Œ ë°˜ì‘)
	 document.getElementById("vatUnchecked").addEventListener("click", function () {
	     if (this.checked) {
	         document.getElementById("vatChecked").checked = false;
	         setTimeout(() => {
	             warehousinglistGrid.getData().forEach(row => {
	                 if (!row.purchaseBodyNum) { // âœ… purchaseBodyNumì´ ì—†ê±°ë‚˜ nullì¸ ê²½ìš°ë§Œ ì ìš© (ìƒˆë¡œì¶”ê°€ëœì…ê³ ë¦¬ìŠ¤íŠ¸)
	                     updateVat(row.rowKey);
	                 }
	             });
	         }, 10);
	     }
	 });
	//ë¶€ê°€ì„¸ ì²´í¬ ë°•ìŠ¤ í•˜ë‚˜ë§Œ ì ìš© ë˜ë„ë¡ 
	 document.getElementById("vatChecked").addEventListener("click", function () {
	     if (this.checked) {
	         document.getElementById("vatUnchecked").checked = false;
	         setTimeout(() => {
	             warehousinglistGrid.getData().forEach(row => {
	                 if (!row.purchaseBodyNum) { // âœ… purchaseBodyNumì´ ì—†ê±°ë‚˜ nullì¸ ê²½ìš°ë§Œ ì ìš©
	                     updateVat(row.rowKey);
	                 }
	             });
	         }, 10);
	     }
	 });

	 // âœ… VAT ì ìš© í•¨ìˆ˜ (purchaseBodyNumì´ ì—†ëŠ” ê²½ìš°ë§Œ ì ìš©)
	 function updateVat(rowKey) {
	     const applyVat = document.getElementById("vatChecked").checked;

	     let supplyPrice = removeCommas(warehousinglistGrid.getValue(rowKey, "warehousingSupplyPrice")) || "0";
	     let vat = applyVat ? supplyPrice * 0.1 : 0;

	     // âœ… ë¶€ê°€ì„¸ ì—…ë°ì´íŠ¸ (ì½¤ë§ˆ í¬í•¨)
	     warehousinglistGrid.setValue(rowKey, "warehousingVat", vat);

	     console.log(`âœ… VAT ì ìš© (rowKey: ${rowKey}, applyVat: ${applyVat}) â†’ ë¶€ê°€ì„¸: ${vat}`);
	 }

	
	// âœ… ê·¸ë¦¬ë“œ ë³€ê²½ ê°ì§€ ì´ë²¤íŠ¸ ì¶”ê°€ (ìˆ˜ëŸ‰, ë‹¨ê°€ ë³€ê²½ ì‹œ ìë™ ê³„ì‚°)
	 warehousinglistGrid.on("afterChange", function (ev) {
	     ev.changes.forEach(change => {
	         if (change.columnName === "warehousingStandardQuantity" || change.columnName === "warehousingUnitPrice") {
	             console.log(`ğŸ“¢ ë³€ê²½ ê°ì§€ (rowKey: ${change.rowKey}, column: ${change.columnName}, value: ${change.value})`);
	             calculateSupplyPrice(change.rowKey);
	         }
	     });
	 });
	

		 
	 const bttAdd = document.getElementById("bttAdd");
	    if (bttAdd) {
	        bttAdd.addEventListener("click", function () {
	            warehousinglistGrid.appendRow({isManualInput: true}, { at: 0 }); // ë¹ˆ í–‰ ì¶”ê°€
	        });
	    }
	    

	    // âœ… ğŸ”¥ `warehousingGrid` í´ë¦­ ì´ë²¤íŠ¸ ë“±ë¡ (ìƒí’ˆëª…, ì˜µì…˜ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°)
	    warehousinglistGrid.on("click", function (ev) {
	        console.log("ğŸ“¢ `warehousingGrid` í´ë¦­ ê°ì§€ë¨:", ev);

	        if (ev && ev.columnName) {
	            console.log("ğŸ“¢ í´ë¦­ëœ ì—´:", ev.columnName);
	            if (["goodsName", "goodsCode", "optionName", "optionCode"].includes(ev.columnName)) {
	                console.log("âœ… ìƒí’ˆ/ì˜µì…˜ í´ë¦­ ì´ë²¤íŠ¸ ê°ì§€ë¨! rowKey:", ev.rowKey);
	                openGoodsModal(ev.rowKey);
	            }
	        } else {
	            console.warn("âš ï¸ `ev` ê°ì²´ ë˜ëŠ” `ev.columnName`ì´ ì •ì˜ë˜ì§€ ì•ŠìŒ.");
	        }
	    });

	    console.log("âœ… `warehousingGrid` ì´ˆê¸°í™” ì™„ë£Œ ë° í´ë¦­ ì´ë²¤íŠ¸ ë“±ë¡ë¨");
	    
	    
	document.getElementById("warehousingInsert").addEventListener("click",function(){
			warehousingRegister();
		})
	    
  }

  function initWarehouseModal() {
	    console.log("âœ… ì°½ê³  ëª¨ë‹¬ ì´ë²¤íŠ¸ ì´ˆê¸°í™”");

	    const modalElement = document.getElementById("warehouseModal");

	    if (!modalElement) {
	        console.error("âŒ warehouseModal ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
	        return;
	    }

	    modalElement.addEventListener("shown.bs.modal", function () {
	        console.log("ğŸ“¢ ì°½ê³  ëª¨ë‹¬ì´ ì—´ë ¸ìŠµë‹ˆë‹¤. ê·¸ë¦¬ë“œ ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰");

	        if (typeof warehouseGrid !== "undefined" && warehouseGrid !== null) {
	            console.log("ğŸ“¢ ì°½ê³  ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
	            warehouseGrid.readData(); // ğŸš€ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
	            warehouseGrid.refreshLayout();
	        } else {
	            console.warn("âŒ warehouseGridê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì´ˆê¸°í™” ì‹œë„");
	            initWarehouseGrid(); // ğŸš€ ê·¸ë¦¬ë“œ ì¬ì´ˆê¸°í™”
	        }
	    });

	    // ì°½ê³  ì„ íƒ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (table row í´ë¦­)
	    document.addEventListener("click", function (event) {
	        const selectedRow = event.target.closest("tr.select-warehouse"); // âœ… ê°€ì¥ ê°€ê¹Œìš´ `tr.select-warehouse` ì°¾ê¸°

	        if (selectedRow) {
	            const warehouseId = selectedRow.getAttribute("data-id");
	            const warehouseName = selectedRow.getAttribute("data-name");

	            if (warehouseId && warehouseName) {
	                console.log(`âœ… ì„ íƒí•œ ì°½ê³ : ID=${warehouseId}, ì´ë¦„=${warehouseName}`);

	                // âœ… ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
	                sessionStorage.setItem("selectedWarehouseId", warehouseId);
	                sessionStorage.setItem("selectedWarehouseName", warehouseName);

	                // âœ… ì…ë ¥ í•„ë“œì— ê°’ ì„¤ì •
	                document.getElementById("warehouseId").value = warehouseId;
	                document.getElementById("warehouseName").value = warehouseName;

	                // âœ… ëª¨ë‹¬ ë‹«ê¸°
	                const modalInstance = bootstrap.Modal.getInstance(modalElement);
	                if (modalInstance) {
	                    modalInstance.hide();
	                }
	            } else {
	                console.warn("âŒ ì°½ê³  ID ë˜ëŠ” ì´ë¦„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
	            }
	        }
	    });

	    // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸
	    modalElement.addEventListener("hidden.bs.modal", function () {
	        console.log("ğŸ“¢ ì°½ê³  ëª¨ë‹¬ì´ ë‹«í˜”ìŠµë‹ˆë‹¤. ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°ì´í„° ë¡œë“œ");

	        const selectedWarehouseId = sessionStorage.getItem("selectedWarehouseId");
	        const selectedWarehouseName = sessionStorage.getItem("selectedWarehouseName");

	        if (selectedWarehouseId && selectedWarehouseName) {
	            console.log(`ğŸ“¢ ì €ì¥ëœ ë°ì´í„° ì ìš©: ID=${selectedWarehouseId}, ì´ë¦„=${selectedWarehouseName}`);

	            // âœ… input ë°•ìŠ¤ì— ê°’ ìë™ ë°˜ì˜
	            document.getElementById("warehouseId").value = selectedWarehouseId;
	            document.getElementById("warehouseName").value = selectedWarehouseName;
				console.log("ì°½ê³ ì•„ì´ë””í™•ì¸==",document.getElementById("warehouseId").value)
	            // âœ… ì €ì¥ëœ ê°’ ì œê±° (í•œ ë²ˆ ì ìš© í›„ ì‚­ì œ)
	            sessionStorage.removeItem("selectedWarehouseId");
	            sessionStorage.removeItem("selectedWarehouseName");
	        }
	    });
	}
  

  
//âœ… êµ¬ë§¤ë¦¬ìŠ¤íŠ¸ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì‹œ ì²´í¬ëœ ë°œì£¼ì„œ ë°ì´í„°ë¥¼ êµ¬ë§¤ ìƒì„¸ ë¦¬ìŠ¤íŠ¸ë¡œ ì´ë™

	function moveToPurchaseDetail() {
	    console.log("ğŸ“¢ êµ¬ë§¤ë¦¬ìŠ¤íŠ¸ì¶”ê°€ ë²„íŠ¼ í´ë¦­ë¨");
	
	    // âœ… ë°œì£¼ì„œ ëª©ë¡ì—ì„œ ì²´í¬ëœ í•­ëª© ê°€ì ¸ì˜¤ê¸°
	    let checkedRows = purchaselistGrid.getCheckedRows();
		console.log("âœ… ì„ íƒëœ í–‰ ë°ì´í„°:", checkedRows);
		
		if (!checkedRows || checkedRows.length === 0) {
		    console.warn("âš ï¸ ì„ íƒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
		    showAlert('ì´ë™í•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.', 'danger');
		    return;
		}
	    console.log("âœ… ì„ íƒëœ í–‰ ë°ì´í„°:", checkedRows);
	    
	    
	
	    // âœ… `warehousinglistGrid`ê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì´ˆê¸°í™”
	    if (!warehousinglistGrid) {
	        console.warn("âŒ `warehousinglistGrid`ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì´ˆê¸°í™” ì‹œë„!");
	        initwarehousingGrid();  // âœ… ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
	    }
	    
	    if (checkedRows.length === 0) {
	        console.warn("âš ï¸ ì„ íƒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê·¸ë¦¬ë“œ ì¶”ê°€ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤.");
	        return;
	    }
	
	 	console.log(checkedRows);
	
	    // âœ… ì„ íƒëœ ë°ì´í„° êµ¬ë§¤ ìƒì„¸ ë¦¬ìŠ¤íŠ¸(warehousinglistGrid)ì— ì¶”ê°€
	  checkedRows.forEach(row => {
		    warehousinglistGrid.appendRow({
		        goodsCode: row.goodsCode || "", 
		        goodsName: row.goodsName || "", 
		        purchaseBodyNum: row.purchaseBodyNum || "",
		        optionCode: row.optionCode || "", 
		        optionName: row.optionName || "", 
		        optionNum: row.optionNum,
		        vendorName: row.vendorName || "",
		        vendorId: row.vendorId || "",
		        goodsStandard: row.goodsStandard || "",
		        warehousingStandardQuantity: row.nonWarehousingNum || 1, 
		        warehousingUnitPrice: row.purchaseUnitPrice || 0,
		        warehousingSupplyPrice: row.purchaseSupplyPrice || 0,
		        warehousingVat: row.purchaseVat || 0,
		        isManualInput: true
		    });
		});

	
	    console.log("âœ… êµ¬ë§¤ ìƒì„¸ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ ì™„ë£Œ");
	    
	    // âœ… ë¶€ê°€ì„¸ ì ìš©
	    //applyVatToAllRows();
	    
  
	}
	
//ìƒí’ˆëª¨ë‹¬
	
let selectedRowKey = null; // âœ… ì„ íƒí•œ í–‰(rowKey) ì €ì¥ìš© ë³€ìˆ˜
// âœ… ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜
function openGoodsModal(rowKey) {
    console.log("ğŸ“¢ ì„ íƒí•œ í–‰(rowKey):", rowKey);

    let modalElement = document.getElementById('goodsModal');

    if (!modalElement) {
        console.error("âŒ ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    // âœ… Bootstrap Modal ì¸ìŠ¤í„´ìŠ¤ ê°€ì ¸ì˜¤ê¸° (getInstance ëŒ€ì‹  new Modal ì‚¬ìš©)
    let modalInstance = new bootstrap.Modal(modalElement);

    // âœ… ëª¨ë‹¬ í‘œì‹œ
    modalInstance.show();

    console.log("ğŸ“¢ ìƒí’ˆ ì¡°íšŒ ëª¨ë‹¬ ì—´ë¦¼:", rowKey);

    // âœ… productGridê°€ ì •ì˜ë˜ì—ˆëŠ”ì§€ í™•ì¸ í›„ ì‹¤í–‰
    if (typeof productGrid !== 'undefined' && productGrid !== null) {
        setTimeout(() => {
            productGrid.refreshLayout();
            console.log("ğŸ“¢ ìƒí’ˆ ì¡°íšŒ ê·¸ë¦¬ë“œ ë¦¬í”„ë ˆì‹œ ì‹¤í–‰ë¨");
        }, 500);
    } else {
        console.warn("âŒ productGridê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    }
}


// âœ… ëª¨ë‹¬ì´ ì™„ì „íˆ ì—´ë¦° í›„ ë™ì‘
document.getElementById('goodsModal').addEventListener('shown.bs.modal', function () {
	    console.log("ğŸ“¢ ìƒí’ˆ ì¡°íšŒ ëª¨ë‹¬ì´ ì™„ì „íˆ ì—´ë¦¼");

	    if (typeof productGrid !== 'undefined' && productGrid !== null) {
	        setTimeout(() => {
	            productGrid.refreshLayout();
	            console.log("ğŸ“¢ ìƒí’ˆ ì¡°íšŒ ê·¸ë¦¬ë“œ ë¦¬í”„ë ˆì‹œ ì‹¤í–‰ë¨");
	        }, 500);
	    } else {
	        console.warn("âŒ productGridê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
	    }
	});
	
	// âœ… ëª¨ë‹¬ ë‹«í ë•Œ sessionStorage ê°’ ê°€ì ¸ì™€ì„œ ê·¸ë¦¬ë“œì— ì €ì¥
function setupModalCloseEvent() {
    console.log("âœ… ëª¨ë‹¬ ë‹«í˜ ì´ë²¤íŠ¸ ì‹¤í–‰");

    let focusedCell = warehousinglistGrid.getFocusedCell();
    if (!focusedCell || focusedCell.rowKey === undefined) {
        console.warn("âŒ ë¨¼ì € í–‰ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.");
        return;
    }

    const rowKey = focusedCell.rowKey;

    // âœ… sessionStorageì˜ keyì™€ ê·¸ë¦¬ë“œì˜ nameì„ ë§¤ì¹­
    const dataMap = {
        selectedGoodsCode: "goodsCode",
        selectedGoodsName: "goodsName",
        selectedOptionCode: "optionCode",
        selectedOptionName: "optionName",
        selectedOptionNum : "optionNum",
        selectedOptionNum: "optionNum",
        selectedVendorName: "vendorName",
        selectedVendorId: "vendorId",
        selectedGoodsStandard: "goodsStandard",
        selectedGoodsSupplyPrice: "warehousingUnitPrice"
    };

    Object.keys(dataMap).forEach(storageKey => {
        const gridColumn = dataMap[storageKey];
        const value = sessionStorage.getItem(storageKey);
        if (value) {
            warehousinglistGrid.setValue(rowKey, gridColumn, value);
            sessionStorage.removeItem(storageKey); // âœ… ì‚¬ìš©í•œ ë°ì´í„° ì‚­ì œ
        }
    });

    console.log("âœ… ë°œì£¼ ê·¸ë¦¬ë“œì— ë°ì´í„° ì €ì¥ ì™„ë£Œ");
}

//êµ¬ë§¤ë“±ë¡ í•¨ìˆ˜
function warehousingRegister(){
	 const warehouseIdElement = document.getElementById("warehouseId");
	
	if (!warehouseIdElement) {
        console.error("âŒ `warehouseId` ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    const warehouseIdInput = warehouseIdElement.value;
    console.log("âœ… ì°½ê³  ID í™•ì¸:", warehouseIdInput);

    if (!warehouseIdInput) {
        console.error("âŒ ì°½ê³  IDê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. ì°½ê³ ë¥¼ ì„ íƒí–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.");
        alert("ì°½ê³ ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.");
        return;
    }
	
	// âœ… ì²´í¬ëœ í–‰ì˜ ê·¸ë¦¬ë“œ ê°’ë§Œ ê°€ì ¸ì˜¤ê¸°
    const gridData = warehousinglistGrid.getCheckedRows();
    if (gridData.length === 0) {
        alert("ì…ê³ í•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }
 	// âœ… ê±°ë˜ì²˜ ID ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹í™”
    const groupedData = {};
    gridData.forEach((item) => {
        const vendorId = parseInt(item.vendorId) || 0;
        
        if (!groupedData[vendorId]) {
            groupedData[vendorId] = {
                employeeNum: parseInt(document.getElementById("employeeNum").value),
                companyNum: parseInt(document.getElementById("companyNum").value),
                vendorId: vendorId,
                files: []
            };
        }
        
        // âœ… orderPlanBodyNumì´ ì—†ìœ¼ë©´ null ì²˜ë¦¬
        const purchaseBodyNum = item.purchaseBodyNum;

        // âœ… ë°œì£¼ì„œ ë°”ë”” ì¶”ê°€ (ìˆ«ìë¡œ ë³€í™˜)
        groupedData[vendorId].files.push({
        	optionNum: parseInt(item.optionNum)||0,
        	manufactureDate: item.manufactureDate,
        	warehousingStandardQuantity: parseInt(item.warehousingStandardQuantity)||0,
        	warehousingUnitPrice: parseInt(item.warehousingUnitPrice)||0,
            warehousingSupplyPrice: item.warehousingSupplyPrice,
            warehousingVat: item.warehousingVat,
            goodsStandard: item.goodsStandard,
            warehouseId: parseInt(document.getElementById("warehouseId").value)||0,
            purchaseBodyNum: (typeof purchaseBodyNum === 'string' ? parseInt(purchaseBodyNum.replace(/,/g, '')) : purchaseBodyNum) || null

           
           
        });
    });
    
 // groupedDataë¥¼ ë°°ì—´ë¡œ ë³€í™˜ (ê° ê·¸ë£¹ë³„ ë°œì£¼ ë°ì´í„°)
    const warehousingArray = Object.values(groupedData);
    console.log("ì„œë²„ë¡œ ì „ì†¡í•  ë°ì´í„°:", warehousingArray);
    
 // CSRF í† í° ë° í—¤ë” ì •ë³´ (meta íƒœê·¸ì—ì„œ ë¯¸ë¦¬ ì½ì–´ì˜´)
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
    const csrfToken = document.querySelector('meta[name="_csrf"]').content;

    // ì»¨íŠ¸ë¡¤ëŸ¬ì˜ ì—”ë“œí¬ì¸íŠ¸ë¡œ POST ìš”ì²­ ì „ì†¡ (ì˜ˆ: /purchs/rest/purchase/insert)
    fetch("/purchs/rest/warehouse/insert", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            [csrfHeader]: csrfToken
        },
        body: JSON.stringify(warehousingArray)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            showAlert("ì…ê³  ë“±ë¡ ì„±ê³µ", "success");
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert("ì…ê³  ë“±ë¡ ì‹¤íŒ¨", "danger");
        }
    })
    .catch(error => {
        console.error("ì…ê³  ë“±ë¡ ì˜¤ë¥˜:", error);
        showAlert("ì„œë²„ ì˜¤ë¥˜: " + error, "danger");
    });


}
	







  
</script>

</body>

