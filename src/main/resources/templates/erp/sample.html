<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- âœ… Balham í…Œë§ˆ ìŠ¤íƒ€ì¼ ì ìš© -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@33.0.4/styles/ag-grid.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@33.0.4/styles/ag-theme-balham.css">
  <!-- ag-Grid ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@33.0.4/dist/ag-grid-community.min.js"></script>

  <title>ì˜í™”ì •ë³´</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <style>
    .movieCd {
      cursor: pointer;
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="alert alert-primary">
      <h3 class="text-center">ì¼ë³„ ë°•ìŠ¤ì˜¤í”¼ìŠ¤</h3>
    </div>
    <div>
      <input type="date" class="form-controll">
      <button type="button">ì¡°íšŒ</button>
    </div>
    <div class="row gx-5">
      <div class="col-md-6">
        <table class="table table-striped table-sm">
          <thead>
            <tr>
              <td>ë­í‚¹</td>
              <td>ì˜í™”ì½”ë“œ</td>
              <td>ì˜í™”ëª…</td>
              <td>ê°œë´‰ì¼ì</td>
            </tr>
          </thead>
          <tbody id="list"></tbody>
        </table>
      </div>
      <div class="col-md-6">
        <div class="row mb-4">
          <label class="col-md-3 col-form-label">ì˜í™”ì½”ë“œ</label>
          <div class="col-md-9">
            <input class="form-control" id="txtMovieCd">
          </div>
        </div>
        <div class="row mb-4">
          <label class="col-md-3 col-form-label">ì˜í™”ëª…</label>
          <div class="col-md-9">
            <input class="form-control" id="movieNm">
          </div>
        </div>
        <div class="row mb-4">
          <label class="col-md-3 col-form-label">ê°œë´‰ì¼ì</label>
          <div class="col-md-9">
            <input class="form-control" id="openDt">
          </div>
        </div>
        <div class="row mb-4">
          <label class="col-md-3 col-form-label">ê°ë…</label>
          <div class="col-md-9">
            <input class="form-control" id="directors">
          </div>
        </div>
        <div class="row mb-4">
          <label class="col-md-3 col-form-label">ì¶œì—°ë°°ìš°</label>
          <div class="col-md-9">
            <textarea class="form-control" style="height: 130px;" id="actors"></textarea>
          </div>
        </div>
      </div>
    </div>

    <div>
      <!-- âœ… í…Œë§ˆë¥¼ balhamìœ¼ë¡œ ë³€ê²½ -->
      <div id="myGrid" class="ag-theme-balham" style="width: 600px; height: 400px;"></div>
    </div>
  </div>
</body>
<script>


  //ê·¸ë¦¬ë“œ ë°ì´í„° ì „ì—­ ë³€ìˆ˜ë¡œ ì„¤ì •
  // âœ… ì´ˆê¸° ë°ì´í„° (API ìš”ì²­ ì „)
  //var rowData = [
  //  { rank: "Tesla", moviecd: "Model Y", movienm: 64950, opendt: true },
  //  { rank: "Toyota", moviecd: "Corolla", movienm: 29600, opendt: false }
  //];
  // âœ… ag-Grid ì„¤ì •
  const gridOptions = {
    columnDefs: [
      { headerName: "ë­í‚¹", field: "rank", sortable: true, filter: true },
      { headerName: "ì˜í™”ì½”ë“œ", field: "moviecd", sortable: true, filter: true },
      { headerName: "ì˜í™”ëª…", field: "movienm", sortable: true, filter: true },
      { headerName: "ê°œë´‰ì¼ì", field: "opendt", sortable: true, filter: true }
    ],
    rowData: [], // âœ… ì´ˆê¸° ë°ì´í„° ì„¤ì • // ê¸°ì´ˆ ì…‹íŒ…ì´ í•„ìš”í•˜ë©´ rowDataë¡œ í•´ì„œ ê°’ ë„£ìœ¼ë©´ë¨
    pagination: true,
    theme: "legacy",
    pagination: true, // âœ… í˜ì´ì§€ ë„¤ì´ì…˜ í™œì„±í™”
    paginationPageSize: 5, // âœ… ê¸°ë³¸ í˜ì´ì§€ í¬ê¸° (5ê°œì”©)
    paginationPageSizeSelector: [5, 10, 25, 50], // âœ… í˜ì´ì§€ í¬ê¸° ì„ íƒ ì˜µì…˜
    domLayout: "autoHeight",  // âœ… ë†’ì´ ìë™ ì¡°ì •
    suppressHorizontalScroll: false,  // âœ… ê°€ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš©
    defaultColDef: {
      resizable: true,  // âœ… ì»¬ëŸ¼ í¬ê¸° ì¡°ì • ê°€ëŠ¥
    },
    //í•´ë‹¹ apië¥¼ ì˜¨ë ˆë’¤ ì‹œí‚¤ê³  ë°ì´í„° ë„£ëŠ”ê³³ì—ì„œ ë„£ì–´ì„œ ì“°ë©´ë¨
    onGridReady: function (params) {
      console.log("âœ… Grid Ready! API Initialized.");
      gridOptions.api = params.api; // âœ… ag-Gridê°€ ì¤€ë¹„ëœ í›„ API ì €ì¥
      gridOptions.api.sizeColumnsToFit(); // âœ… ìë™ í¬ê¸° ë§ì¶¤ [ ì´ê±°í•˜ë©´ ê°€ë¡œ ìŠ¤í¬ë¡¤ ì—†ì–´ì§ ]
    },
    // ê·¸ë¦¬ë“œì…€ í´ë¦­ ì´ë²¤íŠ¸
    onCellClicked: function (event) { // âœ… ì…€ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
        
    	//alert(`í´ë¦­í•œ ì…€ ê°’: ${event.value}`); // í´ë¦­í•œ ì…€ì˜ ê°’ ì¶œë ¥
        
        let rowData = event.data; // âœ… í´ë¦­í•œ í–‰ì˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        //alert(`í´ë¦­í•œ í–‰ì˜ ë°ì´í„°:\n${JSON.stringify(rowData, null, 2)}`); // âœ… ì „ì²´ í–‰ ë°ì´í„° ì¶œë ¥
        
        //í•´ì•¼í• ê»˜ ë§ì•„ì„œ ì´ê±´ rest ì•ˆí•¨ ëŒ€ëµ ëŠë‚Œì•„ë‹ˆê¹Œ
        movieInfo(rowData.moviecd);
    }
  };



  document.addEventListener("DOMContentLoaded", function () {
    // âœ… ag-Grid ì´ˆê¸°í™”
    const gridDiv = document.querySelector("#myGrid");
    agGrid.createGrid(gridDiv, gridOptions);



    //ì–´ì œ
    let date2 = new Date();
    date2.setDate(date2.getDate() - 1);
    let year2 = date2.getFullYear();
    let month2 = ('0' + (date2.getMonth() + 1)).slice(-2);
    let day2 = ('0' + date2.getDate()).slice(-2);
    let yesterday = year2 + '-' + month2 + '-' + day2;
    console.log(yesterday);
    document.querySelector(".form-controll").value = yesterday;
    const targetDt = year2 + month2 + day2;

    //rest ì¼ì¼ ì˜í™” í˜¸ì¶œ
    restdailyBoxOfficeList(targetDt);

    //ë²„íŠ¼í´ë¦­í–ˆì„ë•Œ í•´ë‹¹ë‚ ì§œë¡œ ì¡°íšŒ
    document.querySelector("button").addEventListener("click", function () {
      if (event.target.innerHTML == "ì¡°íšŒ") {
        //ì˜¤ëŠ˜
        let date = new Date();
        let year = date.getFullYear();
        let month = ('0' + (date.getMonth() + 1)).slice(-2); // MM
        let day = ('0' + (date.getDate())).slice(-2);	// DD
        let today = year + '-' + month + '-' + day;
        //console.log(today);
        if (event.target.previousElementSibling.value >= today) {
          alert('ì˜¤ëŠ˜ ë‚ ì§œ ë° ë¯¸ë˜ì˜ ë‚ ì§œëŠ” ê²€ìƒ‰ ë¶ˆê°€í•©ë‹ˆë‹¤');
        } else {
          alert('ê²€ìƒ‰ ì¤‘ ì…ë‹ˆë‹¤ ì˜¤ë˜ê±¸ë¦½ë‹ˆë‹¤');
          searchDate = event.target.previousElementSibling.value.replace(/-/g, "");
          console.log(searchDate);
          //rest ì¼ì¼ ì˜í™” í˜¸ì¶œ
          restdailyBoxOfficeList(searchDate);
        }
      }
    });

  });

  //rest ì¼ì¼ ì˜í™” í˜¸ì¶œ
  function restdailyBoxOfficeList(targetDt) {
    const url = `/erp/rest/${targetDt}`;
    console.log(url);
    fetch(url, {
      method: "get",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then(result => result.json())
      .then(result => {
        console.log(result);
        movieView(result);
      })
  }

  function movieView(data) {
    console.log('restdailyBoxOfficeList=result => ' + data);
    list.innerHTML = '';
    data.list.forEach(ele => {
      console.log(ele)
      let movieList = '<tr>';
      movieList += `<td>${ele.rank}</td>`;
      movieList += `<td>${ele.moviecd}</td>`;
      movieList += `<td>${ele.movienm}</td>`;
      movieList += `<td>${ele.opendt}</td>`;
      movieList += `</tr>`;
      list.insertAdjacentHTML("beforeend", movieList);
    });

    if (gridOptions.api) {

      //ê·¸ë¦¬ë“œ ë‚´ë¶€ ë°ì´í„° ì‚­ì œí›„ ê¹¨ë—í•œ ê³µê°„ì²˜ë¦¬ í•˜ê¸°ìœ„í•œë°©ë²•
      let allRows = [];
      gridOptions.api.forEachNode(node => allRows.push(node.data)); // ëª¨ë“  í–‰ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´
      gridOptions.api.applyTransaction({ remove: allRows }); // âœ… ê¸°ì¡´ ë°ì´í„° ì‚­ì œ

      //ê·¸ë¦¬ë“œì— ê°’ ë°€ì–´ë„£ê¸°
      gridOptions.api.applyTransaction({ add: data.list }); // ìƒˆë¡œìš´ ë°ì´í„° ì¶”ê°€
    } else {
      console.error("ğŸš¨ Grid APIê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    }

  }



  document.querySelector("table").addEventListener("click", function () {
    //alert(event.target.parentElement.children[1].innerHTML);
    movieInfo(event.target.parentElement.children[1].innerHTML);
  });


  //ì˜í™” ì •ë³´
  //http://www.kobis.or.kr/kobisopenapi/webservice/rest/movie/searchMovieInfo.json?key=12664b24453335d2c3eca0fdc4b3b013&movieCd=20233006
  function movieInfo(movieCd) {
    const key = '12664b24453335d2c3eca0fdc4b3b013';

    console.log(key + " " + movieCd);
    const proxyUrl = "https://api.allorigins.win/get?url=";
    //ì¼ë³„ ë°•ìŠ¤ ì˜¤í”¼ìŠ¤
    const url = encodeURIComponent("http://www.kobis.or.kr/kobisopenapi/webservice/rest/movie/searchMovieInfo.json?key=" + key + "&movieCd=" + movieCd);
    console.log(url);
    fetch(proxyUrl + url, {
      method: "get",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then(result => result.json())
      .then(result => infoMovie(JSON.parse(result.contents)))
    //contents json ì†ì„±ê°’ì„!!!
  }

  function infoMovie(data) {
    txtMovieCd.value = data.movieInfoResult.movieInfo.movieCd;
    movieNm.value = data.movieInfoResult.movieInfo.movieNm;
    openDt.value = data.movieInfoResult.movieInfo.openDt;
    directors.value = data.movieInfoResult.movieInfo.directors[0].peopleNm + " (" + data.movieInfoResult.movieInfo.directors[0].peopleNmEn + ")";
    movieActors = data.movieInfoResult.movieInfo.actors;
    let actorsList = '';
    movieActors.forEach(ele => {
      actorsList += `${ele.peopleNm} ${ele.peopleNmEn == '' ? "" : `(${ele.peopleNmEn})`}\n`;
    });
    actors.value = actorsList.trim();
  }

</script>
<style>
  /* ğŸ”¹ í—¤ë”ì˜ í•„í„° ì•„ì´ì½˜ ê°•ì œ ìˆ¨ê¸°ê¸° */
  .ag-icon-filter {
    display: none !important;
  }
</style>

</html>