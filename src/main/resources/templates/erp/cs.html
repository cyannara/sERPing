<!DOCTYPE html>
<!-- =======================================================
	* ERPí™ˆí˜ì´ì§€ ë¶ˆíŠ¹ì • ë‹¤ìˆ˜ì˜ ë¬¸ì˜ë¥¼ ê´€ë¦¬í•˜ëŠ” í˜ì´ì§€
	* @author ERP ê´€ë¦¬ì ê°œë°œíŒ€ í‘œí•˜ì—°
	* @since 2025.03.02
	* @version 1.0
	* @see
	*
	* <pre>
	* << ê°œì •ì´ë ¥(Modification Information) >>
	*
	*   ìˆ˜ì •ì¼      ìˆ˜ì •ì          ìˆ˜ì •ë‚´ìš©
	*  ======    =======    ==============================
	*  2025.03.02  í‘œí•˜ì—°          ìµœì´ˆìƒì„±
	*
	*  </pre>
======================================================== -->
<html layout:decorate="~{/erp/layouts/main}">
<div class="container w-100 mw-1600" layout:fragment="content">
	<div class="d-flex justify-content-center">
		<div class="d-flex flex-row mt-3 mb-3">
			<div class="p-2">
				<div class="appendsection2">
					<div class="card">
						<h3 class="card-title">ğŸ“‹ ë¬¸ì˜ ë‚´ì—­</h3>
						<div class="form-check mt-2 p-0"
							style="position: absolute; z-index: 999;">
							<input type="checkbox" class="btn-check" id="okquery"
								autocomplete="off"> <label
								class="btn btn-outline-primary" for="okquery">ë¯¸ë‹µë³€ë§Œ</label>
						</div>
						<div class="service-list">
							<div id="grid"></div>
						</div>
					</div>
				</div>
			</div>
			<div class="p-0">
				<div class="d-flex flex-column mb-3">
					<div class="p-2">
						<div class="appendsection2">
							<div class="card">
								<h3 class="card-title">ğŸ“‹ ë¬¸ì˜ ìƒì„¸</h3>
								<div class="service-list">
									<form class="row g-3">
										<input type="hidden" id="inquiryNum" name="inquiryNum" value="">
										<div class="col-6">
											<label for="companyName" class="form-label m-0">íšŒì‚¬ëª…</label>
											<input type="text" class="form-control" id="companyName" readonly="readonly">
										</div>
										<div class="col-6">
											<label for="chargerEmail" class="form-label m-0">ì´ë©”ì¼</label>
											<input type="email" class="form-control" id="chargerEmail" readonly="readonly">
										</div>
										<div class="col-3 m-0">
											<label for="chargerName" class="form-label m-0">ë‹´ë‹¹ìëª…</label>
											<input type="text" class="form-control" id="chargerName" readonly="readonly">
										</div>
										<div class="col-4 m-0">
											<label for="chargerPhone" class="form-label m-0">ì—°ë½ì²˜</label>
											<input type="tel" class="form-control" id="chargerPhone" readonly="readonly">
										</div>
										<div class="col-5 m-0">
											<label for="inquiryDate" class="form-label m-0">ë¬¸ì˜ì¼ì‹œ</label>
											<input type="text" class="form-control" id="inquiryDate" readonly="readonly">
										</div>
										<div class="col-12 m-0">
											<label for="inquiryContent" class="form-label m-0">ë¬¸ì˜ë‚´ìš©</label>
											<textarea class="form-control overflow-scroll" id="inquiryContent" readonly="readonly"></textarea>
										</div>
										<div class="col-11 m-0">
											<label for="requestquery" class="form-label m-0">ì²˜ë¦¬ë“±ë¡</label>
											<textarea class="form-control overflow-scroll" id="requestquery"></textarea>
										</div>
										<div class="col-1 m-0 pt-4">
											<button type="submit" class="btn btn-primary w-100 h-100 registerbtn">ë“±ë¡</button>
										</div>
									</form>
								</div>
							</div>
						</div>
					</div>
					<div class="ps-2 pe-2">
						<div class="appendsection2">
							<div class="card overflow-scroll" style="height:410px;">
								<h3 class="card-title">ğŸ“‹ ì²˜ë¦¬ ê¸°ë¡</h3>
								<div class="service-list requestlst"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script th:inline="javascript">
	//í´ë¦­í•œ í–‰ì˜ ì •ë³´ë¥¼ ë‹´ëŠ” ì „ì—­ ë³€ìˆ˜
	var rowData = false;
	//í˜„ì¬ ê·¸ë¦¬ë“œì— ê°•ì¡°ëœí–‰ì„ ê¸°ë¡í•  ë³€ìˆ˜
	let selectedRowKey = null;
	//ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì •ë³´
	let employeeNum = ErpEmployeeInfo.employeeNum;
	//í˜ì´ì§€ ë¡œë“œí›„ ì²˜ë¦¬í•  ì´ë²¤íŠ¸ë“¤
	document.addEventListener("DOMContentLoaded", function() {
	});
	
	//ê·¸ë¦¬ë“œ ì„ ì–¸
	var Grid = tui.Grid;
	const dataSource = {
		api : {
			readData: { url: '/erp/rest/usecslist', method: 'GET'},
		},
		contentType : 'application/json',
	};

	//ê·¸ë¦¬ë“œ ìƒì„±
	const grid = new Grid({
		el : document.getElementById('grid'), // ì»¨í…Œì´ë„ˆ ì—˜ë¦¬ë¨¼íŠ¸
		scrollX: false,
	    scrollY: false,
	    minBodyHeight: 680,
	    columnOptions: {
	        resizable: true
	    },
		pageOptions : {
			useClient : false, //í˜ì´ì§€ ë„¤ì´ì…˜ í• êº¼ë©´ false // ìë™ìœ¼ë¡œ í•˜ê²Œí• ê»´ë©´ true
			perPage : 17, //í•œí˜ì´ì§€ì— ëª‡ê°œ ë³´ì—¬ì¤„ì§€
		},
		//ì¹¼ëŸ¼ ì •í•˜ê¸°
		columns: [
			{ header: "ë²ˆí˜¸", name: "inquiryNum", editor: 'text', align: "center", width: "50" },
			{ header: "íšŒì‚¬ëª…", name: "companyName", editor: 'text', align: "center" },
			{ header: "ë‹´ë‹¹ìëª…", name: "chargerName", editor: 'text', align: "center", width: "100" },
			{ header: "ë‹´ë‹¹ìì—°ë½ì²˜", name: "chargerPhone", editor: 'text', align: "center", width: "120" },
			//{ header: "ì´ë©”ì¼", name: "chargerEmail", editor: 'text', align: "center", width: "200" },
			//{ header: "ë¬¸ì˜ë‚´ìš©", name: "inquiryContent", editor: 'text', align: "center" },
			{ header: "ë“±ë¡ì¼", name: "inquiryDate", editor: 'text', align: "center", width: "150",
				formatter: function({ value }) {
					return subscriptday(value);
			    },
			},
			{ header: "ì²˜ë¦¬ì—¬ë¶€", name: "cntInquiry", editor: 'text', align: "center", width: "100",
				formatter: function({ value }) {
					if(value >= 1){
						return `ì²˜ë¦¬ì™„ë£Œ`;
					}else{
						return `ë¯¸ì²˜ë¦¬`;
					}
			    },
			},
		],
		//ì´ˆê¸° ë°ì´í„° ë­˜ë¡œ í• ì§€
		data : dataSource,
	});
	
	//í–‰ì„ íƒ
	grid.on('click', function (ev) {
		if (ev.rowKey !== null) {
			//í˜„ì¬ ê°•ì¡°ëœ í–‰ í´ë˜ìŠ¤ ì´ˆê¸°í™”
			if (selectedRowKey !== null) {
	            grid.removeRowClassName(selectedRowKey, 'tui-grid-row-highlight');
	        }
			// í´ë¦­í•œ í–‰ì— ê°•ì¡° íš¨ê³¼ ì¶”ê°€
			grid.addRowClassName(ev.rowKey, 'tui-grid-row-highlight');
			 // í˜„ì¬ ê°•ì¡°ëœ í–‰ì„ ê¸°ë¡
	        selectedRowKey = ev.rowKey;
			
			rowData = grid.getRow(ev.rowKey);
			//console.log(`í´ë¦­í•œ í–‰ ë°ì´í„°:\n${JSON.stringify(rowData, null, 2)}`);
			
			document.querySelector("#inquiryNum").value = rowData.inquiryNum;
			document.querySelector("#companyName").value = rowData.companyName;
			document.querySelector("#chargerName").value = rowData.chargerName;
			document.querySelector("#chargerPhone").value = rowData.chargerPhone;
			document.querySelector("#chargerEmail").value = rowData.chargerEmail;
			document.querySelector("#inquiryContent").value = rowData.inquiryContent;
			document.querySelector("#inquiryDate").value = subscriptday(rowData.inquiryDate);
			
			requesthistory(rowData.inquiryNum);
		}
	});
	
	//ì²˜ë¦¬ê¸°ë¡ í•¨ìˆ˜
	function requesthistory(number){
		document.querySelector(".requestlst").innerHTML = '';
		const url = `/erp/rest/requestlist/`+number;
		fetch(url, {
			method:"get",
			headers: {
				"Content-Type": "application/json",
			},
		})
		.then(result => result.json())
		.then(result => {
			if (Array.isArray(result) && result.length > 0) {
			    result.forEach(ele => {
			        let cstag = `
			            <div class="p-2 mb-2">
			                <table id="answerTable">
			                    <tr>
			                        <th style="width:100px;height:40px;">ì²˜ë¦¬ë²ˆí˜¸</th>
			                        <td style="width:70px;">${ele.answerNum || "N/A"}</td>
			                        <th style="width:100px;">ì²˜ë¦¬ë‹´ë‹¹ì</th>
			                        <td style="width:70px;">${ele.employeeName || "N/A"}</td>
			                        <th style="width:100px;">ì²˜ë¦¬ì¼ì‹œ</th>
			                        <td>${ele.answerDate ? subscriptday(ele.answerDate) : "N/A"}</td>
			                    </tr>
			                    <tr>
			                        <th>ì²˜ë¦¬ë‚´ìš©</th>
			                        <td class="p-3" colspan="5">
			                            ${ele.answerContent ? ele.answerContent.replace(/\n/g, '<br>') : "ë‚´ìš© ì—†ìŒ"}
			                        </td>
			                    </tr>
			                </table>
			            </div>
			        `;
			        document.querySelector(".requestlst").insertAdjacentHTML("beforeend", cstag);
			    });
			} else {
			    let emptyCstag = `
			        <div class="p-2 mb-2">
			            <table id="answerTable">
			                <tr>
			                    <th style="width:100px;height:40px;">ì²˜ë¦¬ë²ˆí˜¸</th>
			                    <td style="width:70px;">N/A</td>
			                    <th style="width:100px;">ì²˜ë¦¬ë‹´ë‹¹ì</th>
			                    <td style="width:70px;">N/A</td>
			                    <th style="width:100px;">ì²˜ë¦¬ì¼ì‹œ</th>
			                    <td>N/A</td>
			                </tr>
			                <tr>
			                    <th>ì²˜ë¦¬ë‚´ìš©</th>
			                    <td class="p-3" colspan="5">ë“±ë¡ëœ ì²˜ë¦¬ì´ ì—†ìŠµë‹ˆë‹¤.</td>
			                </tr>
			            </table>
			        </div>
			    `;
			    document.querySelector(".requestlst").insertAdjacentHTML("beforeend", emptyCstag);
			}
		})
	}
	
	//ë‚ ì§œ ë³€í™˜í•¨ìˆ˜
	function subscriptday(value){
		const utcDate = new Date(value);
		// í•œêµ­ ì‹œê°„(KST)ìœ¼ë¡œ ë³€í™˜ (24ì‹œê°„ í˜•ì‹ ìœ ì§€)
		const options = { 
		    year: 'numeric', month: '2-digit', day: '2-digit',
		    hour: '2-digit', minute: '2-digit', second: '2-digit',
		    hour12: false, timeZone: "Asia/Seoul"
		};
		// `toLocaleString` ì‚¬ìš©í•˜ì—¬ ë³€í™˜ í›„, í¬ë§·ì„ `yyyy-MM-dd HH:mm:ss`ë¡œ ì¡°ì •
		const kstDate = new Intl.DateTimeFormat("ko-KR", options).format(utcDate)
		    .replace(/\./g, '-') // yyyy.MM.dd â†’ yyyy-MM-dd ë¡œ ë³€í™˜
		    .replace(/ /g, '')    // ê³µë°± ì œê±°
		    .trim();
		return kstDate;
	}
	
	//ë¯¸ë‹µë³€ë§Œ ë³´ê¸°
	document.querySelector("#okquery").addEventListener("click",function(){
		if(document.querySelector('#okquery').checked){
			grid.setRequestParams({"okcunt" : "OK"});
			grid.readData();			
		}else{
			grid.setRequestParams({"okcunt" : null});
			grid.readData();
		}
	});
	
	//ì²˜ë¦¬ë“±ë¡ë²„íŠ¼
	document.querySelector(".registerbtn").addEventListener("click", handleSubmit);
	/* document.querySelector("#requestquery").addEventListener("keydown", function (event) {
	    if (event.key === "Enter") {
	        handleSubmit(event);
	    }
	}); */
	function handleSubmit(event) {
	    event.preventDefault(); // ê¸°ë³¸ ë™ì‘(í¼ ì œì¶œ) ë°©ì§€
	    // ë¬¸ì˜ë²ˆí˜¸
	    let inquiryNum = document.querySelector("#inquiryNum").value;
	    if (!inquiryNum) {
	        return;
	    }
	    // ë¬¸ì˜ë‚´ìš©
	    let requestquery = document.querySelector("#requestquery").value;
	    const requestObj = {
	        inquiryNum: parseInt(inquiryNum),
	        answerContent: requestquery,
	        employeeNum: employeeNum,
	    };

		const url = `/erp/rest/registerquest`;
		fetch( url, {
			method : "POST",
			headers: {
				"Content-Type": "application/json",
			},
			body : JSON.stringify(requestObj),
		})
		.then( result => result.text() )
		.then( result => {
			if(result=="OK"){
				requesthistory(inquiryNum);
				grid.reloadData();
				document.querySelector("#requestquery").value = '';
				setTimeout(() => {
		            grid.addRowClassName(selectedRowKey, 'tui-grid-row-highlight');
		        }, 500);
			}else{
			}
		})
	}
	</script>
</div>