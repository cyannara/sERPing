<!DOCTYPE html>
 <!-- =======================================================
 * ERP ì‚¬ìš© íšŒì‚¬ì˜ êµ¬ë… ì •ë³´ë¥¼ í™•ì¸ í•œë‹¤
 * @author ê°œë°œíŒ€ í‘œí•˜ì—°
 * @since 2025.02.20
 * @version 1.0
 * @see
 *
 * <pre>
 * << ê°œì •ì´ë ¥(Modification Information) >>
 *
 *   ìˆ˜ì •ì¼      ìˆ˜ì •ì          ìˆ˜ì •ë‚´ìš©
 *  -------    --------    ---------------------------
 *  2025.02.20  í‘œí•˜ì—°          ìµœì´ˆ ìƒì„±
 *
 *  </pre>
 ======================================================== -->
<html layout:decorate="~{layouts/layout}"
      lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
	<script>
	  // PDF.js ì›Œì»¤ ê²½ë¡œ ì„¤ì •
	  pdfjsLib.GlobalWorkerOptions.workerSrc =
	    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js';
	</script>
</head>
<body layout:fragment="content">
	<style>
		#custom-container{
	        background-color: #f8f9fa; /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ /
	        padding: 20px;
	        border-radius: 10px;
	        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); / ë°•ìŠ¤ ê·¸ë¦¼ì */
	        margin-bottom: 20px;
			font-weight: bold;
			text-align: center;
			font-size: 20px;
	    }
	    /* ê·¸ë¦¬ë“œ ì„ íƒí•˜ë©´ ìƒê¸°ëŠ” ìƒ‰ìƒ */
		.tui-grid-row-highlight {
		    background-color: #f0f8ff !important; /* ì—°í•œ í•˜ëŠ˜ìƒ‰ */
		}
		.pdf-container {
			max-width: 1000px;       /* ìµœëŒ€ ë„ˆë¹„ 800px */
			margin: 0 auto;         /* ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬ */
			justify-content: center;/* ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ (ë‚´ë¶€ ì½˜í…ì¸  ì¤‘ì•™ ë°°ì¹˜) */
			align-items: center;    /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
			height: 600px;          /* ì›í•˜ëŠ” ë†’ì´ (ì˜ˆ: 600px) */
			border: 1px solid #ccc; /* í•„ìš” ì‹œ í…Œë‘ë¦¬ ì¶”ê°€ */
			background-color: #f9f9f9;
			overflow: auto;
		}
		#pdfCanvas {
			width: 100%;
		}
		.modal-dialog {
			max-width: 750px !important;		
		}
		.modal-body {
			padding: 13px !important;
		}
		.card {
		    width: 100%;
		    height: 100%;
		    background-color: #f8f9fa; /* ë°ì€ ë°°ê²½ */
		    padding: 20px;
		    border-radius: 10px;
		    box-shadow: 2px 4px 10px rgba(0, 0, 0, 0.1);
		}
		.card-title {
		    text-align: center;
		    font-size: 30px;
		    font-weight: bold;
		    margin-bottom: 15px;
		}
		.service-list {
		    display: flex;
		    flex-direction: column;
		    gap: 10px;
		}
		.service-item {
		    background: white;
		    padding: 10px;
		    border-radius: 8px;
		    box-shadow: 1px 1px 5px rgba(0, 0, 0, 0.1);
		    font-size: 16px;
		    line-height: 1.6;
		}
		.appendsection2 {
		    display: flex;
		    flex-direction: column; /* ì„¸ë¡œ ì •ë ¬ */
		    align-items: center; /* ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ */
		    justify-content:center;
		    width: 100%;
		    height: 100%;
		}
	</style>
	<div class="container">
		<div class="row">
			<div class="h3 pb-2 mb-2 text-black border-bottom border-secondary">
				êµ¬ë…ì¡°íšŒ
			</div>
			<div class="col-md-6 stretch-card mt-2 mb-2">
				<div class="card">
					<h3 class="card-title">ğŸ“‹ ê²°ì œ ìƒì„¸</h3>
					<div id="subDetailgrid"></div>
				</div>
			</div>
			<div class="col-md-6 stretch-card mt-2 mb-2">
				<div class="appendsection2">
					<div class="card">
						<h3 class="card-title">ğŸ“‹ êµ¬ë… í˜„í™©</h3>
						<div class="service-list">
							<div class="service-item">
								<span>âœ… <strong>sERPing ì„œë¹„ìŠ¤</strong></span>
								<span id="subObj"></span>
								<span id="subObjdate"></span> <span id="subObjdateDay"></span>
							</div>
							<div class="service-item">
								<span>âœ… <strong>ê·¸ë£¹ì›¨ì–´ ì„œë¹„ìŠ¤</strong></span>
								<span id="gpOption"></span>
								<span id="groupObj"></span>
							</div>
							<div class="service-item">
								<span>âœ… <strong>ì¸ì‚¬ê´€ë¦¬ ì„œë¹„ìŠ¤</strong></span>
								<span id="hrObj"></span>
								<span id="hrObjdate"></span>
							</div>
							<div class="service-item">
								<span>âœ… <strong>ì§€ì ê´€ë¦¬ ì„œë¹„ìŠ¤</strong></span>
								<span id="pointObj"></span>
								<span id="pointObjdate"></span>
							</div>
							<div class="service-item">
								<span>âœ… <strong>íšŒê³„ê´€ë¦¬ ì„œë¹„ìŠ¤</strong></span>
								<span id="accountObj"></span>
								<span id="accountObjdate"></span>
							</div>
						</div>
					</div>
				</div>

				<!--
					<div class="card">
						<div class="card-body">
							<h6 class="mb-4">ë‚˜ì˜êµ¬ë…</h6>

							<div id="custom-container">
								<div class="d-flex">
									<div class="p-1 flex-fill">
										<div class="d-flex">
											<div class="p-1 flex-fill bg-primary-subtle">êµ¬ë…í˜•íƒœ</div>
											<div
												class="p-1 flex-fill border border-primary-subtle border-2">
												<span id="subObj"></span>
											</div>
										</div>
									</div>
									<div class="p-1 flex-fill">
										<div class="d-flex">
											<div class="p-1 flex-fill bg-primary-subtle">ë‚¨ì€ê¸°ê°„</div>
											<div
												class="p-1 flex-fill border border-primary-subtle border-2">
												<span id="subObjdate"></span>
											</div>
										</div>
									</div>
									<div class="p-1 flex-fill">
										<div class="d-flex">
											<div class="p-1 flex-fill bg-primary-subtle">ë§Œë£Œì¼</div>
											<div
												class="p-1 flex-fill border border-primary-subtle border-2">
												<span id="subObjdateDay"></span>
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="d-flex justify-content-center"
								style="font-size: 20px;">
								<div class="d-flex flex-column mb-3">
									<div class="p-1 bg-primary-subtle">ë¶€ê°€ì„œë¹„ìŠ¤</div>
									<div
										class="p-1 bg-primary-subtle border border-primary-subtle border-2 border-bottom-0">ë‚¨ì€ê¸°ê°„</div>
									<div
										class="p-1 bg-primary-subtle border border-primary-subtle border-2">ë§Œë£Œì¼</div>
								</div>
								<div class="d-flex flex-column mb-3">
									<div class="p-1 bg-primary-subtle">ê·¸ë£¹ì›¨ì–´</div>
									<div
										class="p-1 border border-primary-subtle border-2 border-bottom-0">
										<span id="gpOption"></span>
									</div>
									<div class="p-1 border border-primary-subtle border-2">
										<span id="groupObj"></span>
									</div>
								</div>
								<div class="d-flex flex-column mb-3">
									<div class="p-1 bg-primary-subtle">ì¸ì‚¬ê´€ë¦¬</div>
									<div
										class="p-1 border border-primary-subtle border-2 border-bottom-0">
										<span id="hrObj"></span>
									</div>
									<div class="p-1 border border-primary-subtle border-2">
										<span id="hrObjdate"></span>
									</div>
								</div>
								<div class="d-flex flex-column mb-3">
									<div class="p-1 bg-primary-subtle">ì§€ì ê´€ë¦¬</div>
									<div
										class="p-1 border border-primary-subtle border-2 border-bottom-0">
										<span id="pointObj"></span>
									</div>
									<div class="p-1 border border-primary-subtle border-2">
										<span id="pointObjdate"></span>
									</div>
								</div>
								<div class="d-flex flex-column mb-3">
									<div class="p-1 bg-primary-subtle">íšŒê³„ê´€ë¦¬</div>
									<div
										class="p-1 border border-primary-subtle border-2 border-bottom-0">
										<span id="accountObj"></span>
									</div>
									<div class="p-1 border border-primary-subtle border-2">
										<span id="accountObjdate"></span>
									</div>
								</div>
							</div>

						</div>
					</div>
					-->
				</div>
				<div class="col-md-12 stretch-card mt-0 mb-2">
				<div class="card">
					<h3 class="card-title">ğŸ“‹ êµ¬ë… ëª©ë¡</h3>
					<div id="sublist"></div>
				</div>
			</div>
		</div>
		
		<!-- í†µí•© ëª¨ë‹¬ -->
		<div id="universalModal" class="modal fade" tabindex="-1" aria-hidden="true">
		    <div class="modal-dialog modal-xl">
		        <div class="modal-content">
		            <div class="modal-header p-3">
		                <h5 id="modalTitle" class="modal-title"></h5>
		                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		            </div>
		            <div class="modal-body">
		                <div class="pdf-container">
		                    <canvas id="pdfCanvas"></canvas>
		                </div>
		            </div>
		            <div class="modal-footer p-2">
                        <button type="button" class="btn btn-secondary" id="pdfDown">PDF</button>
					    <button type="button" class="btn btn-secondary closemodal"  data-bs-dismiss="modal">ë‹«ê¸°</button>
                    </div>
		        </div>
		    </div>
		</div>
		<!-- í†µí•© ëª¨ë‹¬ ë -->
		
	</div>
	<script th:inline="javascript">
		setTimeout(async () => {
			console.log("ì—¬ê¸°ëŠ” ì‚¬ìš©í•˜ëŠ”ê³³:", window.subscriptionState);
			let subObj = document.querySelector("#subObj");
			let subObjdate = document.querySelector("#subObjdate");
			let subObjdateDay = document.querySelector("#subObjdateDay");
			let gpOption = document.querySelector("#gpOption");
			let groupObj = document.querySelector("#groupObj");
			let hrObj = document.querySelector("#hrObj");
			let hrObjdate = document.querySelector("#hrObjdate");
			let pointObj = document.querySelector("#pointObj");
			let pointObjdate = document.querySelector("#pointObjdate");
			let accountObj = document.querySelector("#accountObj");
			let accountObjdate = document.querySelector("#accountObjdate");
			
			//subObj
			if(window.subscriptionState.subObj=="date"){
				subObj.innerHTML = "ğŸ“Œ ê¸°ê°„êµ¬ë…";
			}else{
				subObj.innerHTML = "ğŸ“Œ ì •ê¸°êµ¬ë…";
			}
			//subObjdate //subObjdateDay
			if(window.subscriptionState.subObjdate && window.subscriptionState.subObjdate != 0){
				//ë§Œë£Œ ë‚¨ì€ ê¸°ê°„
				subObjdate.innerHTML = "â³ "+window.subscriptionState.subObjdate+"ì¼ ë‚¨ìŒ";
				//ë§Œë£Œì¼ì
				let today = new Date();
				today.setDate(today.getDate()+window.subscriptionState.subObjdate);
				let result = today.toISOString().split("T")[0];
				subObjdateDay.innerHTML = "ğŸ“… ì¢…ë£Œì¼: "+result;
				groupObj.innerHTML = "ğŸ“… ì¢…ë£Œì¼: "+result;
			}else{
				subObjdate.innerHTML = "â³ ë§Œë£Œ";
				subObjdateDay.innerHTML = "-";
			}
			//gpOption
			if(window.subscriptionState.gpOption=="50"){
				gpOption.innerHTML = "ğŸ‘¥ 50ëª… (ê¸°ë³¸ì„œë¹„ìŠ¤)";
			}else if(window.subscriptionState.gpOption=="100"){
				gpOption.innerHTML = "ğŸ‘¥ 100ëª… (ì„œë¹„ìŠ¤)";
			}else{
				gpOption.innerHTML = "ğŸ‘¥ ë¬´ì œí•œ (ì„œë¹„ìŠ¤)";
			}
			
			//hrObj //hrObjdate
			if(window.subscriptionState.hrObjdate && window.subscriptionState.hrObjdate != 0){
				//ë§Œë£Œ ë‚¨ì€ ê¸°ê°„
				hrObj.innerHTML = "â³ "+window.subscriptionState.hrObjdate+"ì¼ ë‚¨ìŒ";
				//ë§Œë£Œì¼ì
				let today = new Date();
				today.setDate(today.getDate()+window.subscriptionState.hrObjdate);
				let result = today.toISOString().split("T")[0];
				hrObjdate.innerHTML = "ğŸ“… ì¢…ë£Œì¼: "+result;
			}else{
				hrObj.innerHTML = "â³ ë§Œë£Œ";
				hrObjdate.innerHTML = "ğŸ“… ì¢…ë£Œì¼: -";
			}
			
			//pointObj //pointObjdate
			if(window.subscriptionState.pointObjdate && window.subscriptionState.pointObjdate != 0){
				//ë§Œë£Œ ë‚¨ì€ ê¸°ê°„
				pointObj.innerHTML = "â³ "+window.subscriptionState.pointObjdate+"ì¼ ë‚¨ìŒ";
				//ë§Œë£Œì¼ì
				let today = new Date();
				today.setDate(today.getDate()+window.subscriptionState.pointObjdate);
				let result = today.toISOString().split("T")[0];
				pointObjdate.innerHTML = "ğŸ“… ì¢…ë£Œì¼: "+result;
			}else{
				pointObj.innerHTML = "â³ ë§Œë£Œ";
				pointObjdate.innerHTML = "ğŸ“… ì¢…ë£Œì¼: -";
			}
			
			//pointObj //pointObjdate
			if(window.subscriptionState.accountObjdate && window.subscriptionState.accountObjdate != 0){
				//ë§Œë£Œ ë‚¨ì€ ê¸°ê°„
				accountObj.innerHTML = "â³ "+window.subscriptionState.accountObjdate+"ì¼ ë‚¨ìŒ";
				//ë§Œë£Œì¼ì
				let today = new Date();
				today.setDate(today.getDate()+window.subscriptionState.accountObjdate);
				let result = today.toISOString().split("T")[0];
				accountObjdate.innerHTML = "ğŸ“… ì¢…ë£Œì¼: "+result;
			}else{
				accountObj.innerHTML = "â³ ë§Œë£Œ";
				accountObjdate.innerHTML = "ğŸ“… ì¢…ë£Œì¼: -";
			}
		}, 1000);
		
		
		//êµ¬ë…ëª©ë¡ ê·¸ë¦¬ë“œ ì„ ì–¸
		var Grid = tui.Grid;
		
		//ê·¸ë¦¬ë“œ í˜¸ì¶œ í•­ëª© ìƒì„±
		const sublistdataSource = {
				api : {
					readData: { url: '/erp/rest/subscriptionlist', method: 'GET', initParams: { companyNum: [[${session.companyNum}]] }},
				},
				contentType : 'application/json',
				headers: { 'x-custom-header': 'custom-header' },
			};
		//ê·¸ë¦¬ë“œ ìƒì„±
		const sublistgrid = new Grid({
			el : document.getElementById('sublist'), // ì»¨í…Œì´ë„ˆ ì—˜ë¦¬ë¨¼íŠ¸
			scrollX: false,
		    scrollY: false,
		    minBodyHeight: 201,
		    columnOptions: {
		        resizable: true
		    },
			pageOptions : {
				useClient : false, //í˜ì´ì§€ ë„¤ì´ì…˜ í• êº¼ë©´ false // ìë™ìœ¼ë¡œ í•˜ê²Œí• ê»´ë©´ true
				perPage : 5, //í•œí˜ì´ì§€ì— ëª‡ê°œ ë³´ì—¬ì¤„ì§€
			},
			//ì¹¼ëŸ¼ ì •í•˜ê¸°
			columns: [
				{ header: "êµ¬ë…ë²ˆí˜¸", name: "subscriptionNum", editor: 'text', align: "center", width: "100" },
				{ header: "êµ¬ë…ìˆ˜ë‹¨", name: "subscriptionMeanName", editor: 'text', align: "center", width: "100" },
				{ header: "êµ¬ë…í˜•íƒœ", name: "subscriptionFormName", editor: 'text', align: "center", width: "100" },
				{ header: "êµ¬ë…ê¸ˆì•¡", name: "subscriptionAmount", editor: 'text', align: "right",
					formatter: function({ value }) {
						return numberFormat(value)+'ì›';
						//return value.toLocaleString()+'ì›';
				    },
				},
				{ header: "êµ¬ë…ì¼ì‹œ", name: "subscriptionDate", editor: 'text', align: "center", width: "170",
					formatter: function({ value }) {
						return subscriptday(value);
				    },
				},
				{ header: "ê±°ë˜ëª…ì„¸ì„œ", name: "transactionstatement", editor: 'text', align: "center", width: "110",
					formatter: function({ row }) {
				        return `<button class="btn btn-outline-primary btn-sm sub-bill" data-id="${row.subscriptionNum}">ê±°ë˜ëª…ì„¸ì„œ</button>`;
				    },
				},
				{ header: "ì„¸ê¸ˆê³„ì‚°ì„œ", name: "taxinvoice", editor: 'text', align: "center", width: "110",
					formatter: function({ row }) {
						if(row.billForm=="EB01"){
							return `ë°œí–‰ë¶ˆê°€`;
						}else{
							if(row.billNum){
								return `<button class="btn btn-outline-primary btn-sm sub-tax" data-id="${row.subscriptionNum}_1">ê³„ì‚°ì„œë³´ê¸°</button>`;
							}else{
					        	return `<button class="btn btn-outline-primary btn-sm sub-tax" data-id="${row.subscriptionNum}_2">ë°œí–‰í•˜ê¸°</button>`;							
							}							
						}
				    },
				},
				{ header: "ë°œí–‰ì¼ì‹œ", name: "ì„¸ê¸ˆê³„ì‚°ì„œ", editor: 'text', align: "center", width: "170",
					formatter: function({ row }) {
						if(row.issueDate && row.billForm=="EB02"){
							return subscriptday(row.issueDate);
						}else{
							return `ë¯¸ë°œí–‰`;
						}
					},
				},
				{ header: "í˜„ê¸ˆì˜ìˆ˜ì¦", name: "cashreceipt", editor: 'text', align: "center", width: "110",
					formatter: function({ row }) {
						if(row.subscriptionMeanName=="ë¬´í†µì¥" || row.subscriptionMeanName=="ê³„ì¢Œì´ì²´"){
							if(row.billForm=="EB02"){
								return `ë°œí–‰ë¶ˆê°€`;
							}else{
								if(row.billNum){
									return `<button class="btn btn-outline-primary btn-sm sub-cash" data-id="${row.subscriptionNum}_1">ì˜ìˆ˜ì¦ë³´ê¸°</button>`;
								}else{
						        	return `<button class="btn btn-outline-primary btn-sm sub-cash" data-id="${row.subscriptionNum}_2">ë°œí–‰í•˜ê¸°</button>`;							
								}								
							}
						}else{
							return `ë°œí–‰ë¶ˆê°€`;
						}
				    },
				},
				{ header: "ë°œí–‰ì¼ì‹œ", name: "í˜„ê¸ˆì˜ìˆ˜ì¦", editor: 'text', align: "center", width: "170",
					formatter: function({ row }) {
						if(row.issueDate && row.billForm=="EB01"){
							return subscriptday(row.issueDate);
						}else{
							return `ë¯¸ë°œí–‰`;
						}
					},
				},
			],
			//ì´ˆê¸° ë°ì´í„° ë­˜ë¡œ í• ì§€
			data : sublistdataSource,
		});
		
		//í˜„ì¬ ê·¸ë¦¬ë“œì— ê°•ì¡°ëœí–‰ì„ ê¸°ë¡í•  ë³€ìˆ˜
		let selectedRowKey = null;
		//ì•„ë¬´ì…€ í´ë¦­
		sublistgrid.on('click', function (ev) {
			if (ev.rowKey !== null) {
				//í˜„ì¬ ê°•ì¡°ëœ í–‰ í´ë˜ìŠ¤ ì´ˆê¸°í™”
				if (selectedRowKey !== null) {
					sublistgrid.removeRowClassName(selectedRowKey, 'tui-grid-row-highlight');
		        }
				// í´ë¦­í•œ í–‰ì— ê°•ì¡° íš¨ê³¼ ì¶”ê°€
				sublistgrid.addRowClassName(ev.rowKey, 'tui-grid-row-highlight');
				 // í˜„ì¬ ê°•ì¡°ëœ í–‰ì„ ê¸°ë¡
		        selectedRowKey = ev.rowKey;
				
				rowData = sublistgrid.getRow(ev.rowKey);
				console.log(`í´ë¦­í•œ í–‰ ë°ì´í„°:\n${JSON.stringify(rowData, null, 2)}`);
				console.log(rowData.subscriptionNum);
				
				// ì˜µì…˜ì¡°íšŒ ì¿¼ë¦¬ í˜¸ì¶œ(goodsCode)
			    fetch('/erp/rest/subscriptionDetail/' + rowData.subscriptionNum, {
			        method: 'GET',
			        headers: {
			            'Content-Type': 'application/json'
			        }
			    })
			    .then(response => response.json())
			    .then(data => {
			        subDetailgrid.resetData(data);  // ì˜µì…˜ í…Œì´ë¸” ë°ì´í„° ì—…ë°ì´íŠ¸
			        console.log(data);
			    })
			    .catch(error => console.error("ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨:", error));
			}
		});
		
		//ëª…ì„¸ì„œ ì²˜ë¦¬ë¥¼ ìœ„í•œ
		var variactionNum = 0;
		//ëª…ì„¸ì„œë²„íŠ¼ í´ë¦­
		document.getElementById('sublist').addEventListener('click', function(event) {
			//ê±°ë˜ëª…ì„¸ì„œ
		    if (event.target.classList.contains('sub-bill')) {
		       	//ê±°ë˜ëª…ì„¸ì„œ ë°œí–‰
		        const subscriptionNum = event.target.getAttribute('data-id');
		        variactionNum = subscriptionNum;
		        const modalTitle = document.getElementById('modalTitle');
		        const modal = new bootstrap.Modal(document.getElementById('universalModal'));
		     	// (1) PDF ìƒì„± ì—”ë“œí¬ì¸íŠ¸ (Jasper â†’ PDF)
		       	const url = `/erp/report/report?companynum=[[${session.companyNum}]]&subscriptionnum=${subscriptionNum}`;
		       	let modalType = "ê±°ë˜ëª…ì„¸ì„œ";
		       	modalTitle.innerText = modalType;
		        //window.open(url, '_blank');
		       	// (2) PDF.jsë¡œ ìº”ë²„ìŠ¤ ë Œë”ë§
	            renderPDF(url, 1);
	         	// (3) ëª¨ë‹¬ í‘œì‹œ
	         	modal.show();
		    //ì„¸ê¸ˆê³„ì‚°ì„œ    
		    }else if(event.target.classList.contains('sub-tax')){
		    	//ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰
		    	const subscriptionNum = event.target.getAttribute('data-id');
		    	const modalTitle = document.getElementById('modalTitle');
		        const modal1 = new bootstrap.Modal(document.getElementById('universalModal'));
		    	let tax = subscriptionNum.split("_");
		    	
		    	// (1) PDF ìƒì„± ì—”ë“œí¬ì¸íŠ¸ (Jasper â†’ PDF)
		       	const url = `/erp/report/taxinvoice?companynum=[[${session.companyNum}]]&subscriptionnum=${tax[0]}`;
		       	let modalType = "ì„¸ê¸ˆê³„ì‚°ì„œ";
		       	modalTitle.innerText = modalType;
		       	// (2) PDF.jsë¡œ ìº”ë²„ìŠ¤ ë Œë”ë§
	            renderPDF(url, 2);
		    	//ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰
		    	variactionNum = tax[0];
		    	if(tax[1] == 2){
		    		//ê·¸ëƒ¥ DBì— ë°ì´í„°ë§Œ ì €ì¥í•˜ëŠ”ê±°ì„
		    		//api ì—†ì–´ì„œ ê·¸ëƒ¥ ì œìŠ¤í¼ ë¬¸ì„œ í•˜ëŠ”ê±¸ ë³´ì—¬ì£¼ëŠ”ê²ƒë¿ì„
		    		const requestData = {
		    				subscriptionNum: tax[0],
		    				employeeNum: [[${session.employeeNum}]],
		    				billForm: "EB02",
		    				pdfAddress: "ì¤€ë¹„ì¤‘",
		    				issueCompany: "EI01",
		    				companyCode: [[${session.companyEngName}]],
		    				companyNum: [[${session.companyNum}]],
					};	
		    		const url = `/erp/rest/taxbillpublishing`;
		    		//íŒ¨ì¹˜ ì‹œì‘
					fetch(url, {
						method:"post",
						headers: {
						      "Content-Type": "application/json",
						      //'X-CSRF-TOKEN': document.querySelector('#csrfToken').value,
						    },
						body : JSON.stringify(requestData),
					})
					.then( result => result.text() )
					.then( result => {
						if(result==="OK"){
							modal1.show();
							sublistgrid.reloadData();
						    setTimeout(() => {
						        let allRows = sublistgrid.getData();
						        let targetRowKey = allRows.findIndex(row => row.subscriptionNum == tax[0]); 
						        
						        if (targetRowKey !== -1) {
						            sublistgrid.addRowClassName(targetRowKey, 'tui-grid-row-highlight');
						            sublistgrid.focus(targetRowKey, 'subscriptionNum');  // ì´ˆì  ì´ë™
						        }
						    }, 500);
						}else{
							showAlert("ê³„ì‚°ì„œ ì €ì¥ì— ì‹¤íŒ¨ í–ˆìŠµë‹ˆë‹¤", 'danger');
						}
					})
				//ê¸°ì¡´ì— ìˆëŠ”ê±° ë³´ì—¬ì¤Œ	
		    	}else if(tax[1] == 1){
		    		//ì•„ë¬´ í–‰ìœ„ë„ ì¼ì–´ë‚˜ì§€ ì•ŠìŒ
		    	}
		    	modal1.show();
		    //í˜„ê¸ˆ ì˜ìˆ˜ì¦	
		    }else if(event.target.classList.contains('sub-cash')){
		    	//í˜„ê¸ˆì˜ìˆ˜ì¦ ë°œí–‰
		    	const subscriptionNum = event.target.getAttribute('data-id');
		    	const modalTitle = document.getElementById('modalTitle');
		    	const modal2 = new bootstrap.Modal(document.getElementById('universalModal'));
		    	let cash = subscriptionNum.split("_");
		    	
		    	// (1) PDF ìƒì„± ì—”ë“œí¬ì¸íŠ¸ (Jasper â†’ PDF)
		       	const url = `/erp/report/cashinvoice?companynum=[[${session.companyNum}]]&subscriptionnum=${cash[0]}`;
		       	console.log(url);
		       	let modalType = "í˜„ê¸ˆì˜ìˆ˜ì¦";
		       	modalTitle.innerText = modalType;
		     	// (2) PDF.jsë¡œ ìº”ë²„ìŠ¤ ë Œë”ë§
	            renderPDF(url, 3);
		       	
		      	//í˜„ê¸ˆì˜ìˆ˜ì¦ ë°œí–‰
		       	variactionNum = cash[0];
		    	if(cash[1] == 2){
					//ì˜ìˆ˜ì¦ ë°œí–‰ ê°ì²´ ìƒì„±
		    		const requestData = {
		    				subscriptionNum: cash[0],
		    				employeeNum: [[${session.employeeNum}]],
		    				billForm: "EB01",
		    				pdfAddress: "ì¤€ë¹„ì¤‘",
		    				issueCompany: "EI01",
		    				companyCode: [[${session.companyEngName}]],
		    				companyNum: [[${session.companyNum}]],
					};
		    		const url = `/erp/rest/taxbillpublishing`;
		    		//íŒ¨ì¹˜ ì‹œì‘
					fetch(url, {
						method:"post",
						headers: {
						      "Content-Type": "application/json",
						    },
						body : JSON.stringify(requestData),
					})
					.then( result => result.text() )
					.then( result => {
						if(result==="OK"){
							modal2.show();
							sublistgrid.reloadData();
						    setTimeout(() => {
						        let allRows = sublistgrid.getData();
						        let targetRowKey = allRows.findIndex(row => row.subscriptionNum == tax[0]); 
						        if (targetRowKey !== -1) {
						            sublistgrid.addRowClassName(targetRowKey, 'tui-grid-row-highlight');
						            sublistgrid.focus(targetRowKey, 'subscriptionNum');  // ì´ˆì  ì´ë™
						        }
						    }, 500);
						}else{
							showAlert("í˜„ê¸ˆì˜ìˆ˜ì¦ ì €ì¥ì— ì‹¤íŒ¨ í–ˆìŠµë‹ˆë‹¤", 'danger');
						}
					})
		    	}else if(cash[1] == 1){
		    		//ì•„ë¬´ í–‰ìœ„ë„ ì¼ì–´ë‚˜ì§€ ì•ŠìŒ
		    	}
		    	modal2.show();
		    }
		});
		
		//êµ¬ë… ìƒì„¸ ê·¸ë¦¬ë“œ
		const subDetailgrid = new Grid({
			el : document.getElementById('subDetailgrid'), // ì»¨í…Œì´ë„ˆ ì—˜ë¦¬ë¨¼íŠ¸
			scrollX: false,
		    scrollY: false,
		    minBodyHeight: 201,
		    columnOptions: {
		        resizable: true
		    },
			//ì¹¼ëŸ¼ ì •í•˜ê¸°
			columns: [
				{ header: "êµ¬ë…ìƒí’ˆëª…", name: "subscriptionName", },
				{ header: "êµ¬ë…ì˜µì…˜ëª…", name: "subscriptionOption", },
				{ header: "êµ¬ë…ê¸°ê°„", name: "subscriptionPeriod", align: "center", width:"100",
					formatter: function({ value }) {
						return value + 'ì¼';
				    },
				},
				{ header: "ê¸ˆì•¡", name: "subscriptionOptionPrice", align: "right", width:"120",
					formatter: function({ value }) {
						return Number(value).toLocaleString() + 'ì›';
				    },
				},
			],
			//ì´ˆê¸° ë°ì´í„° ë­˜ë¡œ í• ì§€
			data : "",
		});
		
		// (1) PDF.jsë¡œ PDF íŒŒì¼ì„ ìº”ë²„ìŠ¤ì— ë Œë”ë§
		function renderPDF(reportUrl, categori) {
		  const canvas = document.getElementById("pdfCanvas");
		  const context = canvas.getContext('2d');
		  const pdfContainer = document.querySelector('.pdf-container');
		  // PDF ë¡œë“œ
		  pdfjsLib.getDocument(reportUrl).promise.then(pdf => {
		    console.log('PDF loaded, total pages:', pdf.numPages);
		    // ì²« í˜ì´ì§€ë§Œ ë Œë”ë§ (í•„ìš”ì‹œ ì—¬ëŸ¬ í˜ì´ì§€ ì§€ì› ê°€ëŠ¥)
		    pdf.getPage(1).then(page => {
		      const scale = 1.5; // í™•ëŒ€/ì¶•ì†Œ ë¹„ìœ¨
		      const viewport = page.getViewport({ scale });
		      // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
		      canvas.width = viewport.width;
		      canvas.height = viewport.height;
		      // í˜ì´ì§€ ë Œë”ë§
		      const renderContext = {
		        canvasContext: context,
		        viewport: viewport
		      };
		      page.render(renderContext).promise.then(() => {
		        console.log('Page rendered');
		      });
		      if(categori==2){
	              setTimeout(() => {
	                  pdfContainer.scrollTop = 75;
	              }, 300);		    	  
		      }else if(categori==1 || categori==2){
		    	  setTimeout(() => {
	                  pdfContainer.scrollTop = 25;
	              }, 300);	
		      }
		    });
		  }).catch(error => {
		    console.error('PDF ë¡œë“œ ì˜¤ë¥˜:', error);
		  });
		}
		
		//pdfë‹¤ìš´
		document.getElementById('pdfDown').addEventListener('click', function () {
			const modalTitle = document.getElementById('modalTitle').innerHTML;
			let billtype = 0;
			if(modalTitle=="ê±°ë˜ëª…ì„¸ì„œ"){
				billtype = 1;
			}else if(modalTitle=="ì„¸ê¸ˆê³„ì‚°ì„œ"){
				billtype = 2;
			}else{
				billtype = 3;
			}
			// ë‹¤ìš´ë¡œë“œ ì—”ë“œí¬ì¸íŠ¸ URL ìƒì„±
			const url = `/erp/report/taxinvoicedown?companynum=[[${session.companyNum}]]&subscriptionnum=${variactionNum}&billtype=${billtype}`;	
		    // ë¸Œë¼ìš°ì €ë¥¼ í•´ë‹¹ URLë¡œ ì´ë™ì‹œì¼œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
		    window.location.href = url;
		});
		
		// ëª¨ë‹¬ ë‹«ê¸°
		document.addEventListener("DOMContentLoaded", function () {
		    const modalElement = document.getElementById("universalModal"); // í†µí•© ëª¨ë‹¬ ID
		    if (!modalElement) {
		        console.warn("âŒ ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
		        return;
		    }
		    const closeButton =  document.querySelector(".closemodal");
		    if (closeButton) {
		        closeButton.addEventListener("click", function () {
		            console.log("âœ… ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ í´ë¦­ë¨!");
		            try {
		                let modalInstance = bootstrap.Modal.getInstance(modalElement);
		                
		                if (!modalInstance) {
		                    modalInstance = new bootstrap.Modal(modalElement);
		                }
		                modalInstance.hide(); // âœ… Bootstrap ë°©ì‹ìœ¼ë¡œ ëª¨ë‹¬ ë‹«ê¸°
		                setTimeout(() => {
		                    modalElement.classList.remove("show");
		                    modalElement.style.display = "none";
		                    document.body.classList.remove("modal-open");
		                    // ğŸ”¥ ë°±ê·¸ë¼ìš´ë“œ ì œê±°
		                    document.querySelectorAll(".modal-backdrop").forEach((element) => element.remove());
		                }, 300);
		            } catch (error) {
		                console.warn("âŒ Bootstrap 5ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŒ. ëŒ€ì²´ ë°©ì‹ ì‚¬ìš©");
		                modalElement.classList.remove("show");
		                modalElement.style.display = "none";
		                document.body.classList.remove("modal-open");
		                setTimeout(() => {
		                    document.querySelectorAll(".modal-backdrop").forEach((element) => element.remove()); // ë°±ê·¸ë¼ìš´ë“œ ì œê±°
		                }, 300);
		            }
		        });
		    } else {
		        console.warn("âŒ ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
		    }
		});
		// ëª¨ë‹¬ ë‹«ê¸° ë
	</script>
</body>