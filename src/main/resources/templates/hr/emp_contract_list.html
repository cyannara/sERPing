<!DOCTYPE html>
<html layout:decorate="~{layouts/layout}" lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>ê·¼ë¡œê³„ì•½ ê´€ë¦¬</title>
    
    <!-- TOAST UI -->
    <link rel="stylesheet" href="https://uicdn.toast.com/tui.grid/latest/tui-grid.css">
    <script src="https://uicdn.toast.com/tui.grid/latest/tui-grid.js"></script>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body layout:fragment="content">

<div class="container mt-3">
    <h2 class="mb-4">ê·¼ë¡œê³„ì•½ ê´€ë¦¬</h2>

    <div class="row">
        <!-- ì™¼ìª½: ê·¼ë¡œ ê³„ì•½ ë“±ë¡ -->
        <div class="col-md-6">
            <h4>ğŸ“¥ ê·¼ë¡œ ê³„ì•½ ë“±ë¡</h4>
            <form id="contractForm">
                <!-- ì‚¬ì› ì„ íƒ -->
                <div class="mb-3">
                    <label class="form-label">ì‚¬ì› ë²ˆí˜¸</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="employeeNum" required readonly>
                        <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#employeeSelectModal">ì‚¬ì› ì„ íƒ</button>
                    </div>
                </div>

                <!-- ê³„ì•½ ì •ë³´ ì…ë ¥ -->
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">ê³„ì•½ ìœ í˜•</label>
                        <select class="form-select" id="contractType">
                            <option value="CT001">ì •ê·œì§</option>
                            <option value="CT002">ê³„ì•½ì§</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">ê³„ì•½ ì‹œì‘ì¼</label>
                        <input type="date" class="form-control" id="contractStartDate" required>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="form-label">ê³„ì•½ ì¢…ë£Œì¼</label>
                        <input type="date" class="form-control" id="contractEndDate">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">ê¸‰ì—¬</label>
                        <input type="number" class="form-control" id="salary" required min="1000000">
                    </div>
                </div>

                <button type="button" class="btn btn-primary mt-3" onclick="submitContract()">ë“±ë¡</button>
            </form>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ê·¼ë¡œ ê³„ì•½ ì¡°íšŒ -->
        <div class="col-md-6">
            <h4>ğŸ“‘ ê·¼ë¡œ ê³„ì•½ ì¡°íšŒ</h4>
            <div class="mb-3">
                <input type="text" class="form-control" id="searchKeyword" placeholder="ì‚¬ì›ëª… ê²€ìƒ‰">
                <button class="btn btn-primary mt-2" onclick="loadContracts()">ê²€ìƒ‰</button>
            </div>
            <div id="contractGrid"></div>
        </div>
    </div>
</div>

<!-- ì‚¬ì› ì„ íƒ ëª¨ë‹¬ -->
<div class="modal fade" id="employeeSelectModal" tabindex="-1" aria-labelledby="employeeSelectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì‚¬ì› ì„ íƒ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="employeeGrid"></div>
            </div>
        </div>
    </div>
</div>

<script>
// âœ… ì‚¬ì› ì„ íƒ ê¸°ëŠ¥
document.addEventListener("DOMContentLoaded", function () {
    const employeeGrid = new tui.Grid({
        el: document.getElementById('employeeGrid'),
        columns: [
            { header: "ì‚¬ì›ë²ˆí˜¸", name: "employeeNum" },
            { header: "ì´ë¦„", name: "employeeName" },
            { header: "ë¶€ì„œ", name: "departmentName" },
            { header: "ì„ íƒ", name: "select", formatter: () => '<button class="btn btn-success btn-sm selectEmployee">ì„ íƒ</button>' }
        ]
    });

    window.loadEmployees = function () {
        fetch("/hr/rest/emp/list")
            .then(response => response.json())
            .then(data => employeeGrid.resetData(data))
            .catch(error => alert("ì‚¬ì› ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨"));
    };

    document.getElementById("employeeGrid").addEventListener("click", function (event) {
        if (event.target.classList.contains("selectEmployee")) {
            const row = employeeGrid.getRow(event.target.closest("tr").rowIndex);
            document.getElementById("employeeNum").value = row.employeeNum;
            document.getElementById("employeeSelectModal").querySelector(".btn-close").click();
        }
    });
});

// âœ… ê³„ì•½ ë“±ë¡
function submitContract() {
    const contractData = {
        employeeNum: document.getElementById("employeeNum").value,
        contractType: document.getElementById("contractType").value,
        contractStartDate: document.getElementById("contractStartDate").value,
        contractEndDate: document.getElementById("contractEndDate").value,
        salary: document.getElementById("salary").value
    };

    fetch("/contract/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(contractData)
    })
    .then(response => response.text())
    .then(() => {
        alert("ê³„ì•½ ë“±ë¡ ì„±ê³µ");
        loadContracts(); // ë“±ë¡ í›„ ëª©ë¡ ê°±ì‹ 
    })
    .catch(() => alert("ë“±ë¡ ì‹¤íŒ¨"));
}

// âœ… ê³„ì•½ ëª©ë¡ ì¡°íšŒ
function loadContracts() {
    fetch("/contract/list")
        .then(response => response.json())
        .then(data => contractGrid.resetData(data))
        .catch(() => alert("ê³„ì•½ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨"));
}

// âœ… ê³„ì•½ ëª©ë¡ ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
const contractGrid = new tui.Grid({
    el: document.getElementById('contractGrid'),
    columns: [
        { header: "ì‚¬ì›ë²ˆí˜¸", name: "employeeNum" },
        { header: "ê³„ì•½ ìœ í˜•", name: "contractType" },
        { header: "ê³„ì•½ ì‹œì‘ì¼", name: "contractStartDate" },
        { header: "ê¸‰ì—¬", name: "salary" }
    ]
});
</script>

</body>
</html>
