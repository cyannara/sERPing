<!DOCTYPE html>
<html layout:decorate="~{layouts/layout}" lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="UTF-8">
<title>ê·¼ë¡œê³„ì•½ê´€ë¦¬</title>
  <link rel="stylesheet" href="https://uicdn.toast.com/tui.grid/latest/tui-grid.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://uicdn.toast.com/tui.grid/latest/tui-grid.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body layout:fragment="content">

<div class="container mt-3">
    <h2 class="mb-4">ê·¼ë¡œ ê³„ì•½ì„œ ë“±ë¡</h2>

    <form id="contractForm">
        <!-- âœ… ì‚¬ì› ì„ íƒ -->
        <div class="row">
            <div class="col-md-6">
                <label class="form-label">ì‚¬ì› ë²ˆí˜¸</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="employeeNum" required readonly>
                    <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#employeeSelectModal">ì‚¬ì› ì„ íƒ</button>
                </div>
            </div>
            <div class="col-md-6">
                <label class="form-label">ì‚¬ì›ëª…</label>
                <input type="text" class="form-control" id="employeeName" readonly>
            </div>
        </div>

        <!-- âœ… ê³„ì•½ ì •ë³´ -->
        <div class="row mt-3">
            <div class="col-md-6">
                <label class="form-label">ê³„ì•½ ì‹œì‘ì¼</label>
                <input type="date" class="form-control" id="contractStartDate" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">ê³„ì•½ ì¢…ë£Œì¼ (ë¬´ê¸°ê³„ì•½ì´ë©´ ë¹„ì›Œë‘ì„¸ìš”)</label>
                <input type="date" class="form-control" id="contractEndDate">
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <label class="form-label">ë¶€ì„œ ë²ˆí˜¸</label>
                <input type="number" class="form-control" id="departmentNum" required readonly>
            </div>
            <div class="col-md-6">
                <label class="form-label">ì§ê¸‰</label>
                <input type="text" class="form-control" id="position" readonly>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <label class="form-label">ê·¼ë¬´ ì‹œì‘ ì‹œê°„</label>
                <input type="time" class="form-control" id="workStartTime" value="09:00">
            </div>
            <div class="col-md-6">
                <label class="form-label">ê·¼ë¬´ ì¢…ë£Œ ì‹œê°„</label>
                <input type="time" class="form-control" id="workEndTime" value="18:00">
            </div>
        </div>

        <!-- âœ… ê³„ì•½ ìœ í˜• (ì˜¤ë¥¸ìª½ ì •ë ¬) -->
        <div class="row mt-3">
            <div class="col-md-6">
                <label class="form-label">ê¸°ë³¸ ê¸‰ì—¬</label>
                <input type="number" class="form-control" id="salary" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">ê³„ì•½ ìœ í˜•</label>
                <select class="form-select" id="contractType">
                    <option value="CT001">ì •ê·œì§</option>
                    <option value="CT002">ê³„ì•½ì§</option>
                </select>
            </div>
        </div>

        <button type="button" class="btn btn-primary mt-3" onclick="submitContract()">ë“±ë¡</button>
    </form>
</div>

<!-- âœ… ì‚¬ì› ì„ íƒ ëª¨ë‹¬ -->
<div class="modal fade" id="employeeSelectModal" tabindex="-1" aria-labelledby="employeeSelectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì‚¬ì› ì„ íƒ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- ğŸ” ê²€ìƒ‰ í•„í„° -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="searchKeyword" placeholder="ì‚¬ì›ëª… ê²€ìƒ‰">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary" onclick="loadEmployees()">ê²€ìƒ‰</button>
                    </div>
                </div>

                <!-- ğŸ”½ ì‚¬ì› ë¦¬ìŠ¤íŠ¸ (Toast Grid) -->
                <div id="employeeGrid"></div>
            </div>
        </div>
    </div>
</div>

<script>
// âœ… ê³„ì•½ ë“±ë¡ ìš”ì²­
function submitContract() {
    const contractData = {
        employeeNum: document.getElementById("employeeNum").value,
        employeeName: document.getElementById("employeeName").value,
        contractType: document.getElementById("contractType").value,
        contractStartDate: document.getElementById("contractStartDate").value,
        contractEndDate: document.getElementById("contractEndDate").value,
        departmentNum: document.getElementById("departmentNum").value,
        position: document.getElementById("position").value,
        workStartTime: document.getElementById("workStartTime").value,
        workEndTime: document.getElementById("workEndTime").value,
        salary: document.getElementById("salary").value
    };

    fetch("/contract/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(contractData)
    })
    .then(response => response.json())
    .then(() => alert("ê³„ì•½ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."))
    .catch(() => alert("ë“±ë¡ ì‹¤íŒ¨"));
}

//âœ… ì‚¬ì› ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ë°ì´í„° êµ¬ì¡° ë°˜ì˜)
function loadEmployees() {
    fetch("/hr/rest/emp/list")
        .then(response => response.json())
        .then(data => {
            if (data.result && data.data && data.data.contents) {
                console.log("ğŸ“Š ì‚¬ì› ëª©ë¡ ë°ì´í„°:", data.data.contents); // âœ… ì½˜ì†”ë¡œ ë°ì´í„° í™•ì¸
                grid.resetData(data.contents); // âœ… Toast Gridì— ë°ì´í„° ë„£ê¸°
            } else {
                alert("ì‚¬ì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        })
        .catch(() => alert("ì‚¬ì› ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨"));
}


// âœ… Toast Grid ì„¤ì • (ì‚¬ì› ëª©ë¡)
const grid = new tui.Grid({
    el: document.getElementById('employeeGrid'),
    columns: [
        { header: "ì‚¬ì›ë²ˆí˜¸", name: "employeeNum" },
        { header: "ì´ë¦„", name: "employeeName" },
        { header: "ë¶€ì„œëª…", name: "departmentName" }, 
        { header: "ë¶€ì„œë²ˆí˜¸", name: "departmentNum" }, 
        { header: "ì§ê¸‰", name: "position" },
        { header: "ì„ íƒ", name: "select", formatter: () => '<button class="btn btn-success btn-sm selectEmployee">ì„ íƒ</button>' }
    ]
});

// âœ… ì‚¬ì› ì„ íƒ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
document.getElementById("employeeGrid").addEventListener("click", function (event) {
    if (event.target.classList.contains("selectEmployee")) {
        const rowKey = event.target.closest("tr").dataset.rowKey; // âœ… rowKey ê°€ì ¸ì˜¤ê¸°
        const rowData = grid.getRow(rowKey); // âœ… rowKeyë¡œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°

        document.getElementById("employeeNum").value = rowData.employeeNum;
        document.getElementById("employeeName").value = rowData.employeeName;
        document.getElementById("departmentNum").value = rowData.departmentNum;
        document.getElementById("position").value = rowData.position;

        // âœ… ëª¨ë‹¬ ë‹«ê¸°
        $('#employeeSelectModal').modal('hide');
    }
});

</script>

</body>
</html>
