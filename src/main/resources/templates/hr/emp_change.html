<!DOCTYPE html>
<html layout:decorate="~{layouts/layout}" lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="UTF-8">

    <!-- TOAST UI Library -->
    <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
    <script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <title>ì¸ì‚¬ ë°œë ¹ ê´€ë¦¬</title>
</head>

<body layout:fragment="content">
<div class="container mt-3">
    <h2>ì¸ì‚¬ ë°œë ¹ ê´€ë¦¬</h2>

    <!-- ğŸ” ê²€ìƒ‰ í•„í„° -->
    <div class="search-box bg-light p-3 rounded shadow-sm">
        <div class="row align-items-center">
            <div class="col-md-2 text-end"><label class="fw-bold">ê²€ìƒ‰ ê¸°ì¤€</label></div>
            <div class="col-md-3">
                <select class="form-select" id="searchCategory">
                    <option value="ì „ì²´">ì „ì²´</option>
                    <option value="employeeName">ì‚¬ì›ëª…</option>
                    <option value="employeeId">ì‚¬ì›ID</option>
                    <option value="phone">ì—°ë½ì²˜</option>
                </select>
            </div>
            <div class="col-md-5">
                <input type="text" class="form-control" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ í›„ [Enter]" id="searchKeyword">
            </div>
        </div>

        <div class="row mt-2">
            <div class="col text-center">
                <button class="btn btn-primary" id="searchBtn">ì¡°íšŒ</button>
                <button class="btn btn-outline-success" id="resetBtn">ì´ˆê¸°í™”</button>
            </div>
        </div>
    </div>

    <!-- ğŸ”˜ ì¸ì‚¬ ë°œë ¹ ë“±ë¡ ë²„íŠ¼ -->
    <div class="row mt-3">
        <div class="col text-end">
            <button class="btn btn-warning" id="registerHistoryBtn">+ ì¸ì‚¬ ë°œë ¹ ë“±ë¡</button>
        </div>
    </div>

    <!-- ğŸ”² TOAST UI GRID -->
    <div class="row mt-3">
        <div class="col">
            <div id="grid"></div>
        </div>
    </div>

</div>

<!-- ğŸ“Œ JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    let historyGrid;

    // âœ… TUI Grid ì´ˆê¸°í™”
    function initializeGrid() {
        historyGrid = new tui.Grid({
            el: document.getElementById('grid'),
            columns: [
                { header: "ì´ë ¥ ë²ˆí˜¸", name: "historyNum", width: 80 },
                { header: "ëŒ€ìƒ ì‚¬ì›", name: "employeeNum", width: 100 },
                { header: "ë³€ê²½ ìœ í˜•", name: "changeType", width: 120 },
                { header: "ê¸°ì¡´ ì§ê¸‰", name: "previousPosition", width: 120 },
                { header: "ìƒˆ ì§ê¸‰", name: "newPosition", width: 120 },
                { header: "ê¸°ì¡´ ë¶€ì„œ", name: "previousDepartmentNum", width: 120 },
                { header: "ìƒˆ ë¶€ì„œ", name: "newDepartmentNum", width: 120 },
                { header: "ì ìš©ì¼", name: "effectiveDate", width: 120 },
                { header: "ìŠ¹ì¸ ìƒíƒœ", name: "approvalStatus", width: 100 },
                { header: "ë°œë ¹ ì²˜ë¦¬ì", name: "processedBy", width: 100 },
                {
                    header: "ìŠ¹ì¸",
                    name: "approve",
                    width: 80,
                    formatter: ({ row }) =>
                        `<button class="approve-btn btn btn-success btn-sm" data-id="${row.historyNum}">âœ…</button>`
                },
                {
                    header: "ë°˜ë ¤",
                    name: "reject",
                    width: 80,
                    formatter: ({ row }) =>
                        `<button class="reject-btn btn btn-danger btn-sm" data-id="${row.historyNum}">âŒ</button>`
                }
            ]
        });

        fetchHistoryList();
    }

    // âœ… ì¸ì‚¬ë°œë ¹ ëª©ë¡ ì¡°íšŒ
    function fetchHistoryList() {
        fetch('/hr/rest/history/list')
            .then(response => response.json())
            .then(data => {
                console.log("ğŸ“Œ ì¸ì‚¬ë°œë ¹ ë°ì´í„°:", data);
                historyGrid.resetData(data.historyList);
            })
            .catch(error => console.error("âŒ ì¸ì‚¬ë°œë ¹ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:", error));
    }

    // âœ… ì¸ì‚¬ë°œë ¹ ìŠ¹ì¸
    function approveHistory(historyNum) {
        fetch(`/hr/rest/history/approve/${historyNum}`, { method: "PUT" })
        .then(response => response.text())
        .then(message => {
            alert(message);
            fetchHistoryList();
        })
        .catch(error => console.error("âŒ ìŠ¹ì¸ ì‹¤íŒ¨:", error));
    }

    // âœ… ì¸ì‚¬ë°œë ¹ ë°˜ë ¤
    function rejectHistory(historyNum) {
        const reason = prompt("ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if (!reason) return;

        fetch(`/hr/rest/history/reject/${historyNum}?rejectReason=${encodeURIComponent(reason)}`, { method: "PUT" })
        .then(response => response.text())
        .then(message => {
            alert(message);
            fetchHistoryList();
        })
        .catch(error => console.error("âŒ ë°˜ë ¤ ì‹¤íŒ¨:", error));
    }

    // âœ… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ìŠ¹ì¸ / ë°˜ë ¤)
    document.addEventListener("click", function (event) {
        if (event.target.classList.contains("approve-btn")) {
            approveHistory(event.target.dataset.id);
        } else if (event.target.classList.contains("reject-btn")) {
            rejectHistory(event.target.dataset.id);
        }
    });

    // âœ… ê²€ìƒ‰ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById("searchBtn").addEventListener("click", function () {
        fetchHistoryList();
    });

    // âœ… ì¸ì‚¬ë°œë ¹ ë“±ë¡ ë²„íŠ¼
    document.getElementById("registerHistoryBtn").addEventListener("click", function () {
        alert("ğŸ“Œ ì¸ì‚¬ë°œë ¹ ë“±ë¡ ê¸°ëŠ¥ ì¶”ê°€ ì˜ˆì •!");
    });

    initializeGrid();
});
</script>

</body>
</html>
